

=== ./configuracion/serializer.py ===
# ./configuracion/serializer.py

from rest_framework import serializers
from .models import Modulo, Menu, EmpresaModulo, EmpresaModuloMenu

class ModuloSerializer(serializers.ModelSerializer):
    class Meta:
        model = Modulo
        fields = '__all__'  # O define una lista de campos específica

class MenuSerializer(serializers.ModelSerializer):
    class Meta:
        model = Menu
        fields = '__all__'

class EmpresaModuloSerializer(serializers.ModelSerializer):
    class Meta:
        model = EmpresaModulo
        fields = '__all__'

class EmpresaModuloMenuSerializer(serializers.ModelSerializer):
    class Meta:
        model = EmpresaModuloMenu
        fields = '__all__'


=== ./configuracion/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./configuracion/urls.py ===
# ./configuracion/urls.py
from django.urls import path, include
from rest_framework.documentation import include_docs_urls
from rest_framework import routers
from .views import (
    ModuloViewSet,
    MenuViewSet,
    EmpresaModuloViewSet,
    EmpresaModuloMenuViewSet
)

router = routers.DefaultRouter()
router.register(r'modulos', ModuloViewSet, basename='modulos')
router.register(r'menus', MenuViewSet, basename='menus')
router.register(r'empresa-modulos', EmpresaModuloViewSet, basename='empresa-modulos')
router.register(r'empresa-modulos-menus', EmpresaModuloMenuViewSet, basename='empresa-modulos-menus')

urlpatterns = [
    path('', include(router.urls)),
    path('docs/', include_docs_urls(title='Configuración API')),
]


=== ./configuracion/__init__.py ===


=== ./configuracion/migrations/__init__.py ===


=== ./configuracion/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-28 13:01

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('coreempresas', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Menu',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('url', models.CharField(max_length=50)),
                ('texto', models.CharField(default='', max_length=50)),
                ('etiqueta', models.CharField(blank=True, max_length=50, null=True)),
                ('descripcion', models.CharField(max_length=255)),
                ('nivel_menu', models.IntegerField(default=3)),
                ('orden', models.IntegerField(blank=True, null=True)),
                ('modificable', models.CharField(default='SI', max_length=2)),
                ('separador_up', models.IntegerField(default=0)),
            ],
            options={
                'db_table': '"dm_sistema"."menus"',
            },
        ),
        migrations.CreateModel(
            name='Modulo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('modulo', models.CharField(max_length=50)),
                ('nombre', models.CharField(max_length=255)),
                ('nombre_menu', models.CharField(blank=True, max_length=100, null=True)),
                ('estado', models.SmallIntegerField(blank=True, null=True)),
                ('icon', models.CharField(blank=True, max_length=255, null=True)),
                ('orden', models.IntegerField(blank=True, null=True)),
            ],
            options={
                'db_table': '"dm_sistema"."modulos"',
            },
        ),
        migrations.CreateModel(
            name='EmpresaModulo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('estado', models.IntegerField(default=1)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos', to='coreempresas.empresa')),
                ('modulo', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos', to='configuracion.modulo')),
            ],
            options={
                'db_table': '"dm_sistema"."empresa_modulos"',
            },
        ),
        migrations.CreateModel(
            name='EmpresaModuloMenu',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('empresa_modulo', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='menus', to='configuracion.empresamodulo')),
                ('menu', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos_menus', to='configuracion.menu')),
            ],
            options={
                'db_table': '"dm_sistema"."empresa_modulos_menu"',
            },
        ),
        migrations.AddField(
            model_name='menu',
            name='modulo',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='menus', to='configuracion.modulo'),
        ),
    ]


=== ./configuracion/migrations/0002_remove_empresamodulo_empresa_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 13:34

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('configuracion', '0001_initial'),
        ('coreempresas', '0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='empresamodulo',
            name='empresa',
        ),
        migrations.RemoveField(
            model_name='empresamodulo',
            name='modulo',
        ),
        migrations.RemoveField(
            model_name='empresamodulomenu',
            name='empresa_modulo',
        ),
        migrations.RemoveField(
            model_name='empresamodulomenu',
            name='menu',
        ),
        migrations.RemoveField(
            model_name='menu',
            name='modulo',
        ),
        migrations.AddField(
            model_name='empresamodulo',
            name='id_empresa',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos', to='coreempresas.empresa'),
        ),
        migrations.AddField(
            model_name='empresamodulo',
            name='id_modulo',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos', to='configuracion.modulo'),
        ),
        migrations.AddField(
            model_name='empresamodulomenu',
            name='id_empresa_modulo',
            field=models.ForeignKey(default=1, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos_menus', to='configuracion.empresamodulo'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='empresamodulomenu',
            name='id_menu',
            field=models.ForeignKey(default=1, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos_menus', to='configuracion.menu'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='menu',
            name='id_modulo',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='menus', to='configuracion.modulo'),
        ),
        migrations.AlterField(
            model_name='empresamodulo',
            name='id',
            field=models.AutoField(db_column='id_empresa_modulo', primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name='empresamodulomenu',
            name='id',
            field=models.AutoField(db_column='id_empresa_modulo_menu', primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name='menu',
            name='id',
            field=models.AutoField(db_column='id_menu', primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name='modulo',
            name='id',
            field=models.AutoField(db_column='id_modulo', primary_key=True, serialize=False),
        ),
        migrations.AddIndex(
            model_name='empresamodulo',
            index=models.Index(fields=['id_empresa'], name='idx_empresa_emm'),
        ),
        migrations.AddIndex(
            model_name='empresamodulo',
            index=models.Index(fields=['id_modulo'], name='idx_mod_emm'),
        ),
        migrations.AddIndex(
            model_name='empresamodulomenu',
            index=models.Index(fields=['id_empresa_modulo'], name='idx_emp_mod_menu'),
        ),
        migrations.AddIndex(
            model_name='empresamodulomenu',
            index=models.Index(fields=['id_menu'], name='idx_menu_emm'),
        ),
        migrations.AddIndex(
            model_name='menu',
            index=models.Index(fields=['id_modulo'], name='idx_modulo_menu'),
        ),
    ]


=== ./configuracion/migrations/0004_alter_empresamodulomenu_id_empresa_modulo_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('configuracion', '0003_alter_empresamodulo_id_empresa_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='empresamodulomenu',
            name='id_empresa_modulo',
            field=models.ForeignKey(db_column='id_empresa_modulo', on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos_menus', to='configuracion.empresamodulo'),
        ),
        migrations.AlterField(
            model_name='empresamodulomenu',
            name='id_menu',
            field=models.ForeignKey(db_column='id_menu', on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos_menus', to='configuracion.menu'),
        ),
        migrations.AlterField(
            model_name='menu',
            name='id_modulo',
            field=models.ForeignKey(blank=True, db_column='id_modulo', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='menus', to='configuracion.modulo'),
        ),
    ]


=== ./configuracion/migrations/0003_alter_empresamodulo_id_empresa_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:41

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('configuracion', '0002_remove_empresamodulo_empresa_and_more'),
        ('coreempresas', '0003_remove_empresaparam_idx_empresa_param_campo'),
    ]

    operations = [
        migrations.AlterField(
            model_name='empresamodulo',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='empresamodulo',
            name='id_modulo',
            field=models.ForeignKey(blank=True, db_column='id_modulo', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='empresa_modulos', to='configuracion.modulo'),
        ),
    ]


=== ./configuracion/views.py ===
# ./configuracion/views.py

from rest_framework import viewsets
from .models import Modulo, Menu, EmpresaModulo, EmpresaModuloMenu
from .serializer import (
    ModuloSerializer,
    MenuSerializer,
    EmpresaModuloSerializer,
    EmpresaModuloMenuSerializer
)

class ModuloViewSet(viewsets.ModelViewSet):
    queryset = Modulo.objects.all()
    serializer_class = ModuloSerializer

class MenuViewSet(viewsets.ModelViewSet):
    queryset = Menu.objects.all()
    serializer_class = MenuSerializer

class EmpresaModuloViewSet(viewsets.ModelViewSet):
    queryset = EmpresaModulo.objects.all()
    serializer_class = EmpresaModuloSerializer

class EmpresaModuloMenuViewSet(viewsets.ModelViewSet):
    queryset = EmpresaModuloMenu.objects.all()
    serializer_class = EmpresaModuloMenuSerializer


=== ./configuracion/models.py ===
from django.db import models
from coreempresas.models import Empresa   # <‑‑ Empresa real

# ---------------------------------------------------------------------
#  MODELO  : Modulo
# ---------------------------------------------------------------------
class Modulo(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_modulo')
    modulo      = models.CharField(max_length=50)
    nombre      = models.CharField(max_length=255)
    nombre_menu = models.CharField(max_length=100, null=True, blank=True)
    estado      = models.SmallIntegerField(null=True, blank=True)
    icon        = models.CharField(max_length=255, null=True, blank=True)
    orden       = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."modulos"'

    def __str__(self):
        return self.nombre


# ---------------------------------------------------------------------
#  MODELO  : Menu
# ---------------------------------------------------------------------
class Menu(models.Model):
    id            = models.AutoField(primary_key=True, db_column='id_menu')
    url           = models.CharField(max_length=50)
    texto         = models.CharField(max_length=50, default='')
    etiqueta      = models.CharField(max_length=50, null=True, blank=True)
    descripcion   = models.CharField(max_length=255)
    nivel_menu    = models.IntegerField(default=3)
    orden         = models.IntegerField(null=True, blank=True)
    modificable   = models.CharField(max_length=2, default='SI')
    id_modulo     = models.ForeignKey(Modulo, on_delete=models.RESTRICT, null=True, blank=True, related_name='menus', db_column='id_modulo')
    separador_up  = models.IntegerField(default=0)

    class Meta:
        db_table = '"dm_sistema"."menus"'
        indexes  = [
            models.Index(fields=['id_modulo'], name='idx_modulo_menu'),
        ]

    def __str__(self):
        return self.descripcion


# ---------------------------------------------------------------------
#  MODELO  : EmpresaModulo
# ---------------------------------------------------------------------
class EmpresaModulo(models.Model):
    id         = models.AutoField(primary_key=True, db_column='id_empresa_modulo')
    id_empresa = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='empresa_modulos', null=True, blank=True, db_column='id_empresa')
    id_modulo  = models.ForeignKey(Modulo,  on_delete=models.RESTRICT, related_name='empresa_modulos', null=True, blank=True, db_column='id_modulo')
    estado     = models.IntegerField(default=1)

    class Meta:
        db_table = '"dm_sistema"."empresa_modulos"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_empresa_emm'),
            models.Index(fields=['id_modulo'],  name='idx_mod_emm'),
        ]

    def __str__(self):
        return f'{self.id_empresa} - {self.id_modulo}'


# ---------------------------------------------------------------------
#  MODELO  : EmpresaModuloMenu
# ---------------------------------------------------------------------
class EmpresaModuloMenu(models.Model):
    id                = models.AutoField(primary_key=True, db_column='id_empresa_modulo_menu')
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, on_delete=models.RESTRICT, related_name='empresa_modulos_menus', db_column='id_empresa_modulo')
    id_menu           = models.ForeignKey(Menu,          on_delete=models.RESTRICT, related_name='empresa_modulos_menus', db_column='id_menu')

    class Meta:
        db_table = '"dm_sistema"."empresa_modulos_menu"'
        indexes  = [
            models.Index(fields=['id_empresa_modulo'], name='idx_emp_mod_menu'),
            models.Index(fields=['id_menu'],           name='idx_menu_emm'),
        ]

    def __str__(self):
        return f'{self.id_empresa_modulo} - {self.id_menu}'


=== ./configuracion/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./configuracion/apps.py ===
from django.apps import AppConfig


class ConfiguracionConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'configuracion'


=== ./manage.py ===
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'proyectoDesarrollo.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


=== ./coreempresas/serializer.py ===
# ./coreempresas/serializer.py

from rest_framework import serializers
from .models import Empresa

class EmpresaSerializer(serializers.ModelSerializer):
    class Meta:
        model = Empresa
        fields = '__all__'


=== ./coreempresas/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./coreempresas/urls.py ===
from rest_framework import routers
from django.urls import path, include
from .views import EmpresaViewSet

router = routers.DefaultRouter()
router.register(r'empresa', EmpresaViewSet, basename='empresa')

urlpatterns = [
    path('', include(router.urls)),
]


=== ./coreempresas/__init__.py ===


=== ./coreempresas/migrations/0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more.py ===
# coreempresas/migrations/0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more.py
# -----------------------------------------------------------------------------
# Corrige definitivamente el error “relation "idx_empresa_param_campo" does not exist”.
# En vez de renombrar el índice, lo eliminamos con seguridad si llegara a existir
# (en cualquier esquema) y luego volvemos a crearlo con AddIndex.
# -----------------------------------------------------------------------------

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("coreempresas", "0001_initial"),
    ]

    operations = [
        # ---------------------------------------------------------------------
        # 1. Eliminar el índice antiguo *solo* si existe.
        #    - Buscamos el índice por nombre en TODO el clúster.
        #    - Si lo encontramos, lo suprimimos con EXECUTE format().
        # ---------------------------------------------------------------------
        migrations.RunSQL(
            sql="""
                DO $$
                DECLARE
                    _idx_oid oid;
                BEGIN
                    SELECT c.oid
                    INTO   _idx_oid
                    FROM   pg_class c
                    WHERE  c.relname = 'idx_empresa_param_campo'
                    LIMIT  1;

                    IF FOUND THEN
                        EXECUTE (
                            SELECT format(
                                'DROP INDEX IF EXISTS %I.%I',
                                n.nspname,  -- esquema
                                c.relname   -- nombre del índice
                            )
                            FROM pg_class c
                            JOIN pg_namespace n ON n.oid = c.relnamespace
                            WHERE c.oid = _idx_oid
                        );
                    END IF;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ---------------------------------------------------------------------
        # 2. Borramos el índice idx_empresa_param_empresa_id generado en 0001.
        #    (sigue igual que en tu migración original)
        # ---------------------------------------------------------------------
        migrations.RemoveIndex(
            model_name="empresaparam",
            name="idx_empresa_param_empresa_id",
        ),

        # ---------------------------------------------------------------------
        # 3. Sustituimos claves foráneas antiguas por las nuevas.
        # ---------------------------------------------------------------------
        migrations.RemoveField(model_name="empresaparam",    name="empresa"),
        migrations.RemoveField(model_name="empresaresolucion", name="empresa"),
        migrations.RemoveField(model_name="empresatelefono",  name="empresa"),
        migrations.RemoveField(model_name="grupo",            name="empresa"),

        migrations.AddField(
            model_name="empresaparam",
            name="id_empresa",
            field=models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=models.deletion.RESTRICT,
                related_name="parametros",
                default=1,
            ),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="empresaresolucion",
            name="id_empresa",
            field=models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=models.deletion.RESTRICT,
                related_name="resoluciones",
                default=1,
            ),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="empresatelefono",
            name="id_empresa",
            field=models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=models.deletion.RESTRICT,
                related_name="telefonos",
                default=1,
            ),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="grupo",
            name="id_empresa",
            field=models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=models.deletion.RESTRICT,
                related_name="grupos",
                null=True,
                blank=True,
            ),
        ),

        # ---------------------------------------------------------------------
        # 4. Nuevos índices (o recreación) con los nombres correctos.
        # ---------------------------------------------------------------------
        migrations.AddIndex(
            model_name="empresa",
            index=models.Index(fields=["ingreso_pcd"], name="idx_emp_ing_pcd"),
        ),
        migrations.AddIndex(
            model_name="empresaparam",
            index=models.Index(fields=["id_empresa"], name="idx_emp_par_emp_id"),
        ),
        migrations.AddIndex(
            model_name="empresaparam",
            index=models.Index(fields=["campo"], name="idx_emp_par_campo"),
        ),
        migrations.AddIndex(
            model_name="empresaparam",
            index=models.Index(fields=["valor"], name="idx_emp_par_valor"),
        ),
        migrations.AddIndex(
            model_name="empresaresolucion",
            index=models.Index(fields=["id_empresa"], name="idx_emp_res_empid"),
        ),
        migrations.AddIndex(
            model_name="empresaresolucion",
            index=models.Index(fields=["numero"], name="idx_emp_res_num"),
        ),
        migrations.AddIndex(
            model_name="empresaresolucion",
            index=models.Index(fields=["fecha"], name="idx_emp_res_fecha"),
        ),
        migrations.AddIndex(
            model_name="empresaresolucion",
            index=models.Index(fields=["descripcion"], name="idx_emp_res_desc"),
        ),
        migrations.AddIndex(
            model_name="empresatelefono",
            index=models.Index(
                fields=["id_empresa", "principal"], name="idx_empresa_telem_princ"
            ),
        ),
        migrations.AddIndex(
            model_name="grupo",
            index=models.Index(fields=["id_empresa"], name="idx_grupo_emp_id"),
        ),
        migrations.AddIndex(
            model_name="grupo",
            index=models.Index(fields=["asignable"], name="idx_grupo_asign"),
        ),

        # ---------------------------------------------------------------------
        # 5. Cambiamos los AutoField para usar nuestras columnas reales.
        # ---------------------------------------------------------------------
        migrations.AlterField(
            model_name="empresa",
            name="id",
            field=models.AutoField(primary_key=True, db_column="id_empresa", serialize=False),
        ),
        migrations.AlterField(
            model_name="empresaparam",
            name="id",
            field=models.AutoField(primary_key=True, db_column="id_empresa_param", serialize=False),
        ),
        migrations.AlterField(
            model_name="empresaresolucion",
            name="id",
            field=models.AutoField(primary_key=True, db_column="id_empresa_resolucion", serialize=False),
        ),
        migrations.AlterField(
            model_name="empresatelefono",
            name="id",
            field=models.AutoField(primary_key=True, db_column="id_empresa_telefono", serialize=False),
        ),
        migrations.AlterField(
            model_name="grupo",
            name="id",
            field=models.AutoField(primary_key=True, db_column="id_grupo", serialize=False),
        ),
    ]


=== ./coreempresas/migrations/__init__.py ===


=== ./coreempresas/migrations/0003_remove_empresaparam_idx_empresa_param_campo.py ===
# Generated by Django 5.1.7 on 2025-04-17 13:55

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more'),
    ]

    operations = [
        migrations.RemoveIndex(
            model_name='empresaparam',
            name='idx_empresa_param_campo',
        ),
    ]


=== ./coreempresas/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-28 12:50

import django.core.validators
import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Empresa',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('razon_social', models.CharField(blank=True, max_length=100, null=True)),
                ('direccion', models.CharField(blank=True, max_length=200, null=True)),
                ('comuna', models.CharField(blank=True, max_length=50, null=True)),
                ('ciudad', models.CharField(blank=True, max_length=50, null=True)),
                ('rut', models.CharField(blank=True, max_length=20, null=True)),
                ('giro', models.CharField(blank=True, max_length=255, null=True)),
                ('acteco', models.CharField(blank=True, max_length=10, null=True)),
                ('rut_firma', models.CharField(blank=True, max_length=20, null=True)),
                ('logo', models.CharField(blank=True, max_length=50, null=True)),
                ('subdominio', models.CharField(blank=True, max_length=50, null=True)),
                ('titulo', models.CharField(blank=True, max_length=50, null=True)),
                ('estado', models.IntegerField(default=1)),
                ('fecha_incorporacion', models.DateTimeField(default=django.utils.timezone.now)),
                ('master', models.BooleanField(default=False)),
                ('fecha_modificacion', models.DateTimeField(blank=True, null=True)),
                ('licencias', models.IntegerField(default=5)),
                ('logo_grande', models.CharField(blank=True, max_length=255, null=True)),
                ('ingreso_pcd', models.IntegerField()),
                ('ingreso_funnel', models.IntegerField(default=0)),
                ('mercado', models.CharField(blank=True, max_length=50, null=True)),
            ],
            options={
                'db_table': '"dm_sistema"."empresa"',
                'indexes': [models.Index(fields=['mercado'], name='idx_empresa_mercado'), models.Index(fields=['estado'], name='idx_empresa_estado')],
            },
        ),
        migrations.CreateModel(
            name='EmpresaResolucion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('numero', models.CharField(max_length=50)),
                ('fecha', models.DateField()),
                ('tipo', models.CharField(default='SII', max_length=20)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='resoluciones', to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."empresa_resolucion"',
            },
        ),
        migrations.CreateModel(
            name='EmpresaTelefono',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('numero', models.CharField(max_length=20)),
                ('tipo', models.CharField(choices=[('FIJO', 'Fijo'), ('MOVIL', 'Móvil'), ('FAX', 'Fax'), ('OTRO', 'Otro')], max_length=10, validators=[django.core.validators.RegexValidator(regex='^(FIJO|MOVIL|FAX|OTRO)$')])),
                ('principal', models.BooleanField(default=False)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='telefonos', to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."empresa_telefono"',
            },
        ),
        migrations.CreateModel(
            name='Grupo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(blank=True, max_length=255, null=True)),
                ('asignable', models.IntegerField(default=1)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='grupos', to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."grupo"',
            },
        ),
        migrations.CreateModel(
            name='EmpresaParam',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('campo', models.CharField(blank=True, max_length=255, null=True)),
                ('valor', models.CharField(blank=True, max_length=255, null=True)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='parametros', to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."empresa_param"',
                'indexes': [models.Index(fields=['empresa'], name='idx_empresa_param_empresa_id'), models.Index(fields=['campo'], name='idx_empresa_param_campo')],
            },
        ),
    ]


=== ./coreempresas/migrations/0004_alter_empresaparam_id_empresa_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0003_remove_empresaparam_idx_empresa_param_campo'),
    ]

    operations = [
        migrations.AlterField(
            model_name='empresaparam',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='parametros', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='empresaresolucion',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='resoluciones', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='empresatelefono',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='telefonos', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='grupo',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='grupos', to='coreempresas.empresa'),
        ),
    ]


=== ./coreempresas/views.py ===
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import Empresa
from .serializer import EmpresaSerializer
from django.shortcuts import render

# ViewSet para el modelo Empresa que permite listar, crear, actualizar, eliminar
# y obtener datos a partir del id enviado en un POST.
class EmpresaViewSet(viewsets.ModelViewSet):
    queryset = Empresa.objects.all()
    serializer_class = EmpresaSerializer

    @action(detail=False, methods=['post'])
    def obtener_datos(self, request):
        """
        POST /empresa/obtener_datos/
        Recibe en el JSON el campo "id" y retorna los datos de la empresa correspondiente.
        Ejemplo de JSON en el Body:
        {
            "id": 3
        }
        """
        empresa_id = request.data.get("id")
        if not empresa_id:
            return Response(
                {"error": "Falta el campo 'id' en la solicitud."},
                status=status.HTTP_400_BAD_REQUEST
            )
        try:
            empresa = Empresa.objects.get(id=empresa_id)
        except Empresa.DoesNotExist:
            return Response(
                {"error": "No se encontró la empresa con el id proporcionado."},
                status=status.HTTP_404_NOT_FOUND
            )
        serializer = self.get_serializer(empresa)
        return Response(serializer.data, status=status.HTTP_200_OK)

    @action(detail=False, methods=['post'])
    def cambiar_estado(self, request):
        """
        POST /empresa/cambiar_estado/
        Recibe en el JSON los campos "id" y "estado". Actualiza la columna "estado" de la 
        empresa correspondiente al "id" enviado y retorna la empresa actualizada.
        Ejemplo de JSON en el Body:
        {
            "id": 3,
            "estado": 0
        }
        """
        empresa_id = request.data.get("id")
        nuevo_estado = request.data.get("estado")
        if not empresa_id or nuevo_estado is None:
            return Response(
                {"error": "Se requieren los campos 'id' y 'estado' en la solicitud."},
                status=status.HTTP_400_BAD_REQUEST
            )
        try:
            empresa = Empresa.objects.get(id=empresa_id)
        except Empresa.DoesNotExist:
            return Response(
                {"error": "No se encontró la empresa con el id proporcionado."},
                status=status.HTTP_404_NOT_FOUND
            )
        empresa.estado = nuevo_estado
        empresa.save()
        serializer = self.get_serializer(empresa)
        return Response(serializer.data, status=status.HTTP_200_OK)


=== ./coreempresas/models.py ===
from django.db import models
from django.utils import timezone
from django.core.validators import RegexValidator

# ---------------------------------------------------------------------
#  Choices
# ---------------------------------------------------------------------
TIPO_TELEFONO_CHOICES = [
    ('FIJO', 'Fijo'),
    ('MOVIL', 'Móvil'),
    ('FAX',  'Fax'),
    ('OTRO', 'Otro'),
]

# ---------------------------------------------------------------------
#  MODELO  : Empresa
# ---------------------------------------------------------------------
class Empresa(models.Model):
    id                 = models.AutoField(primary_key=True, db_column='id_empresa')
    razon_social       = models.CharField(max_length=100, null=True, blank=True)
    direccion          = models.CharField(max_length=200, null=True, blank=True)
    comuna             = models.CharField(max_length=50,  null=True, blank=True)
    ciudad             = models.CharField(max_length=50,  null=True, blank=True)
    rut                = models.CharField(max_length=20,  null=True, blank=True)
    giro               = models.CharField(max_length=255, null=True, blank=True)
    acteco             = models.CharField(max_length=10,  null=True, blank=True)
    rut_firma          = models.CharField(max_length=20,  null=True, blank=True)
    logo               = models.CharField(max_length=50,  null=True, blank=True)
    subdominio         = models.CharField(max_length=50,  null=True, blank=True)
    titulo             = models.CharField(max_length=50,  null=True, blank=True)
    estado             = models.IntegerField(default=1)
    fecha_incorporacion = models.DateTimeField(default=timezone.now)
    master             = models.BooleanField(default=False)
    fecha_modificacion = models.DateTimeField(null=True, blank=True)
    licencias          = models.IntegerField(default=5)
    logo_grande        = models.CharField(max_length=255, null=True, blank=True)
    ingreso_pcd        = models.IntegerField()
    ingreso_funnel     = models.IntegerField(default=0)
    mercado            = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."empresa"'
        indexes  = [
            models.Index(fields=['mercado'],      name='idx_empresa_mercado'),
            models.Index(fields=['estado'],       name='idx_empresa_estado'),
            models.Index(fields=['ingreso_pcd'],  name='idx_emp_ing_pcd'),
        ]

    def __str__(self):
        return self.razon_social or ''


# ---------------------------------------------------------------------
#  MODELO  : EmpresaTelefono
# ---------------------------------------------------------------------
class EmpresaTelefono(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_empresa_telefono')
    id_empresa  = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='telefonos', db_column='id_empresa')
    numero      = models.CharField(max_length=20)
    tipo        = models.CharField(
        max_length=10,
        choices=TIPO_TELEFONO_CHOICES,
        validators=[RegexValidator(regex=r'^(FIJO|MOVIL|FAX|OTRO)$')],
    )
    principal   = models.BooleanField(default=False)

    class Meta:
        db_table = '"dm_sistema"."empresa_telefono"'
        indexes  = [
            models.Index(fields=['id_empresa', 'principal'], name='idx_empresa_telem_princ'),
        ]

    def __str__(self):
        return f'{self.id_empresa} - {self.numero}'


# ---------------------------------------------------------------------
#  MODELO  : EmpresaResolucion
# ---------------------------------------------------------------------
class EmpresaResolucion(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_empresa_resolucion')
    id_empresa  = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='resoluciones', db_column='id_empresa')
    numero      = models.CharField(max_length=50)
    fecha       = models.DateField()
    tipo        = models.CharField(max_length=20, default='SII')
    descripcion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."empresa_resolucion"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_emp_res_empid'),
            models.Index(fields=['numero'],     name='idx_emp_res_num'),
            models.Index(fields=['fecha'],      name='idx_emp_res_fecha'),
            models.Index(fields=['descripcion'], name='idx_emp_res_desc'),
        ]

    def __str__(self):
        return f'{self.id_empresa} - {self.numero}'


# ---------------------------------------------------------------------
#  MODELO  : EmpresaParam
# ---------------------------------------------------------------------
class EmpresaParam(models.Model):
    id         = models.AutoField(primary_key=True, db_column='id_empresa_param')
    id_empresa = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='parametros', db_column='id_empresa')
    campo      = models.CharField(max_length=255, null=True, blank=True)
    valor      = models.CharField(max_length=255, null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."empresa_param"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_emp_par_emp_id'),
            models.Index(fields=['campo'],      name='idx_emp_par_campo'),
            models.Index(fields=['valor'],      name='idx_emp_par_valor'),
        ]

    def __str__(self):
        return f'{self.id_empresa} - {self.campo}'


# ---------------------------------------------------------------------
#  MODELO  : Grupo
# ---------------------------------------------------------------------
class Grupo(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_grupo')
    nombre      = models.CharField(max_length=255, null=True, blank=True)
    asignable   = models.IntegerField(default=1)
    id_empresa  = models.ForeignKey(Empresa, on_delete=models.RESTRICT, null=True, blank=True, related_name='grupos', db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."grupo"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_grupo_emp_id'),
            models.Index(fields=['asignable'],  name='idx_grupo_asign'),
        ]

    def __str__(self):
        return self.nombre or ''


=== ./coreempresas/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./coreempresas/apps.py ===
from django.apps import AppConfig


class CoreempresasConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'coreempresas'


=== ./gunicorn_start.sh ===
#!/bin/bash
# Nombre del proyecto
NAME="proyectoDesarrollo"
# Directorio del proyecto (ajusta la ruta a tu proyecto)
DJANGODIR="/home/ignrv/proyectos/Gunicorn/proyectoDesarrollo"
# Directorio del entorno virtual (ajusta la ruta a tu venv)
VENV="/home/ignrv/proyectos/Gunicorn/venv/bin/activate"
# Número de workers (ajusta según tus necesidades)
NUM_WORKERS=3
# Módulo WSGI de Django
DJANGO_WSGI_MODULE="proyectoDesarrollo.wsgi:application"

echo "Iniciando Gunicorn para $NAME como $(whoami)"

# Entrar al directorio del proyecto
cd $DJANGODIR || exit
# Activar el entorno virtual
source $VENV

# Exportar la variable de entorno de configuración (si no está ya definida)
export DJANGO_SETTINGS_MODULE=proyectoDesarrollo.settings

# Iniciar Gunicorn
exec gunicorn $DJANGO_WSGI_MODULE \
  --name $NAME \
  --workers $NUM_WORKERS \
  --bind 0.0.0.0:8000 \
  --log-level=info \
  --log-file=-


=== ./logs/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./logs/__init__.py ===


=== ./logs/migrations/__init__.py ===


=== ./logs/migrations/0003_alter_log_id_empresa_alter_log_id_operador.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:41

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0003_remove_empresaparam_idx_empresa_param_campo'),
        ('logs', '0002_remove_log_idx_log_cliente_id_and_more'),
        ('operadores', '0006_alter_operador_unique_together_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='log',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='log',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='logs', to='operadores.operador'),
        ),
    ]


=== ./logs/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-28 13:25

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('coreempresas', '0001_initial'),
        ('operadores', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Log',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('operacion', models.CharField(max_length=30)),
                ('detalle', models.TextField()),
                ('script', models.CharField(max_length=100)),
                ('tabla', models.CharField(max_length=100)),
                ('fecha', models.DateTimeField()),
                ('cliente_id', models.IntegerField(default=0)),
                ('contrato_id', models.IntegerField(default=0)),
                ('suscriptor_id', models.IntegerField(default=0)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."log"',
                'indexes': [models.Index(fields=['cliente_id'], name='idx_log_cliente_id'), models.Index(fields=['contrato_id'], name='idx_log_contrato_id'), models.Index(fields=['empresa'], name='idx_log_empresa_id')],
            },
        ),
    ]


=== ./logs/migrations/0002_remove_log_idx_log_cliente_id_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 13:34

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more'),
        ('logs', '0001_initial'),
        ('operadores', '0005_remove_operador_idx_opr_emp_id_and_more'),
    ]

    operations = [
        migrations.RemoveIndex(
            model_name='log',
            name='idx_log_cliente_id',
        ),
        migrations.RemoveIndex(
            model_name='log',
            name='idx_log_contrato_id',
        ),
        migrations.RemoveIndex(
            model_name='log',
            name='idx_log_empresa_id',
        ),
        migrations.RenameField(
            model_name='log',
            old_name='cliente_id',
            new_name='id_cliente',
        ),
        migrations.RenameField(
            model_name='log',
            old_name='contrato_id',
            new_name='id_contrato',
        ),
        migrations.RenameField(
            model_name='log',
            old_name='suscriptor_id',
            new_name='id_suscriptor',
        ),
        migrations.RemoveField(
            model_name='log',
            name='empresa',
        ),
        migrations.RemoveField(
            model_name='log',
            name='operador',
        ),
        migrations.AddField(
            model_name='log',
            name='id_empresa',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AddField(
            model_name='log',
            name='id_operador',
            field=models.ForeignKey(default=1, on_delete=django.db.models.deletion.RESTRICT, related_name='logs', to='operadores.operador'),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name='log',
            name='id',
            field=models.AutoField(db_column='id_log', primary_key=True, serialize=False),
        ),
        migrations.AddIndex(
            model_name='log',
            index=models.Index(fields=['id_cliente'], name='idx_log_idcliente'),
        ),
        migrations.AddIndex(
            model_name='log',
            index=models.Index(fields=['id_contrato'], name='idx_log_idcontrato'),
        ),
        migrations.AddIndex(
            model_name='log',
            index=models.Index(fields=['id_empresa'], name='idx_log_idemp'),
        ),
        migrations.AddIndex(
            model_name='log',
            index=models.Index(fields=['id_suscriptor'], name='idx_log_idsuscriptor'),
        ),
        migrations.AddIndex(
            model_name='log',
            index=models.Index(fields=['id_operador'], name='idx_log_idoperador'),
        ),
    ]


=== ./logs/views.py ===
from django.shortcuts import render

# Create your views here.


=== ./logs/models.py ===
from django.db import models
from operadores.models import Operador
from coreempresas.models import Empresa

# ---------------------------------------------------------------------
#  MODELO  : Log
# ---------------------------------------------------------------------
class Log(models.Model):
    id            = models.AutoField(primary_key=True, db_column='id_log')
    id_operador   = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='logs', db_column='id_operador')
    id_empresa    = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, null=True, blank=True, db_column='id_empresa')
    operacion     = models.CharField(max_length=30)
    detalle       = models.TextField()
    script        = models.CharField(max_length=100)
    tabla         = models.CharField(max_length=100)
    fecha         = models.DateTimeField()
    id_cliente    = models.IntegerField(default=0)
    id_contrato   = models.IntegerField(default=0)
    id_suscriptor = models.IntegerField(default=0)

    class Meta:
        db_table = '"dm_sistema"."log"'
        indexes  = [
            models.Index(fields=['id_cliente'],   name='idx_log_idcliente'),
            models.Index(fields=['id_contrato'],  name='idx_log_idcontrato'),
            models.Index(fields=['id_empresa'],   name='idx_log_idemp'),
            models.Index(fields=['id_suscriptor'], name='idx_log_idsuscriptor'),
            models.Index(fields=['id_operador'], name='idx_log_idoperador'),
        ]

    def __str__(self):
        return f'Log {self.id} - {self.operacion}'


=== ./logs/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./logs/apps.py ===
from django.apps import AppConfig


class LogsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'logs'


=== ./tasks/serializer.py ===
from rest_framework import serializers
from .models import Task

class TaskSerializer(serializers.ModelSerializer):
    class Meta:
        model = Task
        #fields = ['id', 'title', 'description', 'completed']
        fields = '__all__'


=== ./tasks/admin.py ===
from django.contrib import admin
from .models import Task
# Register your models here.
admin.site.register(Task)
 

=== ./tasks/urls.py ===
from django.urls import path, include
from rest_framework.documentation import include_docs_urls
from rest_framework import routers
from tasks import views

# api versioning
router = routers.DefaultRouter()
router.register(r'tasks', views.TaskView, 'tasks')

urlpatterns = [
    path('api/v1/', include(router.urls)),
    path('docs/', include_docs_urls(title='Tasks API')),
]


=== ./tasks/__init__.py ===


=== ./tasks/migrations/__init__.py ===


=== ./tasks/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-21 15:16

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Task',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('completed', models.BooleanField(default=False)),
            ],
        ),
    ]


=== ./tasks/views.py ===
from rest_framework import viewsets
from .serializer import TaskSerializer
from .models import Task

class TaskView(viewsets.ModelViewSet):
    serializer_class = TaskSerializer
    queryset = Task.objects.all()


=== ./tasks/models.py ===
from django.db import models

class Task(models.Model):
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    completed = models.BooleanField(default=False)

    def __str__(self):
        return self.title

=== ./tasks/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./tasks/apps.py ===
from django.apps import AppConfig


class TasksConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'tasks'


=== ./dm_logistica/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./dm_logistica/__init__.py ===


=== ./dm_logistica/migrations/__init__.py ===


=== ./dm_logistica/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-04-20 01:17

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True
    dependencies = [
        ('coreempresas', '0004_alter_empresaparam_id_empresa_and_more'),
        ('operadores', '0008_alter_operadorbodega_id_empresa_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='BodegaTipo',
            fields=[
                ('id', models.AutoField(db_column='id_bodega_tipo', primary_key=True, serialize=False)),
                ('tipo_bodega', models.CharField(default='', max_length=50, unique=True)),
            ],
            options={
                'verbose_name': 'Tipo de Bodega',
                'db_table': '"dm_logistica"."bodega_tipo"',
            },
        ),
        migrations.CreateModel(
            name='EstadoControlInventario',
            fields=[
                ('id', models.AutoField(db_column='id_estado_control_inventario', primary_key=True, serialize=False)),
                ('detalle', models.CharField(blank=True, max_length=50, null=True)),
            ],
            options={
                'verbose_name': 'Estado Control de Inventario',
                'verbose_name_plural': 'Estados Control de Inventario',
                'db_table': '"dm_logistica"."estado_control_inventario"',
            },
        ),
        migrations.CreateModel(
            name='EstadoDetalleControlInventario',
            fields=[
                ('id', models.AutoField(db_column='id_estado_detalle_control_inventario', primary_key=True, serialize=False)),
                ('descripcion', models.CharField(blank=True, max_length=45, null=True)),
                ('boton', models.SmallIntegerField(blank=True, null=True)),
                ('dboton', models.CharField(blank=True, max_length=15, null=True)),
                ('icon', models.CharField(blank=True, max_length=20, null=True)),
            ],
            options={
                'verbose_name': 'Estado Detalle de Control de Inventario',
                'verbose_name_plural': 'Estados Detalle de Control de Inventario',
                'db_table': '"dm_logistica"."estado_detalle_control_inventario"',
            },
        ),
        migrations.CreateModel(
            name='EstadoOrdenCompra',
            fields=[
                ('id', models.AutoField(db_column='id_estado_orden_compra', primary_key=True, serialize=False)),
                ('descripcion', models.CharField(max_length=100)),
            ],
            options={
                'verbose_name': 'Estado Orden Compra',
                'verbose_name_plural': 'Estados Orden Compra',
                'db_table': '"dm_logistica"."estado_orden_compra"',
            },
        ),
        migrations.CreateModel(
            name='EstadoProducto',
            fields=[
                ('id', models.AutoField(db_column='id_estado_producto', primary_key=True, serialize=False)),
                ('estado_producto', models.CharField(max_length=50)),
            ],
            options={
                'verbose_name': 'Estado de Producto',
                'verbose_name_plural': 'Estados de Producto',
                'db_table': '"dm_logistica"."estado_producto"',
            },
        ),
        migrations.CreateModel(
            name='EstadoSolicitudCompra',
            fields=[
                ('id', models.AutoField(db_column='id_estado_solicitud_compra', primary_key=True, serialize=False)),
                ('descripcion_solicitud_compra', models.CharField(max_length=100)),
            ],
            options={
                'verbose_name': 'Estado Solicitud de Compra',
                'verbose_name_plural': 'Estados Solicitud de Compra',
                'db_table': '"dm_logistica"."estado_solicitud_compra"',
            },
        ),
        migrations.CreateModel(
            name='IdentificadorSerie',
            fields=[
                ('id', models.AutoField(db_column='id_identificador_serie', primary_key=True, serialize=False)),
                ('nombre_serie', models.CharField(max_length=45)),
                ('estado_serie', models.IntegerField(default=1)),
            ],
            options={
                'verbose_name': 'Identificador de Serie',
                'verbose_name_plural': 'Identificadores de Serie',
                'db_table': '"dm_logistica"."identificador_serie"',
            },
        ),
        migrations.CreateModel(
            name='TipoControlInventario',
            fields=[
                ('id', models.AutoField(db_column='id_tipo_control_inventario', primary_key=True, serialize=False)),
                ('detalle', models.CharField(blank=True, max_length=50, null=True)),
            ],
            options={
                'verbose_name': 'Tipo de Control de Inventario',
                'verbose_name_plural': 'Tipos de Control de Inventario',
                'db_table': '"dm_logistica"."tipo_control_inventario"',
            },
        ),
        migrations.CreateModel(
            name='TipoSolicitud',
            fields=[
                ('id', models.AutoField(db_column='id_tipo_solicitud', primary_key=True, serialize=False)),
                ('descripcion', models.CharField(blank=True, max_length=30, null=True)),
            ],
            options={
                'verbose_name': 'Tipo de Solicitud',
                'verbose_name_plural': 'Tipos de Solicitud',
                'db_table': '"dm_logistica"."tipo_solicitud"',
            },
        ),
        migrations.CreateModel(
            name='UnidadMedida',
            fields=[
                ('id', models.AutoField(db_column='id_unidad_medida', primary_key=True, serialize=False)),
                ('nombre_unidad_medida', models.CharField(blank=True, max_length=30, null=True)),
            ],
            options={
                'verbose_name': 'Unidad de Medida',
                'verbose_name_plural': 'Unidades de Medida',
                'db_table': '"dm_logistica"."unidad_medida"',
            },
        ),
        migrations.CreateModel(
            name='Atributo',
            fields=[
                ('id', models.AutoField(db_column='id_atributo', primary_key=True, serialize=False)),
                ('id_modelo_producto', models.IntegerField(default=0)),
                ('nombre_atributo', models.CharField(max_length=100)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Atributo',
                'verbose_name_plural': 'Atributos',
                'db_table': '"dm_logistica"."atributo"',
            },
        ),
        migrations.CreateModel(
            name='Bodega',
            fields=[
                ('id', models.AutoField(db_column='id_bodega', primary_key=True, serialize=False)),
                ('estado_bodega', models.PositiveIntegerField(default=0)),
                ('nombre_bodega', models.CharField(max_length=100)),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', default=0, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_bodega_tipo', models.ForeignKey(db_column='id_bodega_tipo', on_delete=django.db.models.deletion.RESTRICT, related_name='bodega', to='dm_logistica.bodegatipo')),
            ],
            options={
                'verbose_name': 'Bodega',
                'verbose_name_plural': 'Bodegas',
                'db_table': '"dm_logistica"."bodega"',
            },
        ),
        migrations.CreateModel(
            name='BodegaStock',
            fields=[
                ('id', models.AutoField(db_column='id_bodega_stock', primary_key=True, serialize=False)),
                ('id_modelo_producto', models.IntegerField()),
                ('stock_critico', models.IntegerField(blank=True, null=True)),
                ('porc_alarma', models.IntegerField(blank=True, null=True)),
                ('alarma', models.SmallIntegerField(blank=True, null=True)),
                ('id_bodega', models.ForeignKey(db_column='id_bodega', on_delete=django.db.models.deletion.RESTRICT, related_name='bodega_stock', to='dm_logistica.bodega')),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', default=0, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_grupo', models.ForeignKey(db_column='id_grupo', on_delete=django.db.models.deletion.RESTRICT, related_name='bodega_stock', to='coreempresas.grupo')),
            ],
            options={
                'verbose_name': 'Stock en Bodega',
                'verbose_name_plural': 'Stocks en Bodega',
                'db_table': '"dm_logistica"."bodega_stock"',
            },
        ),
        migrations.CreateModel(
            name='ControlInventario',
            fields=[
                ('id', models.AutoField(db_column='id_control_inventario', primary_key=True, serialize=False)),
                ('fecha', models.DateTimeField(blank=True, null=True)),
                ('fecha_termino', models.DateTimeField(blank=True, null=True)),
                ('observaciones', models.TextField(blank=True, null=True)),
                ('id_bodega', models.ForeignKey(db_column='id_bodega', on_delete=django.db.models.deletion.RESTRICT, related_name='control_inventario', to='dm_logistica.bodega')),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='control_inventario', to='operadores.operador')),
                ('id_estado_control_inventario', models.ForeignKey(db_column='id_estado_control_inventario', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='control_inventario', to='dm_logistica.estadocontrolinventario')),
                ('id_tipo_control_inventario', models.ForeignKey(db_column='id_tipo_control', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='control_inventario', to='dm_logistica.tipocontrolinventario')),
            ],
            options={
                'verbose_name': 'Control de Inventario',
                'verbose_name_plural': 'Controles de Inventario',
                'db_table': '"dm_logistica"."control_inventario"',
            },
        ),
        migrations.CreateModel(
            name='Cotizacion',
            fields=[
                ('id', models.AutoField(db_column='id_cotizacion', primary_key=True, serialize=False)),
                ('fecha_cotizacion', models.DateTimeField(default=django.utils.timezone.now)),
                ('total', models.FloatField(blank=True, null=True)),
                ('validez_cotizacion', models.IntegerField(blank=True, null=True)),
                ('archivo', models.CharField(blank=True, max_length=256, null=True)),
                ('estado_cotizacion', models.IntegerField(default=0)),
                ('estado_detalle', models.SmallIntegerField(default=0)),
                ('iva', models.SmallIntegerField(blank=True, null=True)),
                ('folio', models.CharField(blank=True, max_length=64, null=True)),
                ('id_tipo_moneda', models.IntegerField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(blank=True, db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_logistica"."cotizacion"',
            },
        ),
        migrations.CreateModel(
            name='Giro',
            fields=[
                ('id', models.AutoField(db_column='id_giro', primary_key=True, serialize=False)),
                ('descrip_giro', models.CharField(max_length=250)),
                ('codigo_sii', models.CharField(max_length=10)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='giros_logistica', to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Giro',
                'verbose_name_plural': 'Giros',
                'db_table': '"dm_logistica"."giro"',
            },
        ),
        migrations.CreateModel(
            name='MarcaProducto',
            fields=[
                ('id', models.AutoField(db_column='id_marca_producto', primary_key=True, serialize=False)),
                ('marca_producto', models.CharField(max_length=50)),
                ('estado', models.IntegerField(default=1)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Marca de Producto',
                'verbose_name_plural': 'Marcas de Producto',
                'db_table': '"dm_logistica"."marca_producto"',
            },
        ),
        migrations.CreateModel(
            name='ModeloProducto',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('id_modelo_producto', models.IntegerField(default=0, unique=True)),
                ('codigo_interno', models.CharField(blank=True, max_length=50, null=True)),
                ('fccid', models.CharField(blank=True, max_length=50, null=True)),
                ('sku', models.CharField(blank=True, max_length=255, null=True)),
                ('sku_codigo', models.CharField(blank=True, max_length=255, null=True)),
                ('nombre_modelo', models.CharField(max_length=100)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('imagen', models.CharField(blank=True, max_length=200, null=True)),
                ('estado', models.IntegerField(default=1)),
                ('numero_parte', models.CharField(max_length=100)),
                ('producto_seriado', models.SmallIntegerField(default=1)),
                ('nombre_comercial', models.CharField(blank=True, max_length=255, null=True)),
                ('nombre_tecnico', models.CharField(blank=True, max_length=255, null=True)),
                ('so', models.CharField(blank=True, max_length=100, null=True)),
                ('vso', models.CharField(blank=True, max_length=100, null=True)),
                ('version_hw', models.CharField(blank=True, max_length=100, null=True)),
                ('vspc', models.CharField(blank=True, max_length=100, null=True)),
                ('vspf', models.CharField(blank=True, max_length=100, null=True)),
                ('fabricante', models.CharField(blank=True, max_length=255, null=True)),
                ('ubicacion', models.CharField(blank=True, max_length=255, null=True)),
                ('despacho_express', models.SmallIntegerField(default=0)),
                ('rebaja_consumo', models.IntegerField(default=0)),
                ('dias_rebaja_consumo', models.IntegerField(blank=True, null=True)),
                ('orden_solicitud_despacho', models.IntegerField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_identificador_serie', models.ForeignKey(db_column='id_identificador_serie', on_delete=django.db.models.deletion.RESTRICT, related_name='modelos', to='dm_logistica.identificadorserie')),
            ],
            options={
                'verbose_name': 'Modelo de Producto',
                'verbose_name_plural': 'Modelos de Producto',
                'db_table': '"dm_logistica"."modelo_producto"',
            },
        ),
        migrations.CreateModel(
            name='ModeloProductoValores',
            fields=[
                ('id', models.AutoField(db_column='id_modelo_producto_valor', primary_key=True, serialize=False)),
                ('id_modelo_producto', models.IntegerField(default=0)),
                ('valor_cliente', models.IntegerField(blank=True, null=True)),
                ('valor_publico', models.IntegerField(blank=True, null=True)),
                ('margen', models.IntegerField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Valor de Modelo de Producto',
                'verbose_name_plural': 'Valores de Modelos de Producto',
                'db_table': '"dm_logistica"."modelo_producto_valores"',
            },
        ),
        migrations.CreateModel(
            name='Movimiento',
            fields=[
                ('id', models.AutoField(db_column='id_movimiento', primary_key=True, serialize=False)),
                ('folio', models.CharField(blank=True, max_length=9, null=True)),
                ('operador_emision', models.CharField(blank=True, max_length=50, null=True)),
                ('operador_destino', models.CharField(blank=True, default='', max_length=50)),
                ('observacion', models.TextField(blank=True, null=True)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('tipo_movimiento', models.CharField(default='MOVIMIENTO', max_length=50)),
                ('id_bodega_origen', models.IntegerField()),
                ('id_despachador', models.IntegerField(default=0)),
                ('id_receptor', models.IntegerField(default=0)),
                ('id_punto_venta', models.IntegerField(default=0)),
                ('pdf', models.CharField(blank=True, max_length=255, null=True)),
                ('folio_comprobante', models.CharField(default='0', max_length=32)),
                ('fecha_actualizacion', models.DateTimeField(blank=True, null=True)),
                ('id_requerimiento', models.IntegerField(blank=True, null=True)),
                ('id_bodega', models.ForeignKey(db_column='id_bodega', on_delete=django.db.models.deletion.RESTRICT, related_name='movimientos', to='dm_logistica.bodega')),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Movimiento',
                'verbose_name_plural': 'Movimientos',
                'db_table': '"dm_logistica"."movimiento"',
            },
        ),
        migrations.CreateModel(
            name='OrdenCompra',
            fields=[
                ('id', models.AutoField(db_column='id_orden_compra', primary_key=True, serialize=False)),
                ('id_solicitante', models.CharField(blank=True, max_length=50, null=True)),
                ('folio', models.CharField(blank=True, max_length=30, null=True)),
                ('fecha', models.DateTimeField(default=django.utils.timezone.now)),
                ('neto', models.FloatField(blank=True, null=True)),
                ('iva', models.FloatField(blank=True, null=True)),
                ('monto_total', models.FloatField(blank=True, null=True)),
                ('observacion', models.TextField(blank=True, null=True)),
                ('fecha_entrega', models.DateTimeField(blank=True, null=True)),
                ('id_aprobador', models.CharField(blank=True, max_length=50, null=True)),
                ('archivo', models.CharField(blank=True, max_length=256, null=True)),
                ('notas_adicionales', models.TextField(blank=True, null=True)),
                ('id_requerimiento', models.IntegerField(blank=True, null=True)),
                ('id_tipo_moneda', models.IntegerField(blank=True, null=True)),
                ('operador_anula', models.CharField(blank=True, max_length=50, null=True)),
                ('fecha_anula', models.DateTimeField(blank=True, null=True)),
                ('motivo_anula', models.TextField(blank=True, null=True)),
                ('desviacion', models.CharField(default='NO', max_length=2)),
                ('id_cotizacion', models.ForeignKey(db_column='id_cotizacion', on_delete=django.db.models.deletion.RESTRICT, related_name='orden_compra', to='dm_logistica.cotizacion')),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_estado_orden_compra', models.ForeignKey(db_column='id_estado_or_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='orden_compra', to='dm_logistica.estadoordencompra')),
                ('id_operador', models.ForeignKey(blank=True, db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='orden_compra', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_logistica"."orden_compra"',
            },
        ),
        migrations.CreateModel(
            name='DetalleCompra',
            fields=[
                ('id', models.AutoField(db_column='id_detalle_compra', primary_key=True, serialize=False)),
                ('id_modelo_producto', models.IntegerField(blank=True, null=True)),
                ('cantidad', models.BigIntegerField(blank=True, null=True)),
                ('precio_unitario', models.FloatField(blank=True, null=True)),
                ('glosa', models.CharField(blank=True, max_length=100, null=True)),
                ('descuento_unitario', models.FloatField(blank=True, null=True)),
                ('total_neto', models.FloatField(blank=True, null=True)),
                ('tipo_item', models.IntegerField(blank=True, null=True)),
                ('comprobado', models.IntegerField(default=0)),
                ('producto_ingresado', models.SmallIntegerField(default=0)),
                ('fecha_ingreso_producto', models.DateTimeField(blank=True, null=True)),
                ('id_operador_ingreso_producto', models.CharField(blank=True, max_length=50, null=True)),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_orden_compra', models.ForeignKey(db_column='id_orden_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_compra', to='dm_logistica.ordencompra')),
            ],
            options={
                'db_table': '"dm_logistica"."detalle_compra"',
            },
        ),
        migrations.CreateModel(
            name='ProcesoComparacion',
            fields=[
                ('id', models.AutoField(db_column='id_proceso_comparacion', primary_key=True, serialize=False)),
                ('fecha_comparacion', models.DateTimeField(auto_now=True)),
                ('estado_comparacion', models.IntegerField(default=1)),
                ('observacion', models.TextField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(blank=True, db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='proceso_comparacion', to='operadores.operador')),
                ('id_orden_compra', models.ForeignKey(db_column='id_orden_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='proceso_comparacion', to='dm_logistica.ordencompra')),
            ],
            options={
                'db_table': '"dm_logistica"."proceso_comparacion"',
            },
        ),
        migrations.CreateModel(
            name='AjusteDetalleCompra',
            fields=[
                ('id', models.AutoField(db_column='id_ajuste_detalle_compra', primary_key=True, serialize=False)),
                ('cantidad', models.IntegerField(blank=True, null=True)),
                ('precio_unitario', models.FloatField()),
                ('glosa', models.CharField(max_length=100)),
                ('descuento', models.FloatField()),
                ('tipo_descuento', models.CharField(blank=True, max_length=10, null=True)),
                ('total_neto', models.FloatField()),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_detalle_compra', models.ForeignKey(db_column='id_detalle_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='ajuste_detalle_compra', to='dm_logistica.detallecompra')),
                ('id_orden_compra', models.ForeignKey(db_column='id_orden_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='ajuste_detalle_compra', to='dm_logistica.ordencompra')),
                ('id_proceso_comparacion', models.ForeignKey(blank=True, db_column='id_proceso_comparacion', null=True, on_delete=django.db.models.deletion.RESTRICT, to='dm_logistica.procesocomparacion')),
            ],
            options={
                'db_table': '"dm_logistica"."ajuste_detalle_compra"',
            },
        ),
        migrations.CreateModel(
            name='ProductoBodega',
            fields=[
                ('id', models.AutoField(db_column='id_producto_bodega', primary_key=True, serialize=False)),
                ('serial', models.CharField(blank=True, max_length=100, null=True)),
                ('cantidad', models.FloatField(blank=True, null=True)),
                ('fecha_registro', models.DateTimeField(default=django.utils.timezone.now)),
                ('id_bodega', models.ForeignKey(db_column='id_bodega', on_delete=django.db.models.deletion.RESTRICT, related_name='productos_bodega', to='dm_logistica.bodega')),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='productos_bodega', to='coreempresas.empresa')),
                ('id_estado_producto', models.ForeignKey(blank=True, db_column='id_estado_producto', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='productos_bodega', to='dm_logistica.estadoproducto')),
                ('id_modelo_producto', models.ForeignKey(db_column='id_modelo_producto', on_delete=django.db.models.deletion.RESTRICT, related_name='productos_bodega', to='dm_logistica.modeloproducto')),
            ],
            options={
                'verbose_name': 'Producto en Bodega',
                'verbose_name_plural': 'Productos en Bodega',
                'db_table': '"dm_logistica"."producto_bodega"',
            },
        ),
        migrations.CreateModel(
            name='MovimientoBodega',
            fields=[
                ('id', models.AutoField(db_column='id_movimiento_bodega', primary_key=True, serialize=False)),
                ('id_ejecutivo_terreno', models.IntegerField(default=0)),
                ('estado', models.CharField(blank=True, max_length=15, null=True)),
                ('id_ejecutivo_recibe', models.IntegerField(default=0)),
                ('obs', models.CharField(blank=True, max_length=255, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_movimiento', models.ForeignKey(db_column='id_movimiento', on_delete=django.db.models.deletion.RESTRICT, related_name='movimientos_bodega', to='dm_logistica.movimiento')),
                ('id_producto_bodega', models.ForeignKey(blank=True, db_column='id_producto_bodega', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='movimientos_bodega', to='dm_logistica.productobodega')),
            ],
            options={
                'verbose_name': 'Movimiento Bodega',
                'verbose_name_plural': 'Movimientos Bodega',
                'db_table': '"dm_logistica"."movimiento_bodega"',
            },
        ),
        migrations.CreateModel(
            name='DetalleControlInventario',
            fields=[
                ('id', models.AutoField(db_column='id_detalle_control_inventario', primary_key=True, serialize=False)),
                ('serial', models.CharField(blank=True, max_length=100, null=True)),
                ('id_modelo_producto', models.IntegerField(blank=True, null=True)),
                ('estado_producto', models.CharField(blank=True, max_length=50, null=True)),
                ('cantidad_original', models.FloatField(blank=True, null=True)),
                ('cantidad_actual', models.FloatField(blank=True, null=True)),
                ('nombre_modelo', models.CharField(blank=True, max_length=100, null=True)),
                ('producto_seriado', models.SmallIntegerField(blank=True, null=True)),
                ('nombre_unidad_medida', models.CharField(blank=True, max_length=30, null=True)),
                ('nombre_serie', models.CharField(blank=True, max_length=45, null=True)),
                ('fecha', models.DateTimeField(blank=True, null=True)),
                ('fecha_verificacion', models.DateTimeField(blank=True, null=True)),
                ('id_operador_verificador', models.CharField(blank=True, max_length=50, null=True)),
                ('id_control_inventario', models.ForeignKey(db_column='id_control_inventario', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_inventario', to='dm_logistica.controlinventario')),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(blank=True, db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_inventario', to='operadores.operador')),
                ('id_estado_detalle_control_inventario', models.ForeignKey(db_column='id_estado_detalle_control_inventario', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_inventario', to='dm_logistica.estadodetallecontrolinventario')),
                ('id_producto_bodega', models.ForeignKey(db_column='id_producto_bodega', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_inventario', to='dm_logistica.productobodega')),
            ],
            options={
                'verbose_name': 'Detalle de Control de Inventario',
                'verbose_name_plural': 'Detalles de Control de Inventario',
                'db_table': '"dm_logistica"."detalle_control_inventario"',
            },
        ),
        migrations.CreateModel(
            name='AtributoDetalle',
            fields=[
                ('id', models.AutoField(db_column='id_atributo_detalle', primary_key=True, serialize=False)),
                ('valor', models.CharField(blank=True, max_length=255, null=True)),
                ('id_atributo', models.ForeignKey(db_column='id_atributo', on_delete=django.db.models.deletion.RESTRICT, related_name='atributos_detalles', to='dm_logistica.atributo')),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_producto_bodega', models.ForeignKey(db_column='id_producto_bodega', on_delete=django.db.models.deletion.RESTRICT, related_name='atributos_detalles', to='dm_logistica.productobodega')),
            ],
            options={
                'verbose_name': 'Detalle de Atributo',
                'verbose_name_plural': 'Detalles de Atributo',
                'db_table': '"dm_logistica"."atributo_detalle"',
            },
        ),
        migrations.CreateModel(
            name='Proveedor',
            fields=[
                ('id', models.AutoField(db_column='id_proveedor', primary_key=True, serialize=False)),
                ('descrip_giro', models.CharField(max_length=250)),
                ('rut', models.CharField(max_length=20)),
                ('nombre_rs', models.CharField(max_length=200)),
                ('nombre_fantasia', models.CharField(blank=True, max_length=200, null=True)),
                ('web', models.CharField(blank=True, max_length=50, null=True)),
                ('fecha_alta', models.DateTimeField(auto_now_add=True)),
                ('modalidad_pago', models.CharField(default='', max_length=50)),
                ('plazo_pago', models.IntegerField(blank=True, null=True)),
                ('estado', models.IntegerField(default=1)),
                ('direccion', models.CharField(blank=True, max_length=255, null=True)),
                ('id_comuna', models.IntegerField(blank=True, null=True)),
                ('id_region', models.IntegerField(blank=True, null=True)),
                ('proveedor_unico', models.SmallIntegerField(default=0)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_giro', models.ForeignKey(blank=True, db_column='id_giro', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='proveedores', to='dm_logistica.giro')),
            ],
            options={
                'verbose_name': 'Proveedor',
                'verbose_name_plural': 'Proveedores',
                'db_table': '"dm_logistica"."proveedor"',
            },
        ),
        migrations.AddField(
            model_name='ordencompra',
            name='id_proveedor',
            field=models.ForeignKey(blank=True, db_column='id_proveedor', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='orden_compra', to='dm_logistica.proveedor'),
        ),
        migrations.CreateModel(
            name='DetalleCotizacion',
            fields=[
                ('id', models.AutoField(db_column='id_detalle_cotizacion', primary_key=True, serialize=False)),
                ('fecha_registro', models.DateTimeField(default=django.utils.timezone.now)),
                ('cantidad', models.CharField(blank=True, max_length=50, null=True)),
                ('detalles', models.CharField(blank=True, max_length=255, null=True)),
                ('descuento_unitario', models.FloatField(blank=True, null=True)),
                ('precio_unitario', models.FloatField(blank=True, null=True)),
                ('id_modelo_producto', models.IntegerField(blank=True, null=True)),
                ('tipo_descuento', models.CharField(blank=True, max_length=5, null=True)),
                ('tipo_item', models.IntegerField(blank=True, null=True)),
                ('id_cotizacion', models.ForeignKey(db_column='id_cotizacion', on_delete=django.db.models.deletion.RESTRICT, related_name='detalle_cotizacion', to='dm_logistica.cotizacion')),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_proveedor', models.ForeignKey(db_column='id_proveedor', on_delete=django.db.models.deletion.RESTRICT, related_name='detalle_cotizacion', to='dm_logistica.proveedor')),
            ],
            options={
                'db_table': '"dm_logistica"."detalle_cotizacion"',
            },
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='id_proveedor',
            field=models.ForeignKey(db_column='id_proveedor', on_delete=django.db.models.deletion.RESTRICT, to='dm_logistica.proveedor'),
        ),
        migrations.CreateModel(
            name='ProveedorContactos',
            fields=[
                ('id', models.AutoField(db_column='id_proveedor_contacto', primary_key=True, serialize=False)),
                ('relacion_contacto', models.CharField(blank=True, max_length=50, null=True)),
                ('telefono_contacto', models.CharField(blank=True, max_length=20, null=True)),
                ('mail_contacto', models.CharField(blank=True, max_length=50, null=True)),
                ('id_proveedor', models.ForeignKey(db_column='id_proveedor', on_delete=django.db.models.deletion.RESTRICT, to='dm_logistica.proveedor')),
            ],
            options={
                'db_table': '"dm_logistica"."proveedor_contactos"',
            },
        ),
        migrations.CreateModel(
            name='ProveedorTelefono',
            fields=[
                ('id', models.AutoField(db_column='id_proveedor_telefono', primary_key=True, serialize=False)),
                ('tipo', models.CharField(choices=[('movil', 'Móvil'), ('fijo', 'Fijo'), ('trabajo', 'Trabajo'), ('otro', 'Otro')], max_length=20)),
                ('es_principal', models.BooleanField(default=False)),
                ('numero', models.CharField(max_length=15)),
                ('id_proveedor', models.ForeignKey(on_delete=django.db.models.deletion.RESTRICT, related_name='telefonosproveedor', to='dm_logistica.proveedor')),
            ],
            options={
                'db_table': '"dm_logistica"."proveedor_telefono"',
            },
        ),
        migrations.CreateModel(
            name='ServiciosBasicos',
            fields=[
                ('id', models.AutoField(db_column='id_servicio_basico', primary_key=True, serialize=False)),
                ('item_presupuesto', models.CharField(blank=True, max_length=6, null=True)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('observacion', models.TextField(blank=True, null=True)),
                ('id_punto_venta', models.IntegerField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(blank=True, db_column='id_operador', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='servicios_basicos', to='operadores.operador')),
                ('id_proveedor', models.ForeignKey(db_column='id_proveedor', on_delete=django.db.models.deletion.RESTRICT, related_name='servicios_basicos', to='dm_logistica.proveedor')),
            ],
            options={
                'verbose_name': 'Servicio Básico',
                'verbose_name_plural': 'Servicios Básicos',
                'db_table': '"dm_logistica"."servicios_basicos"',
            },
        ),
        migrations.CreateModel(
            name='ServiciosCajaChica',
            fields=[
                ('id', models.AutoField(db_column='id_servicio_caja_chica', primary_key=True, serialize=False)),
                ('monto', models.FloatField(blank=True, null=True)),
                ('id_operador_autoriza', models.CharField(max_length=50)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('fecha_autoriza', models.DateField(blank=True, null=True)),
                ('nota', models.TextField(blank=True, null=True)),
                ('estado', models.CharField(blank=True, max_length=50, null=True)),
                ('motivo_rechazo', models.TextField(blank=True, null=True)),
                ('archivo', models.CharField(blank=True, max_length=255, null=True)),
                ('id_parque', models.IntegerField(blank=True, null=True)),
                ('id_punto_venta', models.IntegerField(blank=True, null=True)),
                ('id_solicitante', models.CharField(blank=True, max_length=50, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='servicios_caja_chica_operador', to='operadores.operador')),
            ],
            options={
                'verbose_name': 'Servicio Caja Chica',
                'verbose_name_plural': 'Servicios Caja Chica',
                'db_table': '"dm_logistica"."servicios_caja_chica"',
            },
        ),
        migrations.CreateModel(
            name='ServiciosCajaChicaDetalle',
            fields=[
                ('id', models.AutoField(db_column='id_servicio_caja_chica_detalle', primary_key=True, serialize=False)),
                ('tipo_doc', models.CharField(blank=True, max_length=50, null=True)),
                ('fecha_emision', models.DateTimeField(blank=True, null=True)),
                ('razon_social', models.CharField(blank=True, max_length=50, null=True)),
                ('folio_dt', models.CharField(blank=True, max_length=50, null=True)),
                ('monto', models.FloatField(blank=True, null=True)),
                ('detalle', models.CharField(blank=True, max_length=255, null=True)),
                ('item_presupuesto', models.CharField(blank=True, max_length=10, null=True)),
                ('archivo', models.CharField(blank=True, max_length=255, null=True)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_operador', models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='servicios_caja_chica_detalle', to='operadores.operador')),
                ('id_servicio_caja_chica', models.ForeignKey(db_column='id_servicio_caja_chica', on_delete=django.db.models.deletion.RESTRICT, related_name='detalles_caja_chica', to='dm_logistica.servicioscajachica')),
            ],
            options={
                'verbose_name': 'Detalle de Servicio Caja Chica',
                'verbose_name_plural': 'Detalles de Servicio Caja Chica',
                'db_table': '"dm_logistica"."servicios_caja_chica_detalle"',
            },
        ),
        migrations.CreateModel(
            name='SolicitudCompra',
            fields=[
                ('id', models.AutoField(db_column='id_solicitud_compra', primary_key=True, serialize=False)),
                ('id_aprobador', models.CharField(default='', max_length=50)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('fecha_solicitud_compra', models.DateTimeField(blank=True, null=True)),
                ('titulo', models.CharField(blank=True, max_length=100, null=True)),
                ('ruta_file', models.CharField(blank=True, max_length=255, null=True)),
                ('cod_presupuesto', models.CharField(blank=True, max_length=10, null=True)),
                ('id_punto_venta', models.IntegerField(blank=True, null=True)),
                ('operador_rechazo', models.CharField(blank=True, max_length=50, null=True)),
                ('fecha_rechazo', models.DateTimeField(blank=True, null=True)),
                ('motivo_rechazo', models.TextField(blank=True, null=True)),
                ('id_requerimiento', models.IntegerField(blank=True, null=True)),
                ('id_empresa', models.ForeignKey(db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_estado_solicitud_compra', models.ForeignKey(db_column='id_estado_solicitud_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='solicitudes', to='dm_logistica.estadosolicitudcompra')),
                ('id_operador', models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='solicitudes', to='operadores.operador')),
                ('id_tipo_solicitud', models.ForeignKey(db_column='id_tipo_solicitud', on_delete=django.db.models.deletion.RESTRICT, related_name='solicitudes', to='dm_logistica.tiposolicitud')),
            ],
            options={
                'verbose_name': 'Solicitud de Compra',
                'verbose_name_plural': 'Solicitudes de Compra',
                'db_table': '"dm_logistica"."solicitud_compra"',
            },
        ),
        migrations.AddField(
            model_name='ordencompra',
            name='id_solicitud_compra',
            field=models.ForeignKey(db_column='id_solicitud_compra', on_delete=django.db.models.deletion.RESTRICT, related_name='orden_compra', to='dm_logistica.solicitudcompra'),
        ),
        migrations.AddField(
            model_name='cotizacion',
            name='id_solicitud_compra',
            field=models.ForeignKey(blank=True, db_column='id_solicitud_compra', null=True, on_delete=django.db.models.deletion.RESTRICT, to='dm_logistica.solicitudcompra'),
        ),
        migrations.CreateModel(
            name='TipoMarcaProducto',
            fields=[
                ('id', models.AutoField(db_column='id_tipo_marca_producto', primary_key=True, serialize=False)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
                ('id_marca_producto', models.ForeignKey(db_column='id_marca_producto', on_delete=django.db.models.deletion.RESTRICT, related_name='tipos_marca_productos', to='dm_logistica.marcaproducto')),
            ],
            options={
                'verbose_name': 'Tipo Marca Producto',
                'verbose_name_plural': 'Tipos Marca Producto',
                'db_table': '"dm_logistica"."tipo_marca_producto"',
            },
        ),
        migrations.AddField(
            model_name='modeloproducto',
            name='id_tipo_marca_producto',
            field=models.ForeignKey(db_column='id_tipo_marca_producto', on_delete=django.db.models.deletion.RESTRICT, related_name='modelos', to='dm_logistica.tipomarcaproducto'),
        ),
        migrations.CreateModel(
            name='TipoProducto',
            fields=[
                ('id', models.AutoField(db_column='id_tipo_producto', primary_key=True, serialize=False)),
                ('codigo_tipo_producto', models.CharField(blank=True, max_length=255, null=True)),
                ('tipo_producto', models.CharField(max_length=100)),
                ('estado', models.SmallIntegerField(default=1)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa')),
            ],
            options={
                'verbose_name': 'Tipo de Producto',
                'verbose_name_plural': 'Tipos de Producto',
                'db_table': '"dm_logistica"."tipo_producto"',
            },
        ),
        migrations.AddField(
            model_name='tipomarcaproducto',
            name='id_tipo_producto',
            field=models.ForeignKey(db_column='id_tipo_producto', on_delete=django.db.models.deletion.RESTRICT, related_name='tipos_marca_productos', to='dm_logistica.tipoproducto'),
        ),
        migrations.AddField(
            model_name='modeloproducto',
            name='id_unidad_medida',
            field=models.ForeignKey(db_column='id_unidad_medida', on_delete=django.db.models.deletion.RESTRICT, related_name='modelos', to='dm_logistica.unidadmedida'),
        ),
        migrations.AddIndex(
            model_name='atributo',
            index=models.Index(fields=['id_modelo_producto'], name='fk_atributo_modelo_producto'),
        ),
        migrations.AddIndex(
            model_name='atributo',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_atributo'),
        ),
        migrations.AddIndex(
            model_name='bodegastock',
            index=models.Index(fields=['id_bodega'], name='fk_bodg_stbdga'),
        ),
        migrations.AddIndex(
            model_name='bodegastock',
            index=models.Index(fields=['id_modelo_producto'], name='fk_bodg_st_modprod'),
        ),
        migrations.AddIndex(
            model_name='bodegastock',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_bodg_stk'),
        ),
        migrations.AddIndex(
            model_name='bodegastock',
            index=models.Index(fields=['id_grupo'], name='fk_id_grbdega_stock'),
        ),
        migrations.AddConstraint(
            model_name='bodegastock',
            constraint=models.UniqueConstraint(
                # ⚠️  CORREGIDO: quitar 'id_bodega_stock'
                fields=('id_modelo_producto', 'id_bodega'),
                name='bodega_stock_unique_compound',
            ),
        ),
        migrations.AddIndex(
            model_name='bodega',
            index=models.Index(fields=['estado_bodega'], name='fk_bodg_ebg'),
        ),
        migrations.AddIndex(
            model_name='bodega',
            index=models.Index(fields=['id_bodega_tipo'], name='idx_bodg_tbdg'),
        ),
        migrations.AddIndex(
            model_name='bodega',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_bodg'),
        ),
        migrations.AddIndex(
            model_name='giro',
            index=models.Index(fields=['id'], name='fk_giro_proveedor1_idx'),
        ),
        migrations.AddIndex(
            model_name='giro',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_giro'),
        ),
        migrations.AlterUniqueTogether(
            name='giro',
            unique_together={('id', 'descrip_giro')},
        ),
        migrations.AddIndex(
            model_name='marcaproducto',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_marca_producto'),
        ),
        migrations.AddIndex(
            model_name='modeloproductovalores',
            index=models.Index(fields=['id_modelo_producto'], name='idx_id_modelo_producto'),
        ),
        migrations.AddIndex(
            model_name='modeloproductovalores',
            index=models.Index(fields=['id_empresa'], name='idx_id_empresa'),
        ),
        migrations.AddIndex(
            model_name='movimiento',
            index=models.Index(fields=['id_bodega'], name='fk_movi_bdga'),
        ),
        migrations.AddIndex(
            model_name='movimiento',
            index=models.Index(fields=['tipo_movimiento'], name='idx_movi_tp_mov'),
        ),
        migrations.AddIndex(
            model_name='movimiento',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_movi'),
        ),
        migrations.AddIndex(
            model_name='movimiento',
            index=models.Index(fields=['id_receptor'], name='id_receptor'),
        ),
        migrations.AddIndex(
            model_name='movimiento',
            index=models.Index(fields=['fecha_registro'], name='fecha_registro'),
        ),
        migrations.AddIndex(
            model_name='detallecompra',
            index=models.Index(fields=['id_orden_compra'], name='fk_det_comp_orc'),
        ),
        migrations.AddIndex(
            model_name='detallecompra',
            index=models.Index(fields=['id_modelo_producto'], name='det_comp_modp'),
        ),
        migrations.AddIndex(
            model_name='detallecompra',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_det_comp'),
        ),
        migrations.AddIndex(
            model_name='procesocomparacion',
            index=models.Index(fields=['id_orden_compra'], name='fk_proc_comp_ord_comp'),
        ),
        migrations.AddIndex(
            model_name='procesocomparacion',
            index=models.Index(fields=['id_operador'], name='fk_proc_comp_op'),
        ),
        migrations.AddIndex(
            model_name='procesocomparacion',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_proc_comp'),
        ),
        migrations.AddIndex(
            model_name='ajustedetallecompra',
            index=models.Index(fields=['id_detalle_compra'], name='fk_aj_det_compdc'),
        ),
        migrations.AddIndex(
            model_name='ajustedetallecompra',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_ajdcomp'),
        ),
        migrations.AddIndex(
            model_name='ajustedetallecompra',
            index=models.Index(fields=['id_proceso_comparacion'], name='fk_id_pc_ajdcomp'),
        ),
        migrations.AddIndex(
            model_name='ajustedetallecompra',
            index=models.Index(fields=['id_orden_compra'], name='fk_id_oc_ajdcomp'),
        ),
        migrations.AddIndex(
            model_name='productobodega',
            index=models.Index(fields=['id_bodega'], name='fk_prod_bod_bod'),
        ),
        migrations.AddIndex(
            model_name='productobodega',
            index=models.Index(fields=['id_modelo_producto'], name='fk_prod_bod_modprod'),
        ),
        migrations.AddIndex(
            model_name='productobodega',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_prod_bod'),
        ),
        migrations.AddIndex(
            model_name='productobodega',
            index=models.Index(fields=['id_estado_producto'], name='fk_id_est_prod_bod'),
        ),
        migrations.AddIndex(
            model_name='movimientobodega',
            index=models.Index(fields=['id_movimiento'], name='fk_movi_bodga_movi'),
        ),
        migrations.AddIndex(
            model_name='movimientobodega',
            index=models.Index(fields=['id_producto_bodega'], name='fk_movi_bdg_prod_bodga'),
        ),
        migrations.AddIndex(
            model_name='movimientobodega',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_mov_bodega'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_control_inventario'], name='fk_cot_invent_dci'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_producto_bodega'], name='fk_id_prod_bdg_dci'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_estado_detalle_control_inventario'], name='fk_id_est_det_cont_dci'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_cont_invent_dci'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_operador'], name='fk_id_op_cont_invent_dci'),
        ),
        migrations.AddIndex(
            model_name='detallecontrolinventario',
            index=models.Index(fields=['id_modelo_producto'], name='fk_id_mod_prod_dci'),
        ),
        migrations.AddIndex(
            model_name='atributodetalle',
            index=models.Index(fields=['id_atributo'], name='fk_at_d_at'),
        ),
        migrations.AddIndex(
            model_name='atributodetalle',
            index=models.Index(fields=['valor'], name='idx_valor'),
        ),
        migrations.AddIndex(
            model_name='atributodetalle',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_at_det'),
        ),
        migrations.AddIndex(
            model_name='atributodetalle',
            index=models.Index(fields=['id_producto_bodega'], name='fk_id_p_bod_atd'),
        ),
        migrations.AddIndex(
            model_name='proveedor',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_proveedor'),
        ),
        migrations.AddIndex(
            model_name='proveedor',
            index=models.Index(fields=['id_giro'], name='fk_id_giro_proveedor'),
        ),
        migrations.AddIndex(
            model_name='detallecotizacion',
            index=models.Index(fields=['id_modelo_producto'], name='mod_prod_det_cot'),
        ),
        migrations.AddIndex(
            model_name='detallecotizacion',
            index=models.Index(fields=['id_cotizacion'], name='fk_cot_det_cot'),
        ),
        migrations.AddIndex(
            model_name='detallecotizacion',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_det_cot'),
        ),
        migrations.AddIndex(
            model_name='detallecotizacion',
            index=models.Index(fields=['id_proveedor'], name='fk_id_proveedor_det_cot'),
        ),
        migrations.AddIndex(
            model_name='proveedorcontactos',
            index=models.Index(fields=['id_proveedor'], name='fk_provcon_prov'),
        ),
        migrations.AddIndex(
            model_name='proveedorcontactos',
            index=models.Index(fields=['id_proveedor', 'relacion_contacto'], name='proveedor_c_id_prov_4314f0_idx'),
        ),
        migrations.AddIndex(
            model_name='proveedortelefono',
            index=models.Index(fields=['es_principal'], name='fk_esprvtel'),
        ),
        migrations.AddIndex(
            model_name='proveedortelefono',
            index=models.Index(fields=['tipo'], name='fk_tipo_proveedor_telefono'),
        ),
        migrations.AddIndex(
            model_name='serviciosbasicos',
            index=models.Index(fields=['id_empresa'], name='fk_emp_servbas'),
        ),
        migrations.AddIndex(
            model_name='serviciosbasicos',
            index=models.Index(fields=['id_operador'], name='fk_op_servbas'),
        ),
        migrations.AddIndex(
            model_name='serviciosbasicos',
            index=models.Index(fields=['id_proveedor'], name='fk_prov_servbas'),
        ),
        migrations.AddIndex(
            model_name='serviciosbasicos',
            index=models.Index(fields=['id_punto_venta'], name='fk_pv_servbas'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachica',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachica',
            index=models.Index(fields=['estado'], name='estado'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachica',
            index=models.Index(fields=['id_punto_venta'], name='id_punto_venta'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachica',
            index=models.Index(fields=['fecha_autoriza'], name='fecha_autoriza'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachica',
            index=models.Index(fields=['id_operador'], name='fk_op_servcaja'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachicadetalle',
            index=models.Index(fields=['id_servicio_caja_chica'], name='fk_servcajadet'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachicadetalle',
            index=models.Index(fields=['id_empresa'], name='fk_emp_scchdt'),
        ),
        migrations.AddIndex(
            model_name='servicioscajachicadetalle',
            index=models.Index(fields=['id_operador'], name='fk_op_scchdt'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_operador'], name='fk_orden_comp_op'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_solicitud_compra'], name='fk_orden_compra_sol_com'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_cotizacion'], name='fk_orden_comp_cot'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_estado_orden_compra'], name='fk_orden_comp_est_or_comp'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_ord_comp'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_proveedor'], name='fk_id_prov_ord_comp'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['id_solicitante'], name='id_solicitante'),
        ),
        migrations.AddIndex(
            model_name='ordencompra',
            index=models.Index(fields=['folio'], name='folio'),
        ),
        migrations.AddIndex(
            model_name='cotizacion',
            index=models.Index(fields=['id_proveedor'], name='fk_cot_proveedor1_idx'),
        ),
        migrations.AddIndex(
            model_name='cotizacion',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_cot'),
        ),
        migrations.AddIndex(
            model_name='cotizacion',
            index=models.Index(fields=['id_solicitud_compra'], name='fk_id_sc_cot'),
        ),
        migrations.AddIndex(
            model_name='cotizacion',
            index=models.Index(fields=['id_operador'], name='fk_id_op_cot'),
        ),
        migrations.AddIndex(
            model_name='controlinventario',
            index=models.Index(fields=['id_estado_control_inventario'], name='fk_id_estcinv'),
        ),
        migrations.AddIndex(
            model_name='controlinventario',
            index=models.Index(fields=['id_tipo_control_inventario'], name='fk_id_tipo_cont_inv'),
        ),
        migrations.AddIndex(
            model_name='controlinventario',
            index=models.Index(fields=['id_bodega'], name='fk_id_bodega'),
        ),
        migrations.AddIndex(
            model_name='controlinventario',
            index=models.Index(fields=['id_empresa'], name='fk_id_emp_cont_invt'),
        ),
        migrations.AddIndex(
            model_name='controlinventario',
            index=models.Index(fields=['id_operador'], name='fk_id_op_cont_invt'),
        ),
        migrations.AddIndex(
            model_name='tipoproducto',
            index=models.Index(fields=['tipo_producto'], name='idx_tipo_producto'),
        ),
        migrations.AddIndex(
            model_name='tipoproducto',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_tipo_producto'),
        ),
        migrations.AddIndex(
            model_name='tipomarcaproducto',
            index=models.Index(fields=['id_marca_producto'], name='fk_tmp_marc'),
        ),
        migrations.AddIndex(
            model_name='tipomarcaproducto',
            index=models.Index(fields=['id_empresa'], name='fk_tmp_emp'),
        ),
        migrations.AlterUniqueTogether(
            name='tipomarcaproducto',
            unique_together={('id', 'id_marca_producto')},
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_operador'], name='fk_solic_comp_op'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_empresa'], name='fk_solic_comp_emp'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_estado_solicitud_compra'], name='fk_solic_comp_esomp'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_tipo_solicitud'], name='id_tip_sol_sc'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['cod_presupuesto'], name='cod_pres_sc'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_punto_venta'], name='id_punto_venta_sc'),
        ),
        migrations.AddIndex(
            model_name='solicitudcompra',
            index=models.Index(fields=['id_requerimiento'], name='id_requerimiento_sc'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['id_identificador_serie'], name='fk_modprod_idser'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['id_tipo_marca_producto'], name='fk_modprod_tpmar'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['numero_parte'], name='idx_numero_parte'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['id_unidad_medida'], name='fk_modprod_unimed'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['nombre_modelo'], name='idx_nombre_modelo'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['id_empresa'], name='fk_id_empresa_modelo_producto'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['sku'], name='sku_idx'),
        ),
        migrations.AddIndex(
            model_name='modeloproducto',
            index=models.Index(fields=['sku_codigo'], name='sku_codigo_idx'),
        ),
    ]


=== ./dm_logistica/views.py ===
from django.shortcuts import render

# Create your views here.


=== ./dm_logistica/models.py ===
# ./dm_logistica/models.py
# -----------------------------------------------------------------------------
#  IMPORTS
# -----------------------------------------------------------------------------
from django.db import models
from django.utils import timezone

# -----------------------------------------------------------------------------
# 1) ESTADOS, TIPOS Y ENTIDADES BASE
# -----------------------------------------------------------------------------
class EstadoProducto(models.Model):
    """
    Equivale a dm_logistica.estado_producto
    """
    id = models.AutoField(primary_key=True, db_column="id_estado_producto")
    estado_producto = models.CharField(max_length=50)

    class Meta:
        db_table = '"dm_logistica"."estado_producto"'
        verbose_name = "Estado de Producto"
        verbose_name_plural = "Estados de Producto"

    def __str__(self):
        return self.estado_producto


class EstadoControlInventario(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_estado_control_inventario")
    detalle = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."estado_control_inventario"'
        verbose_name = "Estado Control de Inventario"
        verbose_name_plural = "Estados Control de Inventario"


class EstadoDetalleControlInventario(models.Model):
    id = models.AutoField(
        primary_key=True, db_column="id_estado_detalle_control_inventario"
    )
    descripcion = models.CharField(max_length=45, null=True, blank=True)
    boton = models.SmallIntegerField(null=True, blank=True)
    dboton = models.CharField(max_length=15, null=True, blank=True)
    icon = models.CharField(max_length=20, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."estado_detalle_control_inventario"'
        verbose_name = "Estado Detalle de Control de Inventario"
        verbose_name_plural = "Estados Detalle de Control de Inventario"


class TipoControlInventario(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_tipo_control_inventario")
    detalle = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."tipo_control_inventario"'
        verbose_name = "Tipo de Control de Inventario"
        verbose_name_plural = "Tipos de Control de Inventario"


# -----------------------------------------------------------------------------
# 2) BODEGAS
# -----------------------------------------------------------------------------
class BodegaTipo(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_bodega_tipo")
    tipo_bodega = models.CharField(max_length=50, unique=True, default="")

    class Meta:
        db_table = '"dm_logistica"."bodega_tipo"'
        verbose_name = "Tipo de Bodega"


class Bodega(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_bodega")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        default=0,
    )
    estado_bodega = models.PositiveIntegerField(default=0)
    nombre_bodega = models.CharField(max_length=100)
    id_bodega_tipo = models.ForeignKey(
        "BodegaTipo",
        on_delete=models.RESTRICT,
        db_column="id_bodega_tipo",
        related_name="bodega",
    )

    class Meta:
        db_table = '"dm_logistica"."bodega"'
        verbose_name = "Bodega"
        verbose_name_plural = "Bodegas"
        indexes = [
            models.Index(fields=["estado_bodega"], name="fk_bodg_ebg"),
            models.Index(fields=["id_bodega_tipo"], name="idx_bodg_tbdg"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_bodg"),
        ]

    def __str__(self):
        return f"Bodega {self.id} - {self.nombre_bodega}"


class BodegaStock(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_bodega_stock")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        default=0,
    )
    id_bodega = models.ForeignKey(
        Bodega,
        on_delete=models.RESTRICT,
        db_column="id_bodega",
        related_name="bodega_stock",
    )
    id_modelo_producto = models.IntegerField()
    stock_critico = models.IntegerField(null=True, blank=True)
    porc_alarma = models.IntegerField(null=True, blank=True)
    alarma = models.SmallIntegerField(null=True, blank=True)
    id_grupo = models.ForeignKey(
        "coreempresas.Grupo",
        on_delete=models.RESTRICT,
        db_column="id_grupo",
        related_name="bodega_stock",
    )

    class Meta:
        db_table = '"dm_logistica"."bodega_stock"'
        verbose_name = "Stock en Bodega"
        verbose_name_plural = "Stocks en Bodega"
        indexes = [
            models.Index(fields=["id_bodega"], name="fk_bodg_stbdga"),
            models.Index(fields=["id_modelo_producto"], name="fk_bodg_st_modprod"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_bodg_stk"),
            models.Index(fields=["id_grupo"], name="fk_id_grbdega_stock"),
        ]
        # ------------------------------------------------------------------
        #  ⚠️  RESTRICCIÓN CORREGIDA:
        #  Antes incluía 'id_bodega_stock', que no existe como campo de modelo.
        # ------------------------------------------------------------------
        constraints = [
            models.UniqueConstraint(
                fields=["id_modelo_producto", "id_bodega"],
                name="bodega_stock_unique_compound",
            )
        ]


# -----------------------------------------------------------------------------
# 3) CONTROL DE INVENTARIO
# -----------------------------------------------------------------------------
class ControlInventario(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_control_inventario")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    fecha = models.DateTimeField(null=True, blank=True)
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="control_inventario",
        null=True,
    )
    id_bodega = models.ForeignKey(
        Bodega,
        on_delete=models.RESTRICT,
        db_column="id_bodega",
        related_name="control_inventario",
    )
    id_estado_control_inventario = models.ForeignKey(
        "EstadoControlInventario",
        on_delete=models.RESTRICT,
        db_column="id_estado_control_inventario",
        related_name="control_inventario",
        null=True,
    )
    id_tipo_control_inventario = models.ForeignKey(
        "TipoControlInventario",
        on_delete=models.RESTRICT,
        db_column="id_tipo_control",
        related_name="control_inventario",
        null=True,
    )
    fecha_termino = models.DateTimeField(null=True, blank=True)
    observaciones = models.TextField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."control_inventario"'
        verbose_name = "Control de Inventario"
        verbose_name_plural = "Controles de Inventario"
        indexes = [
            models.Index(fields=["id_estado_control_inventario"], name="fk_id_estcinv"),
            models.Index(fields=["id_tipo_control_inventario"], name="fk_id_tipo_cont_inv"),
            models.Index(fields=["id_bodega"], name="fk_id_bodega"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_cont_invt"),
            models.Index(fields=["id_operador"], name="fk_id_op_cont_invt"),
        ]


class DetalleControlInventario(models.Model):
    id = models.AutoField(
        primary_key=True, db_column="id_detalle_control_inventario"
    )
    id_control_inventario = models.ForeignKey(
        ControlInventario,
        on_delete=models.RESTRICT,
        db_column="id_control_inventario",
        related_name="detalles_inventario",
        null=True,
    )
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_producto_bodega = models.ForeignKey(
        "ProductoBodega",
        on_delete=models.RESTRICT,
        db_column="id_producto_bodega",
        related_name="detalles_inventario",
        null=True,
    )
    id_estado_detalle_control_inventario = models.ForeignKey(
        "EstadoDetalleControlInventario",
        on_delete=models.RESTRICT,
        db_column="id_estado_detalle_control_inventario",
        related_name="detalles_inventario",
        null=True,
    )
    serial = models.CharField(max_length=100, null=True, blank=True)
    id_modelo_producto = models.IntegerField(null=True, blank=True)
    estado_producto = models.CharField(max_length=50, null=True, blank=True)
    cantidad_original = models.FloatField(null=True, blank=True)
    cantidad_actual = models.FloatField(null=True, blank=True)
    nombre_modelo = models.CharField(max_length=100, null=True, blank=True)
    producto_seriado = models.SmallIntegerField(null=True, blank=True)
    nombre_unidad_medida = models.CharField(max_length=30, null=True, blank=True)
    nombre_serie = models.CharField(max_length=45, null=True, blank=True)
    fecha = models.DateTimeField(null=True, blank=True)
    fecha_verificacion = models.DateTimeField(null=True, blank=True)
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="detalles_inventario",
        null=True,
        blank=True,
    )
    id_operador_verificador = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."detalle_control_inventario"'
        verbose_name = "Detalle de Control de Inventario"
        verbose_name_plural = "Detalles de Control de Inventario"
        indexes = [
            models.Index(fields=["id_control_inventario"], name="fk_cot_invent_dci"),
            models.Index(fields=["id_producto_bodega"], name="fk_id_prod_bdg_dci"),
            models.Index(
                fields=["id_estado_detalle_control_inventario"], name="fk_id_est_det_cont_dci"
            ),
            models.Index(fields=["id_empresa"], name="fk_id_emp_cont_invent_dci"),
            models.Index(fields=["id_operador"], name="fk_id_op_cont_invent_dci"),
            models.Index(fields=["id_modelo_producto"], name="fk_id_mod_prod_dci"),
        ]


# -----------------------------------------------------------------------------
# 4) MOVIMIENTOS
# -----------------------------------------------------------------------------
class Movimiento(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_movimiento")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    folio = models.CharField(max_length=9, null=True, blank=True)
    operador_emision = models.CharField(max_length=50, null=True, blank=True)
    operador_destino = models.CharField(max_length=50, default="", blank=True)
    observacion = models.TextField(null=True, blank=True)
    id_bodega = models.ForeignKey(
        Bodega, on_delete=models.RESTRICT, db_column="id_bodega", related_name="movimientos"
    )
    fecha_registro = models.DateTimeField(auto_now_add=True)
    tipo_movimiento = models.CharField(max_length=50, default="MOVIMIENTO")
    id_bodega_origen = models.IntegerField()
    id_despachador = models.IntegerField(default=0)
    id_receptor = models.IntegerField(default=0)
    id_punto_venta = models.IntegerField(default=0)
    pdf = models.CharField(max_length=255, null=True, blank=True)
    folio_comprobante = models.CharField(max_length=32, default="0")
    fecha_actualizacion = models.DateTimeField(null=True, blank=True)
    id_requerimiento = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."movimiento"'
        verbose_name = "Movimiento"
        verbose_name_plural = "Movimientos"
        indexes = [
            models.Index(fields=["id_bodega"], name="fk_movi_bdga"),
            models.Index(fields=["tipo_movimiento"], name="idx_movi_tp_mov"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_movi"),
            models.Index(fields=["id_receptor"], name="id_receptor"),
            models.Index(fields=["fecha_registro"], name="fecha_registro"),
        ]


class MovimientoBodega(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_movimiento_bodega")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_movimiento = models.ForeignKey(
        Movimiento,
        on_delete=models.RESTRICT,
        db_column="id_movimiento",
        related_name="movimientos_bodega",
    )
    id_producto_bodega = models.ForeignKey(
        "ProductoBodega",
        on_delete=models.RESTRICT,
        db_column="id_producto_bodega",
        related_name="movimientos_bodega",
        null=True,
        blank=True,
    )
    id_ejecutivo_terreno = models.IntegerField(default=0)
    estado = models.CharField(max_length=15, null=True, blank=True)
    id_ejecutivo_recibe = models.IntegerField(default=0)
    obs = models.CharField(max_length=255, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."movimiento_bodega"'
        verbose_name = "Movimiento Bodega"
        verbose_name_plural = "Movimientos Bodega"
        indexes = [
            models.Index(fields=["id_movimiento"], name="fk_movi_bodga_movi"),
            models.Index(fields=["id_producto_bodega"], name="fk_movi_bdg_prod_bodga"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_mov_bodega"),
        ]


# -----------------------------------------------------------------------------
# 5) PRODUCTOS, TIPOS Y ATRIBUTOS
# -----------------------------------------------------------------------------


class UnidadMedida(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_unidad_medida")
    nombre_unidad_medida = models.CharField(max_length=30, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."unidad_medida"'
        verbose_name = "Unidad de Medida"
        verbose_name_plural = "Unidades de Medida"

    def __str__(self):
        return self.nombre_unidad_medida or f"Unidad {self.id}"


class IdentificadorSerie(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_identificador_serie")
    nombre_serie = models.CharField(max_length=45)
    estado_serie = models.IntegerField(default=1)

    class Meta:
        db_table = '"dm_logistica"."identificador_serie"'
        verbose_name = "Identificador de Serie"
        verbose_name_plural = "Identificadores de Serie"

    def __str__(self):
        return self.nombre_serie


class TipoProducto(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_tipo_producto")
    codigo_tipo_producto = models.CharField(max_length=255, null=True, blank=True)
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    tipo_producto = models.CharField(max_length=100)
    estado = models.SmallIntegerField(default=1)

    class Meta:
        db_table = '"dm_logistica"."tipo_producto"'
        verbose_name = "Tipo de Producto"
        verbose_name_plural = "Tipos de Producto"
        indexes = [
            models.Index(fields=["tipo_producto"], name="idx_tipo_producto"),
            models.Index(fields=["id_empresa"], name="fk_id_empresa_tipo_producto"),
        ]

    def __str__(self):
        return self.tipo_producto


class MarcaProducto(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_marca_producto")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    marca_producto = models.CharField(max_length=50)
    estado = models.IntegerField(default=1)

    class Meta:
        db_table = '"dm_logistica"."marca_producto"'
        verbose_name = "Marca de Producto"
        verbose_name_plural = "Marcas de Producto"
        indexes = [
            models.Index(fields=["id_empresa"], name="fk_id_empresa_marca_producto"),
        ]

    def __str__(self):
        return self.marca_producto


class TipoMarcaProducto(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_tipo_marca_producto")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_tipo_producto = models.ForeignKey(
        TipoProducto,
        on_delete=models.RESTRICT,
        db_column="id_tipo_producto",
        related_name="tipos_marca_productos",
    )
    id_marca_producto = models.ForeignKey(
        MarcaProducto,
        on_delete=models.RESTRICT,
        db_column="id_marca_producto",
        related_name="tipos_marca_productos",
    )

    class Meta:
        db_table = '"dm_logistica"."tipo_marca_producto"'
        verbose_name = "Tipo Marca Producto"
        verbose_name_plural = "Tipos Marca Producto"
        unique_together = (("id", "id_marca_producto"),)
        indexes = [
            models.Index(fields=["id_marca_producto"], name="fk_tmp_marc"),
            models.Index(fields=["id_empresa"], name="fk_tmp_emp"),
        ]

    def __str__(self):
        return f"{self.id_tipo_producto} - {self.id_marca_producto}"


class ModeloProducto(models.Model):
    id_modelo_producto = models.IntegerField(default=0, unique=True)
    codigo_interno = models.CharField(max_length=50, null=True, blank=True)
    fccid = models.CharField(max_length=50, null=True, blank=True)
    sku = models.CharField(max_length=255, null=True, blank=True)
    sku_codigo = models.CharField(max_length=255, null=True, blank=True)
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_tipo_marca_producto = models.ForeignKey(
        TipoMarcaProducto,
        on_delete=models.RESTRICT,
        db_column="id_tipo_marca_producto",
        related_name="modelos",
    )
    id_identificador_serie = models.ForeignKey(
        IdentificadorSerie,
        on_delete=models.RESTRICT,
        db_column="id_identificador_serie",
        related_name="modelos",
    )
    id_unidad_medida = models.ForeignKey(
        UnidadMedida,
        on_delete=models.RESTRICT,
        db_column="id_unidad_medida",
        related_name="modelos",
    )
    nombre_modelo = models.CharField(max_length=100)
    descripcion = models.TextField(null=True, blank=True)
    imagen = models.CharField(max_length=200, null=True, blank=True)
    estado = models.IntegerField(default=1)
    numero_parte = models.CharField(max_length=100)
    producto_seriado = models.SmallIntegerField(default=1)
    nombre_comercial = models.CharField(max_length=255, null=True, blank=True)
    nombre_tecnico = models.CharField(max_length=255, null=True, blank=True)
    so = models.CharField(max_length=100, null=True, blank=True)
    vso = models.CharField(max_length=100, null=True, blank=True)
    version_hw = models.CharField(max_length=100, null=True, blank=True)
    vspc = models.CharField(max_length=100, null=True, blank=True)
    vspf = models.CharField(max_length=100, null=True, blank=True)
    fabricante = models.CharField(max_length=255, null=True, blank=True)
    ubicacion = models.CharField(max_length=255, null=True, blank=True)
    despacho_express = models.SmallIntegerField(default=0)
    rebaja_consumo = models.IntegerField(default=0)
    dias_rebaja_consumo = models.IntegerField(null=True, blank=True)
    orden_solicitud_despacho = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."modelo_producto"'
        verbose_name = "Modelo de Producto"
        verbose_name_plural = "Modelos de Producto"
        indexes = [
            models.Index(fields=["id_identificador_serie"], name="fk_modprod_idser"),
            models.Index(fields=["id_tipo_marca_producto"], name="fk_modprod_tpmar"),
            models.Index(fields=["numero_parte"], name="idx_numero_parte"),
            models.Index(fields=["id_unidad_medida"], name="fk_modprod_unimed"),
            models.Index(fields=["nombre_modelo"], name="idx_nombre_modelo"),
            models.Index(fields=["id_empresa"], name="fk_id_empresa_modelo_producto"),
            models.Index(fields=["sku"], name="sku_idx"),
            models.Index(fields=["sku_codigo"], name="sku_codigo_idx"),
        ]

    def __str__(self):
        return self.nombre_modelo


class ModeloProductoValores(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_modelo_producto_valor")
    id_modelo_producto = models.IntegerField(default=0)
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    valor_cliente = models.IntegerField(null=True, blank=True)
    valor_publico = models.IntegerField(null=True, blank=True)
    margen = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."modelo_producto_valores"'
        verbose_name = "Valor de Modelo de Producto"
        verbose_name_plural = "Valores de Modelos de Producto"
        indexes = [
            models.Index(fields=["id_modelo_producto"], name="idx_id_modelo_producto"),
            models.Index(fields=["id_empresa"], name="idx_id_empresa"),
        ]

    def __str__(self):
        return f"Valor para modelo {self.id_modelo_producto}"


# -------------------------------------------------------------------------
#  NUEVO: ProductoBodega
# -------------------------------------------------------------------------
class ProductoBodega(models.Model):
    """
    Registro individual (o por lote) de un modelo de producto almacenado
    en una bodega determinada.
    Sirve de nexo para movimientos, controles de inventario y atributos.
    """
    id = models.AutoField(primary_key=True, db_column="id_producto_bodega")

    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
        related_name="productos_bodega",
    )
    id_bodega = models.ForeignKey(
        Bodega,
        on_delete=models.RESTRICT,
        db_column="id_bodega",
        related_name="productos_bodega",
    )
    id_modelo_producto = models.ForeignKey(
        ModeloProducto,
        on_delete=models.RESTRICT,
        db_column="id_modelo_producto",
        related_name="productos_bodega",
    )
    serial = models.CharField(max_length=100, null=True, blank=True)
    cantidad = models.FloatField(null=True, blank=True)
    id_estado_producto = models.ForeignKey(
        EstadoProducto,
        on_delete=models.RESTRICT,
        db_column="id_estado_producto",
        related_name="productos_bodega",
        null=True,
        blank=True,
    )
    fecha_registro = models.DateTimeField(default=timezone.now)

    class Meta:
        db_table = '"dm_logistica"."producto_bodega"'
        verbose_name = "Producto en Bodega"
        verbose_name_plural = "Productos en Bodega"
        indexes = [
            models.Index(fields=["id_bodega"], name="fk_prod_bod_bod"),
            models.Index(fields=["id_modelo_producto"], name="fk_prod_bod_modprod"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_prod_bod"),
            models.Index(fields=["id_estado_producto"], name="fk_id_est_prod_bod"),
        ]

    def __str__(self):
        return f"ProductoBodega {self.id}"


class Atributo(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_atributo")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_modelo_producto = models.IntegerField(default=0)
    nombre_atributo = models.CharField(max_length=100)

    class Meta:
        db_table = '"dm_logistica"."atributo"'
        verbose_name = "Atributo"
        verbose_name_plural = "Atributos"
        indexes = [
            models.Index(fields=["id_modelo_producto"], name="fk_atributo_modelo_producto"),
            models.Index(fields=["id_empresa"], name="fk_id_empresa_atributo"),
        ]

    def __str__(self):
        return self.nombre_atributo


class AtributoDetalle(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_atributo_detalle")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_producto_bodega = models.ForeignKey(
        "ProductoBodega",
        on_delete=models.RESTRICT,
        db_column="id_producto_bodega",
        related_name="atributos_detalles",
    )
    id_atributo = models.ForeignKey(
        Atributo,
        on_delete=models.RESTRICT,
        db_column="id_atributo",
        related_name="atributos_detalles",
    )
    valor = models.CharField(max_length=255, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."atributo_detalle"'
        verbose_name = "Detalle de Atributo"
        verbose_name_plural = "Detalles de Atributo"
        indexes = [
            models.Index(fields=["id_atributo"], name="fk_at_d_at"),
            models.Index(fields=["valor"], name="idx_valor"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_at_det"),
            models.Index(fields=["id_producto_bodega"], name="fk_id_p_bod_atd"),
        ]

    def __str__(self):
        return f"{self.id_atributo} = {self.valor}"

# -----------------------------------------------------------------------------
# 6) COMPRAS
# -----------------------------------------------------------------------------
class Cotizacion(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_cotizacion")
    id_proveedor = models.ForeignKey(
        "Proveedor",
        on_delete=models.RESTRICT,
        db_column="id_proveedor",
    )
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_solicitud_compra = models.ForeignKey(
        "SolicitudCompra",
        on_delete=models.RESTRICT,
        db_column="id_solicitud_compra",
        null=True,
        blank=True,
    )
    fecha_cotizacion = models.DateTimeField(default=timezone.now)
    total = models.FloatField(null=True, blank=True)
    validez_cotizacion = models.IntegerField(null=True, blank=True)
    archivo = models.CharField(max_length=256, null=True, blank=True)
    estado_cotizacion = models.IntegerField(default=0)
    estado_detalle = models.SmallIntegerField(default=0)
    iva = models.SmallIntegerField(null=True, blank=True)
    folio = models.CharField(max_length=64, null=True, blank=True)
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        null=True,
        blank=True,
    )
    id_tipo_moneda = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."cotizacion"'
        indexes = [
            models.Index(fields=["id_proveedor"], name="fk_cot_proveedor1_idx"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_cot"),
            models.Index(fields=["id_solicitud_compra"], name="fk_id_sc_cot"),
            models.Index(fields=["id_operador"], name="fk_id_op_cot"),
        ]

    def __str__(self):
        return f"Cotizacion {self.id}"


class DetalleCotizacion(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_detalle_cotizacion")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
    )
    id_cotizacion = models.ForeignKey(
        Cotizacion,
        on_delete=models.RESTRICT,
        db_column="id_cotizacion",
        related_name="detalle_cotizacion",
    )
    id_proveedor = models.ForeignKey(
        "Proveedor",
        on_delete=models.RESTRICT,
        db_column="id_proveedor",
        related_name="detalle_cotizacion",
    )
    fecha_registro = models.DateTimeField(default=timezone.now)
    cantidad = models.CharField(max_length=50, null=True, blank=True)
    detalles = models.CharField(max_length=255, null=True, blank=True)
    descuento_unitario = models.FloatField(null=True, blank=True)
    precio_unitario = models.FloatField(null=True, blank=True)
    id_modelo_producto = models.IntegerField(null=True, blank=True)
    tipo_descuento = models.CharField(max_length=5, null=True, blank=True)
    tipo_item = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."detalle_cotizacion"'
        indexes = [
            models.Index(fields=["id_modelo_producto"], name="mod_prod_det_cot"),
            models.Index(fields=["id_cotizacion"], name="fk_cot_det_cot"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_det_cot"),
            models.Index(fields=["id_proveedor"], name="fk_id_proveedor_det_cot"),
        ]

    def __str__(self):
        return f"DetalleCotizacion {self.id}"


class EstadoOrdenCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_estado_orden_compra")
    descripcion = models.CharField(max_length=100)

    class Meta:
        db_table = '"dm_logistica"."estado_orden_compra"'
        verbose_name = "Estado Orden Compra"
        verbose_name_plural = "Estados Orden Compra"

    def __str__(self):
        return self.descripcion


class OrdenCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_orden_compra")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
    )
    id_cotizacion = models.ForeignKey(
        Cotizacion,
        on_delete=models.RESTRICT,
        db_column="id_cotizacion",
        related_name="orden_compra",
    )
    id_solicitante = models.CharField(max_length=50, null=True, blank=True)
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="orden_compra",
        null=True,
        blank=True,
    )
    id_estado_orden_compra = models.ForeignKey(
        EstadoOrdenCompra,
        on_delete=models.RESTRICT,
        db_column="id_estado_or_compra",
        related_name="orden_compra",
    )
    id_solicitud_compra = models.ForeignKey(
        "SolicitudCompra",
        on_delete=models.RESTRICT,
        db_column="id_solicitud_compra",
        related_name="orden_compra",
    )
    id_proveedor = models.ForeignKey(
        "Proveedor",
        on_delete=models.RESTRICT,
        db_column="id_proveedor",
        related_name="orden_compra",
        null=True,
        blank=True,
    )
    folio = models.CharField(max_length=30, null=True, blank=True)
    fecha = models.DateTimeField(default=timezone.now)
    neto = models.FloatField(null=True, blank=True)
    iva = models.FloatField(null=True, blank=True)
    monto_total = models.FloatField(null=True, blank=True)
    observacion = models.TextField(null=True, blank=True)
    fecha_entrega = models.DateTimeField(null=True, blank=True)
    id_aprobador = models.CharField(max_length=50, null=True, blank=True)
    archivo = models.CharField(max_length=256, null=True, blank=True)
    notas_adicionales = models.TextField(null=True, blank=True)
    id_requerimiento = models.IntegerField(null=True, blank=True)
    id_tipo_moneda = models.IntegerField(null=True, blank=True)
    operador_anula = models.CharField(max_length=50, null=True, blank=True)
    fecha_anula = models.DateTimeField(null=True, blank=True)
    motivo_anula = models.TextField(null=True, blank=True)
    desviacion = models.CharField(max_length=2, default="NO")

    class Meta:
        db_table = '"dm_logistica"."orden_compra"'
        indexes = [
            models.Index(fields=["id_operador"], name="fk_orden_comp_op"),
            models.Index(fields=["id_solicitud_compra"], name="fk_orden_compra_sol_com"),
            models.Index(fields=["id_cotizacion"], name="fk_orden_comp_cot"),
            models.Index(fields=["id_estado_orden_compra"], name="fk_orden_comp_est_or_comp"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_ord_comp"),
            models.Index(fields=["id_proveedor"], name="fk_id_prov_ord_comp"),
            models.Index(fields=["id_solicitante"], name="id_solicitante"),
            models.Index(fields=["folio"], name="folio"),
        ]

    def __str__(self):
        return f"OrdenCompra {self.id}"


class DetalleCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_detalle_compra")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
    )
    id_orden_compra = models.ForeignKey(
        OrdenCompra,
        on_delete=models.RESTRICT,
        db_column="id_orden_compra",
        related_name="detalles_compra",
    )
    id_modelo_producto = models.IntegerField(null=True, blank=True)
    cantidad = models.BigIntegerField(null=True, blank=True)
    precio_unitario = models.FloatField(null=True, blank=True)
    glosa = models.CharField(max_length=100, null=True, blank=True)
    descuento_unitario = models.FloatField(null=True, blank=True)
    total_neto = models.FloatField(null=True, blank=True)
    tipo_item = models.IntegerField(null=True, blank=True)
    comprobado = models.IntegerField(default=0)
    producto_ingresado = models.SmallIntegerField(default=0)
    fecha_ingreso_producto = models.DateTimeField(null=True, blank=True)
    id_operador_ingreso_producto = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."detalle_compra"'
        indexes = [
            models.Index(fields=["id_orden_compra"], name="fk_det_comp_orc"),
            models.Index(fields=["id_modelo_producto"], name="det_comp_modp"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_det_comp"),
        ]

    def __str__(self):
        return f"DetalleCompra {self.id}"


class ProcesoComparacion(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_proceso_comparacion")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
    )
    id_orden_compra = models.ForeignKey(
        OrdenCompra,
        on_delete=models.RESTRICT,
        related_name="proceso_comparacion",
        db_column="id_orden_compra",
    )
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="proceso_comparacion",
        null=True,
        blank=True,
    )
    fecha_comparacion = models.DateTimeField(auto_now=True)
    estado_comparacion = models.IntegerField(default=1)
    observacion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."proceso_comparacion"'
        indexes = [
            models.Index(fields=["id_orden_compra"], name="fk_proc_comp_ord_comp"),
            models.Index(fields=["id_operador"], name="fk_proc_comp_op"),
            models.Index(fields=["id_empresa"], name="fk_id_emp_proc_comp"),
        ]

    def __str__(self):
        return f"ProcesoComparacion {self.id}"


class AjusteDetalleCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_ajuste_detalle_compra")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_proceso_comparacion = models.ForeignKey(
        ProcesoComparacion,
        on_delete=models.RESTRICT,
        db_column="id_proceso_comparacion",
        null=True,
        blank=True,
    )
    id_orden_compra = models.ForeignKey(
        OrdenCompra,
        on_delete=models.RESTRICT,
        db_column="id_orden_compra",
        related_name="ajuste_detalle_compra",
    )
    cantidad = models.IntegerField(null=True, blank=True)
    precio_unitario = models.FloatField()
    glosa = models.CharField(max_length=100)
    descuento = models.FloatField()
    tipo_descuento = models.CharField(max_length=10, null=True, blank=True)
    total_neto = models.FloatField()
    id_detalle_compra = models.ForeignKey(
        DetalleCompra,
        on_delete=models.RESTRICT,
        db_column="id_detalle_compra",
        related_name="ajuste_detalle_compra",
    )

    class Meta:
        db_table = '"dm_logistica"."ajuste_detalle_compra"'
        indexes = [
            models.Index(fields=["id_detalle_compra"], name="fk_aj_det_compdc"),
            models.Index(fields=["id_empresa"], name="fk_id_empresa_ajdcomp"),
            models.Index(fields=["id_proceso_comparacion"], name="fk_id_pc_ajdcomp"),
            models.Index(fields=["id_orden_compra"], name="fk_id_oc_ajdcomp"),
        ]

    def __str__(self):
        return f"AjusteDetalleCompra {self.id}"


# -----------------------------------------------------------------------------
# 7) PROVEEDORES
# -----------------------------------------------------------------------------
class Giro(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_giro")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
        related_name="giros_logistica",
    )
    descrip_giro = models.CharField(max_length=250)
    codigo_sii = models.CharField(max_length=10)

    class Meta:
        db_table = '"dm_logistica"."giro"'
        verbose_name = "Giro"
        verbose_name_plural = "Giros"
        indexes = [
            models.Index(fields=["id"], name="fk_giro_proveedor1_idx"),
            models.Index(fields=["id_empresa"], name="fk_id_empresa_giro"),
        ]
        unique_together = (("id", "descrip_giro"),)

    def __str__(self):
        return f"{self.descrip_giro} (ID: {self.id})"


class Proveedor(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_proveedor")
    id_giro = models.ForeignKey(
        Giro,
        on_delete=models.RESTRICT,
        db_column="id_giro",
        related_name="proveedores",
        null=True,
        blank=True,
    )
    descrip_giro = models.CharField(max_length=250)
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    rut = models.CharField(max_length=20)
    nombre_rs = models.CharField(max_length=200)
    nombre_fantasia = models.CharField(max_length=200, null=True, blank=True)
    web = models.CharField(max_length=50, null=True, blank=True)
    fecha_alta = models.DateTimeField(auto_now_add=True)
    modalidad_pago = models.CharField(max_length=50, default="")
    plazo_pago = models.IntegerField(null=True, blank=True)
    estado = models.IntegerField(default=1)
    direccion = models.CharField(max_length=255, null=True, blank=True)
    id_comuna = models.IntegerField(null=True, blank=True)
    id_region = models.IntegerField(null=True, blank=True)
    proveedor_unico = models.SmallIntegerField(default=0)

    class Meta:
        db_table = '"dm_logistica"."proveedor"'
        verbose_name = "Proveedor"
        verbose_name_plural = "Proveedores"
        indexes = [
            models.Index(fields=["id_empresa"], name="fk_id_empresa_proveedor"),
            models.Index(fields=["id_giro"], name="fk_id_giro_proveedor"),
        ]

    def save(self, *args, **kwargs):
        if self.id_giro:
            self.descrip_giro = self.id_giro.descrip_giro
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.nombre_rs} (RUT: {self.rut})"


class ProveedorTelefono(models.Model):
    TIPO_TELEFONO_CHOICES = [
        ("movil", "Móvil"),
        ("fijo", "Fijo"),
        ("trabajo", "Trabajo"),
        ("otro", "Otro"),
    ]
    id = models.AutoField(primary_key=True, db_column="id_proveedor_telefono")
    id_proveedor = models.ForeignKey(
        Proveedor,
        on_delete=models.RESTRICT,
        related_name="telefonosproveedor",
    )
    tipo = models.CharField(max_length=20, choices=TIPO_TELEFONO_CHOICES)
    es_principal = models.BooleanField(default=False)
    numero = models.CharField(max_length=15)

    class Meta:
        db_table = '"dm_logistica"."proveedor_telefono"'
        indexes = [
            models.Index(fields=["es_principal"], name="fk_esprvtel"),
            models.Index(fields=["tipo"], name="fk_tipo_proveedor_telefono"),
        ]

    def __str__(self):
        return f"{self.tipo} - {self.numero}"


class ProveedorContactos(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_proveedor_contacto")
    id_proveedor = models.ForeignKey(
        Proveedor, on_delete=models.RESTRICT, db_column="id_proveedor"
    )
    relacion_contacto = models.CharField(max_length=50, null=True, blank=True)
    telefono_contacto = models.CharField(max_length=20, null=True, blank=True)
    mail_contacto = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."proveedor_contactos"'
        indexes = [
            models.Index(fields=["id_proveedor"], name="fk_provcon_prov"),
            models.Index(fields=["id_proveedor", "relacion_contacto"]),
        ]

    def __str__(self):
        return f"{self.id_proveedor} - {self.relacion_contacto}"


# -----------------------------------------------------------------------------
# 8) SERVICIOS (BÁSICOS / CAJA CHICA)
# -----------------------------------------------------------------------------
class ServiciosBasicos(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_servicio_basico")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="servicios_basicos",
        null=True,
        blank=True,
    )
    id_proveedor = models.ForeignKey(
        Proveedor,
        on_delete=models.RESTRICT,
        db_column="id_proveedor",
        related_name="servicios_basicos",
    )
    item_presupuesto = models.CharField(max_length=6, null=True, blank=True)
    fecha_registro = models.DateTimeField(auto_now_add=True)
    observacion = models.TextField(null=True, blank=True)
    id_punto_venta = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."servicios_basicos"'
        verbose_name = "Servicio Básico"
        verbose_name_plural = "Servicios Básicos"
        indexes = [
            models.Index(fields=["id_empresa"], name="fk_emp_servbas"),
            models.Index(fields=["id_operador"], name="fk_op_servbas"),
            models.Index(fields=["id_proveedor"], name="fk_prov_servbas"),
            models.Index(fields=["id_punto_venta"], name="fk_pv_servbas"),
        ]

    def __str__(self):
        return f"Servicio Básico {self.id}"


class ServiciosCajaChica(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_servicio_caja_chica")
    monto = models.FloatField(null=True, blank=True)
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="servicios_caja_chica_operador",
    )
    id_operador_autoriza = models.CharField(max_length=50)
    fecha_registro = models.DateTimeField(auto_now_add=True)
    fecha_autoriza = models.DateField(null=True, blank=True)
    nota = models.TextField(null=True, blank=True)
    estado = models.CharField(max_length=50, null=True, blank=True)
    motivo_rechazo = models.TextField(null=True, blank=True)
    archivo = models.CharField(max_length=255, null=True, blank=True)
    id_parque = models.IntegerField(null=True, blank=True)
    id_punto_venta = models.IntegerField(null=True, blank=True)  # NUEVO ✔
    id_solicitante = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."servicios_caja_chica"'
        verbose_name = "Servicio Caja Chica"
        verbose_name_plural = "Servicios Caja Chica"
        indexes = [
            models.Index(fields=["id_empresa"], name="fk_id_empresa"),
            models.Index(fields=["estado"], name="estado"),
            models.Index(fields=["id_punto_venta"], name="id_punto_venta"),
            models.Index(fields=["fecha_autoriza"], name="fecha_autoriza"),
            models.Index(fields=["id_operador"], name="fk_op_servcaja"),
        ]

    def __str__(self):
        return f"Servicio Caja Chica {self.id}"


class ServiciosCajaChicaDetalle(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_servicio_caja_chica_detalle")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
        blank=True,
    )
    id_servicio_caja_chica = models.ForeignKey(
        ServiciosCajaChica,
        on_delete=models.RESTRICT,
        db_column="id_servicio_caja_chica",
        related_name="detalles_caja_chica",
    )
    tipo_doc = models.CharField(max_length=50, null=True, blank=True)
    fecha_emision = models.DateTimeField(null=True, blank=True)
    razon_social = models.CharField(max_length=50, null=True, blank=True)
    folio_dt = models.CharField(max_length=50, null=True, blank=True)
    monto = models.FloatField(null=True, blank=True)
    detalle = models.CharField(max_length=255, null=True, blank=True)
    item_presupuesto = models.CharField(max_length=10, null=True, blank=True)
    archivo = models.CharField(max_length=255, null=True, blank=True)
    id_operador = models.ForeignKey(
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="servicios_caja_chica_detalle",
    )
    fecha_registro = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = '"dm_logistica"."servicios_caja_chica_detalle"'
        verbose_name = "Detalle de Servicio Caja Chica"
        verbose_name_plural = "Detalles de Servicio Caja Chica"
        indexes = [
            models.Index(fields=["id_servicio_caja_chica"], name="fk_servcajadet"),
            models.Index(fields=["id_empresa"], name="fk_emp_scchdt"),
            models.Index(fields=["id_operador"], name="fk_op_scchdt"),
        ]

    def __str__(self):
        return f"Detalle {self.id}"


# -----------------------------------------------------------------------------
# 9) SOLICITUDES
# -----------------------------------------------------------------------------
class EstadoSolicitudCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_estado_solicitud_compra")
    descripcion_solicitud_compra = models.CharField(max_length=100)

    class Meta:
        db_table = '"dm_logistica"."estado_solicitud_compra"'
        verbose_name = "Estado Solicitud de Compra"
        verbose_name_plural = "Estados Solicitud de Compra"

    def __str__(self):
        return self.descripcion_solicitud_compra


class TipoSolicitud(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_tipo_solicitud")
    descripcion = models.CharField(max_length=30, null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."tipo_solicitud"'
        verbose_name = "Tipo de Solicitud"
        verbose_name_plural = "Tipos de Solicitud"

    def __str__(self):
        return self.descripcion or "Sin descripción"


class SolicitudCompra(models.Model):
    id = models.AutoField(primary_key=True, db_column="id_solicitud_compra")
    id_empresa = models.ForeignKey(
        "coreempresas.Empresa",
        on_delete=models.RESTRICT,
        db_column="id_empresa",
        null=True,
    )
    id_operador = models.ForeignKey(  # ✔ sin coma final
        "operadores.Operador",
        on_delete=models.RESTRICT,
        db_column="id_operador",
        related_name="solicitudes",
    )
    id_aprobador = models.CharField(max_length=50, default="")
    id_estado_solicitud_compra = models.ForeignKey(
        EstadoSolicitudCompra,
        on_delete=models.RESTRICT,
        db_column="id_estado_solicitud_compra",
        related_name="solicitudes",
    )
    fecha_registro = models.DateTimeField(auto_now_add=True)
    descripcion = models.TextField(null=True, blank=True)
    fecha_solicitud_compra = models.DateTimeField(null=True, blank=True)
    id_tipo_solicitud = models.ForeignKey(
        TipoSolicitud,
        on_delete=models.RESTRICT,
        db_column="id_tipo_solicitud",
        related_name="solicitudes",
    )
    titulo = models.CharField(max_length=100, null=True, blank=True)
    ruta_file = models.CharField(max_length=255, null=True, blank=True)
    cod_presupuesto = models.CharField(max_length=10, null=True, blank=True)
    id_punto_venta = models.IntegerField(null=True, blank=True)
    operador_rechazo = models.CharField(max_length=50, null=True, blank=True)
    fecha_rechazo = models.DateTimeField(null=True, blank=True)
    motivo_rechazo = models.TextField(null=True, blank=True)
    id_requerimiento = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = '"dm_logistica"."solicitud_compra"'
        verbose_name = "Solicitud de Compra"
        verbose_name_plural = "Solicitudes de Compra"
        indexes = [
            models.Index(fields=["id_operador"], name="fk_solic_comp_op"),
            models.Index(fields=["id_empresa"], name="fk_solic_comp_emp"),
            models.Index(fields=["id_estado_solicitud_compra"], name="fk_solic_comp_esomp"),
            models.Index(fields=["id_tipo_solicitud"], name="id_tip_sol_sc"),
            models.Index(fields=["cod_presupuesto"], name="cod_pres_sc"),
            models.Index(fields=["id_punto_venta"], name="id_punto_venta_sc"),
            models.Index(fields=["id_requerimiento"], name="id_requerimiento_sc"),
        ]

    def __str__(self):
        return f"Solicitud {self.id} - {self.titulo or 'Sin Título'}"


=== ./dm_logistica/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./dm_logistica/apps.py ===
from django.apps import AppConfig


class DmLogisticaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'dm_logistica'


=== ./dm_sistema/serializer.py ===
# dm_sistema/serializer.py

from rest_framework import serializers
from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo, 
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from dm_logistica.models import Proveedor  # ← import para el nuevo serializer

class OperadorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Operador
        fields = '__all__'

class OperadorBodegaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorBodega
        fields = '__all__'

class OperadorEmpresaModuloSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModulo
        fields = '__all__'

class OperadorEmpresaModuloMenuSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModuloMenu
        fields = '__all__'

class OperadorGrupoSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorGrupo
        fields = '__all__'

class OperadorPuntoVentaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorPuntoVenta
        fields = '__all__'

class SesionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Sesion
        fields = '__all__'

class SesionActivaSerializer(serializers.ModelSerializer):
    class Meta:
        model = SesionActiva
        fields = '__all__'

# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: Serializer para Proveedor
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Proveedor
        fields = '__all__'


=== ./dm_sistema/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./dm_sistema/urls.py ===
# dm_sistema/urls.py

from django.urls import path, include
from rest_framework import routers
from rest_framework.documentation import include_docs_urls

from .views import (
    OperadorViewSet, OperadorBodegaViewSet,
    OperadorEmpresaModuloViewSet, OperadorEmpresaModuloMenuViewSet,
    OperadorGrupoViewSet, OperadorPuntoVentaViewSet,
    SesionViewSet, SesionActivaViewSet,
    OperadorByTokenViewSet,
    ProveedorEmpresaViewSet      # ← ya registrado
)

router = routers.DefaultRouter()
router.register(r'operadores', OperadorViewSet, basename='operadores')
router.register(r'operadores-bodegas', OperadorBodegaViewSet, basename='operadores-bodegas')
router.register(r'operadores-empresa-modulos', OperadorEmpresaModuloViewSet, basename='operadores-empresa-modulos')
router.register(r'operadores-empresa-modulos-menus', OperadorEmpresaModuloMenuViewSet, basename='operadores-empresa-modulos-menus')
router.register(r'operadores-grupos', OperadorGrupoViewSet, basename='operadores-grupos')
router.register(r'operadores-punto-venta', OperadorPuntoVentaViewSet, basename='operadores-punto-venta')
router.register(r'sesiones', SesionViewSet, basename='sesiones')
router.register(r'sesiones-activas', SesionActivaViewSet, basename='sesiones-activas')
router.register(r'proveedores-empresa', ProveedorEmpresaViewSet, basename='proveedores-empresa')

urlpatterns = [
    path('', include(router.urls)),
    path('docs/', include_docs_urls(title='Operadores API')),
    path('sesiones-activas-token/',
         OperadorByTokenViewSet.as_view({'get': 'get_by_cookie'}),
         name='sesiones-activas-token-cookie'),
    path('logout/',
         OperadorViewSet.as_view({'get': 'logout'}),
         name='logout'),
]


=== ./dm_sistema/__init__.py ===


=== ./dm_sistema/migrations/__init__.py ===


=== ./dm_sistema/views.py ===
# dm_sistema/views.py

from __future__ import annotations

import os
import jwt
import secrets
import requests
import crypt
from datetime import datetime, timedelta

from django.conf import settings
from django.core.exceptions import PermissionDenied
from django.db import connection
from django.utils import timezone
from rest_framework import status, viewsets
from rest_framework.decorators import action
from rest_framework.response import Response

from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo,
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from .serializer import (
    OperadorSerializer, OperadorBodegaSerializer,
    OperadorEmpresaModuloSerializer, OperadorEmpresaModuloMenuSerializer,
    OperadorGrupoSerializer, OperadorPuntoVentaSerializer,
    SesionSerializer, SesionActivaSerializer,
    ProveedorSerializer
)
from dm_logistica.models import Proveedor  # ← añadimos import

# ---------------------------------------------------------------------
#  CORS mínimo ─ permite varios orígenes (prod + dev) -----------------
# ---------------------------------------------------------------------
class RestrictToReactMixin:
    """
    Permite la petición solo si la cabecera **Origin** está incluida en
    la lista blanca.  
    · Si el navegador NO envía cabecera Origin (p.e. cURL / Postman)
      la solicitud se acepta.  
    · La lista se puede ampliar vía variable de entorno
      «ALLOWED_CORS_ORIGINS», separada por comas.
    """
    _BASE_ORIGINS = {
        "http://localhost:5173",
        "https://desarrollo.smartgest.cl"
    }

    EXTRA_ORIGINS = set(
        origin.strip()
        for origin in os.getenv("ALLOWED_CORS_ORIGINS", "").split(",")
        if origin.strip()
    )

    ALLOWED_ORIGINS = _BASE_ORIGINS | EXTRA_ORIGINS

    def initial(self, request, *args, **kwargs):
        origin = request.META.get("HTTP_ORIGIN")
        if origin is not None and origin not in self.ALLOWED_ORIGINS:
            raise PermissionDenied("Acceso denegado por CORS.")
        return super().initial(request, *args, **kwargs)

# ---------------------------------------------------------------------
#  utilidades auxiliares
# ---------------------------------------------------------------------
def enviar_correo_python(remitente: str, correo_destino: str, asunto: str, detalle: str) -> None:
    try:
        requests.post(
            "http://mail.smartgest.cl/mailserver/server_mail.php",
            data={
                "destino": correo_destino,
                "asunto":  asunto,
                "detalle": detalle,
                "from":    remitente,
            },
            timeout=8,
        )
    except Exception as exc:
        print(f"[WARN] Falló el envío de correo: {exc}")

# ---------------------------------------------------------------------
#  VIEWSET PRINCIPAL  (login / 2FA / logout)
# ---------------------------------------------------------------------
class OperadorViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Operador.objects.all()
    serializer_class = OperadorSerializer

    @action(detail=False, methods=["post"])
    def validar(self, request):
        username = request.data.get("username")
        password = request.data.get("password")
        if not username or not password:
            return Response({"error": "Se requieren 'username' y 'password'."},
                            status=status.HTTP_400_BAD_REQUEST)
        try:
            op = Operador.objects.get(username=username)
        except Operador.DoesNotExist:
            return Response({"error": "No existe un operador con esos datos."},
                            status=status.HTTP_404_NOT_FOUND)
        if op.estado != 1:
            return Response({"error": "El usuario no se encuentra activo."},
                            status=status.HTTP_403_FORBIDDEN)
        if op.id_empresa.estado != 1:
            return Response({"error": "La empresa asociada al usuario no se encuentra activa."},
                            status=status.HTTP_403_FORBIDDEN)
        if op.conexion_fallida > 2:
            return Response({"error": "Ha superado los intentos permitidos (3). Cuenta bloqueada."},
                            status=status.HTTP_403_FORBIDDEN)
        if crypt.crypt(password, op.password) != op.password:
            op.conexion_fallida += 1
            op.save(update_fields=["conexion_fallida"])
            return Response({"error": "Credenciales incorrectas."},
                            status=status.HTTP_404_NOT_FOUND)
        if op.conexion_fallida:
            op.conexion_fallida = 0
            op.save(update_fields=["conexion_fallida"])
        token = jwt.encode(
            {"id": op.id, "username": op.username,
             "exp": datetime.utcnow() + timedelta(hours=24)},
            settings.SECRET_KEY, algorithm="HS256"
        )
        ip = request.META.get("HTTP_X_FORWARDED_FOR",
                              request.META.get("REMOTE_ADDR", ""))
        if "," in ip:
            ip = ip.split(",")[0].strip()
        sesion = Sesion.objects.create(
            ip=ip, fecha=timezone.now(),
            id_operador=op, id_empresa=op.id_empresa
        )
        codigo = secrets.token_hex(16)
        SesionActiva.objects.create(
            id_operador=op, id_sesion=sesion,
            id_empresa=op.id_empresa,
            fecha_registro=timezone.now(),
            token=token, cod_verificacion=codigo,
        )
        enviar_correo_python("DM", op.username,
                             "Código de Verificación", f"Hola, tu código es: {codigo}")
        return Response({"username": op.username}, status=status.HTTP_200_OK)

    @action(detail=False, methods=["post"])
    def verificar(self, request):
        username = request.data.get("username")
        codigo   = request.data.get("cod_verificacion")
        if not username or not codigo:
            return Response({"error": "Se requieren 'username' y 'cod_verificacion'."},
                            status=status.HTTP_400_BAD_REQUEST)
        sesiones = (SesionActiva.objects
                    .filter(id_operador__username=username)
                    .order_by("-fecha_registro"))
        if not sesiones.exists():
            return Response({"error": "No se encontró ninguna sesión activa para este operador."},
                            status=status.HTTP_404_NOT_FOUND)
        sesion_reciente = sesiones.first()
        if sesion_reciente.cod_verificacion != codigo:
            return Response({"error": "El código de verificación no coincide."},
                            status=status.HTTP_400_BAD_REQUEST)
        op = sesion_reciente.id_operador
        SesionActiva.objects.filter(id_operador=op).exclude(
            id=sesion_reciente.id).delete()
        if op.id_empresa.estado != 1:
            sesion_reciente.delete()
            return Response({"error": "La empresa asociada se encuentra desactivada. Sesión cerrada."},
                            status=status.HTTP_403_FORBIDDEN)
        # construye lista de modulos
        modulos = []
        with connection.cursor() as cur:
            cur.execute("""
                SELECT c.nombre_menu, b.id_empresa_modulo, c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador   = %s
                   AND b.estado        = 1
                   AND c.estado        = 1
                   AND b.id_empresa    = %s
              ORDER BY c.orden;
            """, [op.id, op.id_empresa_id])
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append({"nombre_menu": nombre_menu, "id": id_em, "icon": icon})
        # construye funcionalidades
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute("""
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador          = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu            = m.id_menu
                 WHERE o.id_operador = %s;
            """, [op.id])
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })
        resp = Response({
            "message": "Verificación exitosa.",
            "operador":        OperadorSerializer(op).data,
            "modulos":         modulos,
            "funcionalidades": funcionalidades,
        }, status=status.HTTP_200_OK)
        resp.set_cookie("token", sesion_reciente.token,
                        httponly=True, secure=True,
                        max_age=24*3600, samesite="None")
        return resp

    @action(detail=False, methods=["get"])
    def logout(self, request):
        token = request.COOKIES.get("token")
        if not token:
            return Response({"error": "No se encontró la cookie 'token'."},
                            status=status.HTTP_401_UNAUTHORIZED)
        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Response({"error": "El token de la cookie no coincide con ninguna sesión activa."},
                            status=status.HTTP_404_NOT_FOUND)
        sesiones.delete()
        resp = Response({"message": "Sesión eliminada correctamente."},
                        status=status.HTTP_200_OK)
        resp.delete_cookie("token")
        return resp

# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: ViewSet para Proveedores filtrados por la empresa del operador en sesión
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorEmpresaViewSet(RestrictToReactMixin, viewsets.ReadOnlyModelViewSet):
    serializer_class = ProveedorSerializer
    def get_queryset(self):
        token = self.request.COOKIES.get("token")
        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Proveedor.objects.none()
        sesion = sesiones.first()
        empresa_id = sesion.id_empresa_id or sesion.id_operador.id_empresa_id
        return Proveedor.objects.filter(id_empresa_id=empresa_id)

# ─────────────────────────────────────────────────────────────────────────────
# CRUD SIMPLES (sin cambios)
# ─────────────────────────────────────────────────────────────────────────────
class OperadorBodegaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorBodega.objects.all()
    serializer_class = OperadorBodegaSerializer

class OperadorEmpresaModuloViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModulo.objects.all()
    serializer_class = OperadorEmpresaModuloSerializer

class OperadorEmpresaModuloMenuViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModuloMenu.objects.all()
    serializer_class = OperadorEmpresaModuloMenuSerializer

class OperadorGrupoViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorGrupo.objects.all()
    serializer_class = OperadorGrupoSerializer

class OperadorPuntoVentaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorPuntoVenta.objects.all()
    serializer_class = OperadorPuntoVentaSerializer

class SesionViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Sesion.objects.all()
    serializer_class = SesionSerializer

class SesionActivaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = SesionActiva.objects.all()
    serializer_class = SesionActivaSerializer

# ─────────────────────────────────────────────────────────────────────────────
# SESIÓN POR TOKEN ------------------------------------------------------------
# ─────────────────────────────────────────────────────────────────────────────
class OperadorByTokenViewSet(RestrictToReactMixin, viewsets.ViewSet):
    def get_by_cookie(self, request):
        token_cookie = request.COOKIES.get("token")
        if not token_cookie:
            return Response({"error": "No se encontró la cookie 'token'."},
                            status=status.HTTP_401_UNAUTHORIZED)
        sesiones = (
            SesionActiva.objects
            .select_related("id_operador")
            .filter(token=token_cookie)
            .order_by("-fecha_registro")
        )
        if not sesiones.exists():
            return Response({"error": "El token no coincide con ninguna sesión activa."},
                            status=status.HTTP_404_NOT_FOUND)
        sesion_activa = sesiones.first()
        if sesiones.count() > 1:
            sesiones.exclude(id=sesion_activa.id).delete()
        op = sesion_activa.id_operador
        if op.id_empresa.estado != 1:
            sesion_activa.delete()
            return Response({"error": "La empresa asociada al usuario se encuentra desactivada. La sesión ha sido cerrada."},
                            status=status.HTTP_403_FORBIDDEN)
        modulos = []
        with connection.cursor() as cur:
            cur.execute("""
                SELECT c.nombre_menu, b.id_empresa_modulo, c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador = %s
                   AND b.estado      = 1
                   AND c.estado      = 1
                   AND b.id_empresa  = %s
              ORDER BY c.orden;
            """, [op.id, op.id_empresa_id])
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append({"nombre_menu": nombre_menu, "id": id_em, "icon": icon})
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute("""
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu = m.id_menu
                 WHERE o.id_operador = %s;
            """, [op.id])
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })
        return Response({
            "sesion_activa":   SesionActivaSerializer(sesion_activa).data,
            "operador_data":   OperadorSerializer(op).data,
            "modulos":         modulos,
            "funcionalidades": funcionalidades,
        }, status=status.HTTP_200_OK)


=== ./dm_sistema/models.py ===
# This is an auto-generated Django model module.
# You'll have to do the following manually to clean this up:
#   * Rearrange models' order
#   * Make sure each model has one field with primary_key=True
#   * Make sure each ForeignKey and OneToOneField has `on_delete` set to the desired behavior
#   * Remove `managed = False` lines if you wish to allow Django to create, modify, and delete the table
# Feel free to rename the models, but don't rename db_table values or field names.
from django.db import models


class Empresa(models.Model):
    razon_social = models.CharField(max_length=100, blank=True, null=True)
    direccion = models.CharField(max_length=200, blank=True, null=True)
    comuna = models.CharField(max_length=50, blank=True, null=True)
    ciudad = models.CharField(max_length=50, blank=True, null=True)
    rut = models.CharField(max_length=20, blank=True, null=True)
    giro = models.CharField(max_length=255, blank=True, null=True)
    acteco = models.CharField(max_length=10, blank=True, null=True)
    rut_firma = models.CharField(max_length=20, blank=True, null=True)
    logo = models.CharField(max_length=50, blank=True, null=True)
    subdominio = models.CharField(max_length=50, blank=True, null=True)
    titulo = models.CharField(max_length=50, blank=True, null=True)
    estado = models.IntegerField(blank=True, null=True)
    fecha_incorporacion = models.DateTimeField(blank=True, null=True)
    master = models.BooleanField(blank=True, null=True)
    fecha_modificacion = models.DateTimeField(blank=True, null=True)
    licencias = models.IntegerField(blank=True, null=True)
    logo_grande = models.CharField(max_length=255, blank=True, null=True)
    ingreso_pcd = models.IntegerField()
    ingreso_funnel = models.IntegerField(blank=True, null=True)
    mercado = models.CharField(max_length=50, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa"'


class EmpresaModulo(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    id_modulo = models.ForeignKey('Modulos', models.DO_NOTHING, db_column='id_modulo')
    estado = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_modulo"'


class EmpresaModulosMenu(models.Model):
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, models.DO_NOTHING, db_column='id_empresa_modulo')
    id_menu = models.ForeignKey('Menus', models.DO_NOTHING, db_column='id_menu')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_modulos_menu"'


class EmpresaParam(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    campo = models.CharField(max_length=255, blank=True, null=True)
    valor = models.CharField(max_length=255, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_param"'


class EmpresaResolucion(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    numero = models.CharField(max_length=50)
    fecha = models.DateField()
    tipo = models.CharField(max_length=20, blank=True, null=True)
    descripcion = models.TextField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_resolucion"'


class EmpresaTelefono(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    numero = models.CharField(max_length=20)
    tipo = models.CharField(max_length=10)
    principal = models.BooleanField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_telefono"'


class Grupo(models.Model):
    nombre = models.CharField(max_length=255, blank=True, null=True)
    asignable = models.IntegerField(blank=True, null=True)
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."grupo"'


class Log(models.Model):
    id_operador = models.ForeignKey('Operador', models.DO_NOTHING, db_column='id_operador')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    operacion = models.CharField(max_length=30)
    detalle = models.TextField()
    script = models.CharField(max_length=100)
    tabla = models.CharField(max_length=100)
    fecha = models.DateTimeField()
    id_cliente = models.IntegerField(blank=True, null=True)
    id_contrato = models.IntegerField(blank=True, null=True)
    id_suscriptor = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."log"'


class Menus(models.Model):
    url = models.CharField(max_length=50)
    texto = models.CharField(max_length=50, blank=True, null=True)
    etiqueta = models.CharField(max_length=50, blank=True, null=True)
    descripcion = models.CharField(max_length=255)
    nivel_menu = models.IntegerField(blank=True, null=True)
    orden = models.IntegerField(blank=True, null=True)
    modificable = models.CharField(max_length=2, blank=True, null=True)
    id_modulo = models.ForeignKey('Modulos', models.DO_NOTHING, db_column='id_modulo')
    separador_up = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."menus"'


class Modulos(models.Model):
    modulo = models.CharField(max_length=50)
    nombre = models.CharField(max_length=255)
    nombre_menu = models.CharField(max_length=100, blank=True, null=True)
    estado = models.SmallIntegerField(blank=True, null=True)
    icon = models.CharField(max_length=255, blank=True, null=True)
    orden = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."modulos"'


class Operador(models.Model):
    username = models.CharField(max_length=50)
    password = models.CharField(max_length=80, blank=True, null=True)
    clear = models.CharField(max_length=80, blank=True, null=True)
    rut = models.CharField(max_length=15, blank=True, null=True)
    nombres = models.CharField(max_length=100, blank=True, null=True)
    apellido_paterno = models.CharField(max_length=100, blank=True, null=True)
    apellido_materno = models.CharField(max_length=100, blank=True, null=True)
    modificable = models.IntegerField(blank=True, null=True)
    email = models.CharField(max_length=50, blank=True, null=True)
    estado = models.IntegerField(blank=True, null=True)
    acceso_web = models.IntegerField(blank=True, null=True)
    conexion_fallida = models.IntegerField(blank=True, null=True)
    operador_administrador = models.CharField(max_length=50, blank=True, null=True)
    id_grupo = models.ForeignKey(Grupo, models.DO_NOTHING, db_column='id_grupo')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    superadmin = models.IntegerField(blank=True, null=True)
    fecha_creacion = models.DateTimeField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador"'


class OperadorBodega(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_bodega = models.IntegerField()
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_bodega"'


class OperadorEmpresaModulos(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, models.DO_NOTHING, db_column='id_empresa_modulo')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_empresa_modulos"'


class OperadorEmpresaModulosMenu(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa_modulos_menu = models.ForeignKey(EmpresaModulosMenu, models.DO_NOTHING, db_column='id_empresa_modulos_menu')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_empresa_modulos_menu"'


class OperadorGrupos(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_grupo = models.ForeignKey(Grupo, models.DO_NOTHING, db_column='id_grupo')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_grupos"'


class OperadorPuntoVenta(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_punto_venta = models.IntegerField()
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_punto_venta"'


class Sesiones(models.Model):
    ip = models.CharField(max_length=20)
    fecha = models.DateTimeField()
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."sesiones"'


class SesionesActivas(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_sesion = models.ForeignKey(Sesiones, models.DO_NOTHING, db_column='id_sesion')
    fecha_registro = models.DateTimeField(blank=True, null=True)
    token = models.CharField(max_length=255, blank=True, null=True)
    cod_verificacion = models.CharField(max_length=255, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."sesiones_activas"'


=== ./dm_sistema/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./dm_sistema/combined.txt ===


=== ./admin.py ===
from django.contrib import admin

# Register your models here.


=== ./__init__.py ===


=== ./migrations/__init__.py ===


=== ./views.py ===
from django.shortcuts import render

# Create your views here.


=== ./models.py ===
# This is an auto-generated Django model module.
# You'll have to do the following manually to clean this up:
#   * Rearrange models' order
#   * Make sure each model has one field with primary_key=True
#   * Make sure each ForeignKey and OneToOneField has `on_delete` set to the desired behavior
#   * Remove `managed = False` lines if you wish to allow Django to create, modify, and delete the table
# Feel free to rename the models, but don't rename db_table values or field names.
from django.db import models


class Empresa(models.Model):
    razon_social = models.CharField(max_length=100, blank=True, null=True)
    direccion = models.CharField(max_length=200, blank=True, null=True)
    comuna = models.CharField(max_length=50, blank=True, null=True)
    ciudad = models.CharField(max_length=50, blank=True, null=True)
    rut = models.CharField(max_length=20, blank=True, null=True)
    giro = models.CharField(max_length=255, blank=True, null=True)
    acteco = models.CharField(max_length=10, blank=True, null=True)
    rut_firma = models.CharField(max_length=20, blank=True, null=True)
    logo = models.CharField(max_length=50, blank=True, null=True)
    subdominio = models.CharField(max_length=50, blank=True, null=True)
    titulo = models.CharField(max_length=50, blank=True, null=True)
    estado = models.IntegerField(blank=True, null=True)
    fecha_incorporacion = models.DateTimeField(blank=True, null=True)
    master = models.BooleanField(blank=True, null=True)
    fecha_modificacion = models.DateTimeField(blank=True, null=True)
    licencias = models.IntegerField(blank=True, null=True)
    logo_grande = models.CharField(max_length=255, blank=True, null=True)
    ingreso_pcd = models.IntegerField()
    ingreso_funnel = models.IntegerField(blank=True, null=True)
    mercado = models.CharField(max_length=50, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa"'


class EmpresaModulo(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    id_modulo = models.ForeignKey('Modulos', models.DO_NOTHING, db_column='id_modulo')
    estado = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_modulo"'


class EmpresaModulosMenu(models.Model):
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, models.DO_NOTHING, db_column='id_empresa_modulo')
    id_menu = models.ForeignKey('Menus', models.DO_NOTHING, db_column='id_menu')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_modulos_menu"'


class EmpresaParam(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    campo = models.CharField(max_length=255, blank=True, null=True)
    valor = models.CharField(max_length=255, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_param"'


class EmpresaResolucion(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    numero = models.CharField(max_length=50)
    fecha = models.DateField()
    tipo = models.CharField(max_length=20, blank=True, null=True)
    descripcion = models.TextField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_resolucion"'


class EmpresaTelefono(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    numero = models.CharField(max_length=20)
    tipo = models.CharField(max_length=10)
    principal = models.BooleanField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."empresa_telefono"'


class Grupo(models.Model):
    nombre = models.CharField(max_length=255, blank=True, null=True)
    asignable = models.IntegerField(blank=True, null=True)
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."grupo"'


class Log(models.Model):
    id_operador = models.ForeignKey('Operador', models.DO_NOTHING, db_column='id_operador')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    operacion = models.CharField(max_length=30)
    detalle = models.TextField()
    script = models.CharField(max_length=100)
    tabla = models.CharField(max_length=100)
    fecha = models.DateTimeField()
    id_cliente = models.IntegerField(blank=True, null=True)
    id_contrato = models.IntegerField(blank=True, null=True)
    id_suscriptor = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."log"'


class Menus(models.Model):
    url = models.CharField(max_length=50)
    texto = models.CharField(max_length=50, blank=True, null=True)
    etiqueta = models.CharField(max_length=50, blank=True, null=True)
    descripcion = models.CharField(max_length=255)
    nivel_menu = models.IntegerField(blank=True, null=True)
    orden = models.IntegerField(blank=True, null=True)
    modificable = models.CharField(max_length=2, blank=True, null=True)
    id_modulo = models.ForeignKey('Modulos', models.DO_NOTHING, db_column='id_modulo')
    separador_up = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."menus"'


class Modulos(models.Model):
    modulo = models.CharField(max_length=50)
    nombre = models.CharField(max_length=255)
    nombre_menu = models.CharField(max_length=100, blank=True, null=True)
    estado = models.SmallIntegerField(blank=True, null=True)
    icon = models.CharField(max_length=255, blank=True, null=True)
    orden = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."modulos"'


class Operador(models.Model):
    username = models.CharField(max_length=50)
    password = models.CharField(max_length=80, blank=True, null=True)
    clear = models.CharField(max_length=80, blank=True, null=True)
    rut = models.CharField(max_length=15, blank=True, null=True)
    nombres = models.CharField(max_length=100, blank=True, null=True)
    apellido_paterno = models.CharField(max_length=100, blank=True, null=True)
    apellido_materno = models.CharField(max_length=100, blank=True, null=True)
    modificable = models.IntegerField(blank=True, null=True)
    email = models.CharField(max_length=50, blank=True, null=True)
    estado = models.IntegerField(blank=True, null=True)
    acceso_web = models.IntegerField(blank=True, null=True)
    conexion_fallida = models.IntegerField(blank=True, null=True)
    operador_administrador = models.CharField(max_length=50, blank=True, null=True)
    id_grupo = models.ForeignKey(Grupo, models.DO_NOTHING, db_column='id_grupo')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    superadmin = models.IntegerField(blank=True, null=True)
    fecha_creacion = models.DateTimeField(blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador"'


class OperadorBodega(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_bodega = models.IntegerField()
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_bodega"'


class OperadorEmpresaModulos(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, models.DO_NOTHING, db_column='id_empresa_modulo')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_empresa_modulos"'


class OperadorEmpresaModulosMenu(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa_modulos_menu = models.ForeignKey(EmpresaModulosMenu, models.DO_NOTHING, db_column='id_empresa_modulos_menu')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_empresa_modulos_menu"'


class OperadorGrupos(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_grupo = models.ForeignKey(Grupo, models.DO_NOTHING, db_column='id_grupo')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_grupos"'


class OperadorPuntoVenta(models.Model):
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_punto_venta = models.IntegerField()
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."operador_punto_venta"'


class Sesiones(models.Model):
    ip = models.CharField(max_length=20)
    fecha = models.DateTimeField()
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')

    class Meta:
        managed = False
        db_table = '"dm_sistema"."sesiones"'


class SesionesActivas(models.Model):
    id_empresa = models.ForeignKey(Empresa, models.DO_NOTHING, db_column='id_empresa')
    id_operador = models.ForeignKey(Operador, models.DO_NOTHING, db_column='id_operador')
    id_sesion = models.ForeignKey(Sesiones, models.DO_NOTHING, db_column='id_sesion')
    fecha_registro = models.DateTimeField(blank=True, null=True)
    token = models.CharField(max_length=255, blank=True, null=True)
    cod_verificacion = models.CharField(max_length=255, blank=True, null=True)

    class Meta:
        managed = False
        db_table = '"dm_sistema"."sesiones_activas"'


=== ./tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./combined.txt ===


=== ./apps.py ===
from django.apps import AppConfig


class DmSistemaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'dm_sistema'


=== ./dm_sistema/apps.py ===
from django.apps import AppConfig


class DmSistemaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'dm_sistema'


=== ./operadores/serializer.py ===
# ./operadores/serializer.py

from rest_framework import serializers
from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo, 
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from dm_logistica.models import Proveedor  # ← añadimos import

class OperadorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Operador
        fields = '__all__'

class OperadorBodegaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorBodega
        fields = '__all__'

class OperadorEmpresaModuloSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModulo
        fields = '__all__'

class OperadorEmpresaModuloMenuSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModuloMenu
        fields = '__all__'

class OperadorGrupoSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorGrupo
        fields = '__all__'

class OperadorPuntoVentaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorPuntoVenta
        fields = '__all__'

class SesionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Sesion
        fields = '__all__'

class SesionActivaSerializer(serializers.ModelSerializer):
    class Meta:
        model = SesionActiva
        fields = '__all__'

# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: Serializer para Proveedor
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Proveedor
        fields = '__all__'


=== ./operadores/admin.py ===
from django.contrib import admin

# Register your models here.


=== ./operadores/urls.py ===
# ./operadores/urls.py

from django.urls import path, include
from rest_framework import routers
from rest_framework.documentation import include_docs_urls

from .views import (
    OperadorViewSet, OperadorBodegaViewSet,
    OperadorEmpresaModuloViewSet, OperadorEmpresaModuloMenuViewSet,
    OperadorGrupoViewSet, OperadorPuntoVentaViewSet,
    SesionViewSet, SesionActivaViewSet,
    OperadorByTokenViewSet,
    ProveedorEmpresaViewSet      # ← ya registrado
)

router = routers.DefaultRouter()
router.register(r'operadores', OperadorViewSet, basename='operadores')
router.register(r'operadores-bodegas', OperadorBodegaViewSet, basename='operadores-bodegas')
router.register(r'operadores-empresa-modulos', OperadorEmpresaModuloViewSet, basename='operadores-empresa-modulos')
router.register(r'operadores-empresa-modulos-menus', OperadorEmpresaModuloMenuViewSet, basename='operadores-empresa-modulos-menus')
router.register(r'operadores-grupos', OperadorGrupoViewSet, basename='operadores-grupos')
router.register(r'operadores-punto-venta', OperadorPuntoVentaViewSet, basename='operadores-punto-venta')
router.register(r'sesiones', SesionViewSet, basename='sesiones')
router.register(r'sesiones-activas', SesionActivaViewSet, basename='sesiones-activas')
router.register(r'proveedores-empresa', ProveedorEmpresaViewSet, basename='proveedores-empresa')  # ← nueva ruta

urlpatterns = [
    path('', include(router.urls)),
    path('docs/', include_docs_urls(title='Operadores API')),
    path('sesiones-activas-token/',
         OperadorByTokenViewSet.as_view({'get': 'get_by_cookie'}),
         name='sesiones-activas-token-cookie'),
    path('logout/',
         OperadorViewSet.as_view({'get': 'logout'}),
         name='logout'),
]


=== ./operadores/__init__.py ===


=== ./operadores/migrations/__init__.py ===


=== ./operadores/migrations/0007_alter_operador_id_empresa_alter_operador_id_grupo.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:42

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0003_remove_empresaparam_idx_empresa_param_campo'),
        ('operadores', '0006_alter_operador_unique_together_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='operador',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operador',
            name='id_grupo',
            field=models.ForeignKey(blank=True, db_column='id_grupo', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='operadores', to='coreempresas.grupo'),
        ),
    ]


=== ./operadores/migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-28 13:21

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('configuracion', '0001_initial'),
        ('coreempresas', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Operador',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('operador_id', models.CharField(max_length=50)),
                ('password', models.CharField(default='', max_length=80)),
                ('clear', models.CharField(blank=True, max_length=80, null=True)),
                ('rut', models.CharField(blank=True, max_length=15, null=True)),
                ('nombres', models.CharField(blank=True, max_length=100, null=True)),
                ('apellido_paterno', models.CharField(blank=True, max_length=100, null=True)),
                ('apellido_materno', models.CharField(blank=True, max_length=100, null=True)),
                ('modificable', models.IntegerField(default=1)),
                ('email', models.CharField(blank=True, max_length=50, null=True)),
                ('estado', models.IntegerField(default=1)),
                ('acceso_web', models.IntegerField(default=0)),
                ('conexion_fallida', models.IntegerField(default=0)),
                ('operador_administrador', models.CharField(default='0', max_length=50)),
                ('superadmin', models.IntegerField(default=0)),
                ('fecha_creacion', models.DateTimeField(default=django.utils.timezone.now)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operadores', to='coreempresas.empresa')),
                ('grupo', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='operadores', to='coreempresas.grupo')),
            ],
            options={
                'db_table': '"dm_sistema"."operador"',
            },
        ),
        migrations.CreateModel(
            name='OperadorBodega',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('bodega_id', models.IntegerField()),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operador_bodegas', to='coreempresas.empresa')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bodegas', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_bodega"',
            },
        ),
        migrations.CreateModel(
            name='OperadorEmpresaModulo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('empresa_modulo', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='configuracion.empresamodulo')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_empresa_modulos"',
            },
        ),
        migrations.CreateModel(
            name='OperadorEmpresaModuloMenu',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('empresa_modulo_menu', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='configuracion.empresamodulomenu')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos_menus', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_empresa_modulos_menu"',
            },
        ),
        migrations.CreateModel(
            name='OperadorGrupo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('grupo', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operadores_grupo', to='coreempresas.grupo')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='grupos_operador', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_grupos"',
            },
        ),
        migrations.CreateModel(
            name='OperadorPuntoVenta',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('punto_venta_id', models.IntegerField()),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operador_punto_ventas', to='coreempresas.empresa')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='puntos_venta', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_punto_venta"',
            },
        ),
        migrations.CreateModel(
            name='Sesion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('ip', models.CharField(max_length=20)),
                ('fecha', models.DateTimeField()),
                ('operador_id', models.CharField(max_length=50)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones"',
            },
        ),
        migrations.CreateModel(
            name='SesionActiva',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('operador_id', models.CharField(blank=True, max_length=50, null=True)),
                ('sesion_id', models.CharField(blank=True, max_length=255, null=True)),
                ('fecha_registro', models.DateTimeField(default=django.utils.timezone.now)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones_activas"',
            },
        ),
        migrations.CreateModel(
            name='SesionEjecutivo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha', models.DateTimeField()),
                ('id_ejecutivo', models.IntegerField()),
                ('rut_ejecutivo', models.CharField(blank=True, max_length=50, null=True)),
                ('id_operador', models.CharField(blank=True, max_length=50, null=True)),
                ('portal', models.CharField(blank=True, max_length=255, null=True)),
                ('ip', models.CharField(blank=True, max_length=50, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones_ejecutivos"',
            },
        ),
        migrations.AddIndex(
            model_name='operador',
            index=models.Index(fields=['empresa'], name='idx_opr_emp_id'),
        ),
        migrations.AddIndex(
            model_name='operador',
            index=models.Index(fields=['grupo'], name='idx_opr_grp_id'),
        ),
        migrations.AlterUniqueTogether(
            name='operador',
            unique_together={('operador_id', 'empresa')},
        ),
        migrations.AddIndex(
            model_name='operadorbodega',
            index=models.Index(fields=['bodega_id'], name='idx_opbdg_bdg_id'),
        ),
        migrations.AddIndex(
            model_name='operadorbodega',
            index=models.Index(fields=['empresa'], name='idx_opbdg_emp_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulo',
            index=models.Index(fields=['operador'], name='idx_oem_opr_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulo',
            index=models.Index(fields=['empresa_modulo'], name='idx_oem_em_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulomenu',
            index=models.Index(fields=['operador'], name='idx_oemm_opr_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulomenu',
            index=models.Index(fields=['empresa_modulo_menu'], name='idx_oemm_mm_id'),
        ),
        migrations.AlterUniqueTogether(
            name='operadorgrupo',
            unique_together={('operador', 'grupo')},
        ),
        migrations.AddIndex(
            model_name='operadorpuntoventa',
            index=models.Index(fields=['empresa'], name='idx_opv_emp_id'),
        ),
        migrations.AddIndex(
            model_name='sesionactiva',
            index=models.Index(fields=['sesion_id'], name='idx_sact_sid'),
        ),
        migrations.AddIndex(
            model_name='sesionactiva',
            index=models.Index(fields=['empresa'], name='idx_sact_emp_id'),
        ),
        migrations.AddIndex(
            model_name='sesionejecutivo',
            index=models.Index(fields=['fecha'], name='idx_seseje_fecha'),
        ),
        migrations.AddIndex(
            model_name='sesionejecutivo',
            index=models.Index(fields=['portal'], name='idx_seseje_portal'),
        ),
    ]


=== ./operadores/migrations/0005_remove_operador_idx_opr_emp_id_and_more.py ===
# operadores/migrations/0005_remove_operador_idx_opr_emp_id_and_more.py
# -----------------------------------------------------------------------------
# Corrige definitivamente el error:
#     psycopg2.errors.DuplicateTable: relation "idx_opr_emp_id" already exists
#
# Idea clave → antes de recrear los índices eliminamos *cualquier* rastro
# del nombre, tanto en el esquema «dm_sistema» como en el search_path por
# defecto, de modo que AddIndex ya no colisione.
# -----------------------------------------------------------------------------

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("configuracion", "0002_remove_empresamodulo_empresa_and_more"),
        ("coreempresas",
         "0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more"),
        ("operadores", "0004_delete_sesionejecutivo"),
    ]

    operations = [
        # ------------------------------------------------------------------ #
        # 0.  **NUEVO:** limpia cualquier índice huérfano antes de todo.     #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                DECLARE
                    idxname text := 'idx_opr_emp_id';
                BEGIN
                    -- en el esquema específico
                    EXECUTE format(
                        'DROP INDEX IF EXISTS %I.%I',
                        'dm_sistema', idxname
                    );
                    -- y en search_path
                    EXECUTE format(
                        'DROP INDEX IF EXISTS %I',
                        idxname
                    );
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 1.  Eliminar los índices “antiguos” declarados en 0001_initial.py   #
        # ------------------------------------------------------------------ #
        migrations.RemoveIndex(model_name="operador", name="idx_opr_emp_id"),
        migrations.RemoveIndex(model_name="operador", name="idx_opr_grp_id"),
        migrations.RemoveIndex(model_name="operadorbodega", name="idx_opbdg_bdg_id"),
        migrations.RemoveIndex(model_name="operadorbodega", name="idx_opbdg_emp_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulo", name="idx_oem_opr_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulo", name="idx_oem_em_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulomenu", name="idx_oemm_opr_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulomenu", name="idx_oemm_mm_id"),
        migrations.RemoveIndex(model_name="operadorpuntoventa", name="idx_opv_emp_id"),
        migrations.RemoveIndex(model_name="sesionactiva", name="idx_sact_sid"),
        migrations.RemoveIndex(model_name="sesionactiva", name="idx_sact_emp_id"),

        # ------------------------------------------------------------------ #
        # 2.  Renombrar columnas (idéntico a la versión previa)               #
        # ------------------------------------------------------------------ #
        migrations.RenameField("operador",              "operador_id",     "username"),
        migrations.RenameField("operadorbodega",        "bodega_id",       "id_bodega"),
        migrations.RenameField("operadorpuntoventa",    "punto_venta_id",  "id_punto_venta"),

        # ------------------------------------------------------------------ #
        # 3‑4.  Eliminamos UNIQUE constraints obsoletos                       #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operador_operador_id_empresa_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador"
                        DROP CONSTRAINT operadores_operador_operador_id_empresa_id_uniq;
                    ELSIF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operador_username_empresa_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador"
                        DROP CONSTRAINT operadores_operador_username_empresa_id_uniq;
                    END IF;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        migrations.RunSQL(
            sql="""
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador_grupos"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operadorgr_operador_id_grupo_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador_grupos"
                        DROP CONSTRAINT operadores_operadorgr_operador_id_grupo_id_uniq;
                    END IF;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 5.  Limpieza exhaustiva de *todos* los índices potenciales          #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                DECLARE
                    idx text;
                BEGIN
                    FOREACH idx IN ARRAY ARRAY[
                        'idx_opr_emp_id','idx_opr_grp_id',
                        'idx_opbdg_bdg_id','idx_opbdg_emp_id','idx_opbdg_opr_id',
                        'idx_oem_opr_id','idx_oem_em_id',
                        'idx_oemm_opr_id','idx_oemm_mm_id',
                        'idx_opgr_opr_id','idx_opgr_grp_id',
                        'idx_opv_emp_id','idx_opv_pv_id','idx_opv_opr_id',
                        'idx_ses_emp_id','idx_ses_opr_id',
                        'idx_sact_sid','idx_sact_emp_id','idx_sact_opr_id'
                    ] LOOP
                        -- en «dm_sistema»
                        EXECUTE format(
                            'DROP INDEX IF EXISTS %I.%I',
                            'dm_sistema', idx
                        );
                        -- y también sin esquema
                        EXECUTE format(
                            'DROP INDEX IF EXISTS %I',
                            idx
                        );
                    END LOOP;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 6.  Eliminación de FK viejas (sin cambios)                          #
        # ------------------------------------------------------------------ #
        migrations.RemoveField("operadorbodega",            "empresa"),
        migrations.RemoveField("operadorbodega",            "operador"),
        migrations.RemoveField("operadorempresamodulo",     "empresa_modulo"),
        migrations.RemoveField("operadorempresamodulo",     "operador"),
        migrations.RemoveField("operadorempresamodulomenu", "empresa_modulo_menu"),
        migrations.RemoveField("operadorempresamodulomenu", "operador"),
        migrations.RemoveField("operadorpuntoventa",        "empresa"),
        migrations.RemoveField("operadorpuntoventa",        "operador"),
        migrations.RemoveField("sesion",                    "empresa"),
        migrations.RemoveField("sesion",                    "operador_id"),
        migrations.RemoveField("sesionactiva",              "empresa"),
        migrations.RemoveField("sesionactiva",              "operador_id"),
        migrations.RemoveField("sesionactiva",              "sesion_id"),

        # ------------------------------------------------------------------ #
        # 7.  Nuevas FK con prefijo id_… (idéntico a la versión previa)      #
        # ------------------------------------------------------------------ #
        migrations.AddField(
            "operador", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                default=1,
            ),
        ),
        migrations.AddField(
            "operador", "id_grupo",
            models.ForeignKey(
                to="coreempresas.grupo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "operadorbodega", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_bodegas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorbodega", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="bodegas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulo", "id_empresa_modulo",
            models.ForeignKey(
                to="configuracion.empresamodulo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulo", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulomenu", "id_empresa_modulo_menu",
            models.ForeignKey(
                to="configuracion.empresamodulomenu",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulomenu", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorgrupo", "id_grupo",
            models.ForeignKey(
                to="coreempresas.grupo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorgrupo", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorpuntoventa", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_ventas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorpuntoventa", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_venta",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesion", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "sesion", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_sesion",
            models.ForeignKey(
                to="operadores.sesion",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                default=1,
            ),
        ),

        # ------------------------------------------------------------------ #
        # 8.  Ajuste de AutoField → columnas reales                           #
        # ------------------------------------------------------------------ #
        migrations.AlterField("operador",                 "id",
                              models.AutoField(primary_key=True, db_column="id_operador")),
        migrations.AlterField("operadorbodega",           "id",
                              models.AutoField(primary_key=True, db_column="id_operador_bodega")),
        migrations.AlterField("operadorempresamodulo",    "id",
                              models.AutoField(primary_key=True, db_column="id_operador_empresa_modulo")),
        migrations.AlterField("operadorempresamodulomenu","id",
                              models.AutoField(primary_key=True, db_column="id_operador_empresa_modulo_menu")),
        migrations.AlterField("operadorgrupo",            "id",
                              models.AutoField(primary_key=True, db_column="id_operador_grupo")),
        migrations.AlterField("operadorpuntoventa",       "id",
                              models.AutoField(primary_key=True, db_column="id_operador_punto_venta")),
        migrations.AlterField("sesion",                   "id",
                              models.AutoField(primary_key=True, db_column="id_sesion")),
        migrations.AlterField("sesionactiva",             "id",
                              models.AutoField(primary_key=True, db_column="id_sesion_activa")),

        # ------------------------------------------------------------------ #
        # 9.  Re‑crear los índices con los nombres definitivos               #
        # ------------------------------------------------------------------ #
        migrations.AddIndex("operador",
            models.Index(fields=["id_empresa"], name="idx_opr_emp_id")),
        migrations.AddIndex("operador",
            models.Index(fields=["id_grupo"],   name="idx_opr_grp_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_bodega"],  name="idx_opbdg_bdg_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_empresa"], name="idx_opbdg_emp_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_operador"], name="idx_opbdg_opr_id")),
        migrations.AddIndex("operadorempresamodulo",
            models.Index(fields=["id_operador"],        name="idx_oem_opr_id")),
        migrations.AddIndex("operadorempresamodulo",
            models.Index(fields=["id_empresa_modulo"],  name="idx_oem_em_id")),
        migrations.AddIndex("operadorempresamodulomenu",
            models.Index(fields=["id_operador"],            name="idx_oemm_opr_id")),
        migrations.AddIndex("operadorempresamodulomenu",
            models.Index(fields=["id_empresa_modulo_menu"], name="idx_oemm_mm_id")),
        migrations.AddIndex("operadorgrupo",
            models.Index(fields=["id_operador"], name="idx_opgr_opr_id")),
        migrations.AddIndex("operadorgrupo",
            models.Index(fields=["id_grupo"],    name="idx_opgr_grp_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_empresa"],     name="idx_opv_emp_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_punto_venta"], name="idx_opv_pv_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_operador"],    name="idx_opv_opr_id")),
        migrations.AddIndex("sesion",
            models.Index(fields=["id_empresa"],  name="idx_ses_emp_id")),
        migrations.AddIndex("sesion",
            models.Index(fields=["id_operador"], name="idx_ses_opr_id")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_sesion"],   name="idx_sact_sid")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_empresa"],  name="idx_sact_emp_id")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_operador"], name="idx_sact_opr_id")),
    ]


=== ./operadores/migrations/0002_sesionactiva_token.py ===
# Generated by Django 5.1.7 on 2025-03-31 14:41

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='sesionactiva',
            name='token',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
    ]


=== ./operadores/migrations/0003_sesionactiva_cod_verificacion.py ===
# Generated by Django 5.1.7 on 2025-04-01 18:06

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0002_sesionactiva_token'),
    ]

    operations = [
        migrations.AddField(
            model_name='sesionactiva',
            name='cod_verificacion',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
    ]


=== ./operadores/migrations/0008_alter_operadorbodega_id_empresa_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('configuracion', '0004_alter_empresamodulomenu_id_empresa_modulo_and_more'),
        ('coreempresas', '0004_alter_empresaparam_id_empresa_and_more'),
        ('operadores', '0007_alter_operador_id_empresa_alter_operador_id_grupo'),
    ]

    operations = [
        migrations.AlterField(
            model_name='operadorbodega',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_bodegas', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operadorbodega',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='bodegas', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulo',
            name='id_empresa_modulo',
            field=models.ForeignKey(db_column='id_empresa_modulo', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos', to='configuracion.empresamodulo'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulo',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulomenu',
            name='id_empresa_modulo_menu',
            field=models.ForeignKey(db_column='id_empresa_modulo_menu', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos_menus', to='configuracion.empresamodulomenu'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulomenu',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos_menus', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorgrupo',
            name='id_grupo',
            field=models.ForeignKey(db_column='id_grupo', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores_grupo', to='coreempresas.grupo'),
        ),
        migrations.AlterField(
            model_name='operadorgrupo',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores_grupo', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorpuntoventa',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_puntos_ventas', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operadorpuntoventa',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_puntos_venta', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesion',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='sesion',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion_activa', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_sesion',
            field=models.ForeignKey(db_column='id_sesion', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion_activa', to='operadores.sesion'),
        ),
    ]


=== ./operadores/migrations/0006_alter_operador_unique_together_and_more.py ===
# operadores/migrations/0006_alter_operador_unique_together_and_more.py
# -----------------------------------------------------------------------------
# Esta versión evita el error:
#   ValueError: Found wrong number (0) of constraints for "dm_sistema"."operador"
#               (username, empresa_id)
#
# ¿Qué cambia?
#   • Las dos operaciones `AlterUniqueTogether` se convierten en una única
#     operación `SeparateDatabaseAndState` que **solo** actúa sobre el *state*;
#     no hay modificación real en la base de datos, porque los constraints
#     ya fueron eliminados en la migración 0005 mediante SQL explícito.
#   • El resto del archivo se mantiene idéntico (AlterField, RemoveField, etc.).
# -----------------------------------------------------------------------------

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("configuracion", "0002_remove_empresamodulo_empresa_and_more"),
        ("coreempresas", "0003_remove_empresaparam_idx_empresa_param_campo"),
        ("operadores",  "0005_remove_operador_idx_opr_emp_id_and_more"),
    ]

    operations = [
        # ------------------------------------------------------------------ #
        # 1.  Actualizamos SOLO el estado para quitar unique_together         #
        # ------------------------------------------------------------------ #
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.AlterUniqueTogether(
                    name="operador",
                    unique_together=set(),
                ),
                migrations.AlterUniqueTogether(
                    name="operadorgrupo",
                    unique_together=set(),
                ),
            ],
        ),

        # ------------------------------------------------------------------ #
        # 2.  AlterField → columnas reales, y demás cambios previstos         #
        # ------------------------------------------------------------------ #
        migrations.AlterField(
            model_name="operador",
            name="id",
            field=models.AutoField(db_column="id_operador", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operador",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id",
            field=models.AutoField(db_column="id_operador_bodega", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_bodegas",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="bodegas",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id",
            field=models.AutoField(db_column="id_operador_empresa_modulo", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id_empresa_modulo",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                to="configuracion.empresamodulo",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id",
            field=models.AutoField(db_column="id_operador_empresa_modulo_menu", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id_empresa_modulo_menu",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                to="configuracion.empresamodulomenu",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id",
            field=models.AutoField(db_column="id_operador_grupo", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id_grupo",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                to="coreempresas.grupo",
            ),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id",
            field=models.AutoField(db_column="id_operador_punto_venta", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_ventas",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_venta",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesion",
            name="id",
            field=models.AutoField(db_column="id_sesion", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="sesion",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id",
            field=models.AutoField(db_column="id_sesion_activa", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id_sesion",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                to="operadores.sesion",
            ),
        ),

        # Eliminamos los campos viejos que aún quedaban en las tablas
        migrations.RemoveField(model_name="operador",      name="empresa"),
        migrations.RemoveField(model_name="operador",      name="grupo"),
        migrations.RemoveField(model_name="operadorgrupo", name="grupo"),
        migrations.RemoveField(model_name="operadorgrupo", name="operador"),
    ]


=== ./operadores/migrations/0004_delete_sesionejecutivo.py ===
# Generated by Django 5.1.7 on 2025-04-04 18:11

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0003_sesionactiva_cod_verificacion'),
    ]

    operations = [
        migrations.DeleteModel(
            name='SesionEjecutivo',
        ),
    ]


=== ./operadores/views.py ===
# ./operadores/views.py

from __future__ import annotations

import os
import jwt
import secrets
import requests
import crypt                              # misma sal BlowFish heredada
from datetime import datetime, timedelta

from django.conf import settings
from django.core.exceptions import PermissionDenied
from django.db import connection
from django.utils import timezone
from rest_framework import status, viewsets
from rest_framework.decorators import action
from rest_framework.response import Response

from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo,
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from .serializer import (
    OperadorSerializer, OperadorBodegaSerializer,
    OperadorEmpresaModuloSerializer, OperadorEmpresaModuloMenuSerializer,
    OperadorGrupoSerializer, OperadorPuntoVentaSerializer,
    SesionSerializer, SesionActivaSerializer,
    ProveedorSerializer            # ← añadimos import
)
from dm_logistica.models import Proveedor  # ← añadimos import


# ---------------------------------------------------------------------
#  CORS mínimo ─ permite varios orígenes (prod + dev) -----------------
# ---------------------------------------------------------------------
class RestrictToReactMixin:
    """
    Permite la petición solo si la cabecera **Origin** está incluida en
    la lista blanca.  
    · Si el navegador NO envía cabecera Origin (p.e. cURL / Postman)
      la solicitud se acepta.  
    · La lista se puede ampliar vía variable de entorno
      «ALLOWED_CORS_ORIGINS», separada por comas.
    """
    _BASE_ORIGINS = {
        "http://localhost:5173",          # desarrollo local
        "https://desarrollo.smartgest.cl" # build de desarrollo
    }

    # leemos orígenes extra definidos en variables de entorno
    EXTRA_ORIGINS = set(
        origin.strip()
        for origin in os.getenv("ALLOWED_CORS_ORIGINS", "").split(",")
        if origin.strip()
    )

    ALLOWED_ORIGINS = _BASE_ORIGINS | EXTRA_ORIGINS

    def initial(self, request, *args, **kwargs):
        origin = request.META.get("HTTP_ORIGIN")

        # «None» → llamada sin cabecera Origin (Postman, misma página, etc.)
        if origin is not None and origin not in self.ALLOWED_ORIGINS:
            raise PermissionDenied("Acceso denegado por CORS.")

        return super().initial(request, *args, **kwargs)


# ---------------------------------------------------------------------
#  utilidades auxiliares
# ---------------------------------------------------------------------
def enviar_correo_python(
    remitente: str, correo_destino: str, asunto: str, detalle: str
) -> None:
    """Consume el micro‑servicio PHP legado que envía correos."""
    try:
        requests.post(
            "http://mail.smartgest.cl/mailserver/server_mail.php",
            data={
                "destino": correo_destino,
                "asunto":  asunto,
                "detalle": detalle,
                "from":    remitente,
            },
            timeout=8,
        )
    except Exception as exc:                 # pragma: no cover
        print(f"[WARN] Falló el envío de correo: {exc}")


# ---------------------------------------------------------------------
#  VIEWSET PRINCIPAL  (login / 2FA / logout)
# ---------------------------------------------------------------------
class OperadorViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Operador.objects.all()
    serializer_class = OperadorSerializer

    # ============================================================== #
    # 1) LOGIN ------------------------------------------------------ #
    # ============================================================== #
    @action(detail=False, methods=["post"])
    def validar(self, request):
        """
        POST /operadores/operadores/validar/
        """
        username = request.data.get("username")
        password = request.data.get("password")

        if not username or not password:
            return Response(
                {"error": "Se requieren 'username' y 'password'."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        # ───────── validación de credenciales ─────────
        try:
            op = Operador.objects.get(username=username)
        except Operador.DoesNotExist:
            return Response(
                {"error": "No existe un operador con esos datos."},
                status=status.HTTP_404_NOT_FOUND,
            )

        if op.estado != 1:
            return Response(
                {"error": "El usuario no se encuentra activo."},
                status=status.HTTP_403_FORBIDDEN,
            )
        if op.id_empresa.estado != 1:
            return Response(
                {"error": "La empresa asociada al usuario no se encuentra activa."},
                status=status.HTTP_403_FORBIDDEN,
            )
        if op.conexion_fallida > 2:
            return Response(
                {"error": "Ha superado los intentos permitidos (3). Cuenta bloqueada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # contraseña (hash BlowFish heredado)
        if crypt.crypt(password, op.password) != op.password:
            op.conexion_fallida += 1
            op.save(update_fields=["conexion_fallida"])
            return Response(
                {"error": "Credenciales incorrectas."},
                status=status.HTTP_404_NOT_FOUND,
            )

        # reset de fallos
        if op.conexion_fallida:
            op.conexion_fallida = 0
            op.save(update_fields=["conexion_fallida"])

        # JWT por 24 h
        token = jwt.encode(
            {
                "id":       op.id,
                "username": op.username,
                "exp":      datetime.utcnow() + timedelta(hours=24),
            },
            settings.SECRET_KEY,
            algorithm="HS256",
        )

        # IP real
        ip = request.META.get("HTTP_X_FORWARDED_FOR",
                              request.META.get("REMOTE_ADDR", ""))
        if "," in ip:
            ip = ip.split(",")[0].strip()

        # sesión + 2FA
        sesion = Sesion.objects.create(
            ip=ip,
            fecha=timezone.now(),
            id_operador=op,
            id_empresa=op.id_empresa,
        )
        codigo = secrets.token_hex(16)
        SesionActiva.objects.create(
            id_operador=op,
            id_sesion=sesion,
            id_empresa=op.id_empresa,
            fecha_registro=timezone.now(),
            token=token,
            cod_verificacion=codigo,
        )

        enviar_correo_python(
            "DM", op.username, "Código de Verificación",
            f"Hola, tu código es: {codigo}"
        )

        return Response({"username": op.username}, status=status.HTTP_200_OK)

    # ============================================================== #
    # 2) 2FA / VERIFICAR ------------------------------------------- #
    # ============================================================== #
    @action(detail=False, methods=["post"])
    def verificar(self, request):
        """
        POST /operadores/operadores/verificar/
        """
        username = request.data.get("username")
        codigo   = request.data.get("cod_verificacion")

        if not username or not codigo:
            return Response(
                {"error": "Se requieren 'username' y 'cod_verificacion'."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        sesiones = (
            SesionActiva.objects
            .filter(id_operador__username=username)
            .order_by("-fecha_registro")
        )
        if not sesiones.exists():
            return Response(
                {"error": "No se encontró ninguna sesión activa para este operador."},
                status=status.HTTP_404_NOT_FOUND,
            )

        sesion_reciente = sesiones.first()
        if sesion_reciente.cod_verificacion != codigo:
            return Response(
                {"error": "El código de verificación no coincide."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        op = sesion_reciente.id_operador

        # dejamos solo la sesión validada
        SesionActiva.objects.filter(id_operador=op).exclude(
            id=sesion_reciente.id).delete()

        if op.id_empresa.estado != 1:
            sesion_reciente.delete()
            return Response(
                {"error": "La empresa asociada se encuentra desactivada. Sesión cerrada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # ------------------ módulos ------------------
        modulos = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT c.nombre_menu,
                       b.id_empresa_modulo,
                       c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador   = %s
                   AND b.estado        = 1
                   AND c.estado        = 1
                   AND b.id_empresa    = %s
              ORDER BY c.orden;
                """,
                [op.id, op.id_empresa_id],
            )
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append(
                    {"nombre_menu": nombre_menu, "id": id_em, "icon": icon}
                )

        # ---------------- funcionalidades -------------
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador          = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu            = m.id_menu
                 WHERE o.id_operador = %s;
                """,
                [op.id],
            )
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })

        # --- respuesta + cookie
        resp = Response(
            {
                "message": "Verificación exitosa.",
                "operador":        OperadorSerializer(op).data,
                "modulos":         modulos,
                "funcionalidades": funcionalidades,
            },
            status=status.HTTP_200_OK,
        )
        resp.set_cookie(
            "token",
            sesion_reciente.token,
            httponly=True,
            secure=True,
            max_age=24 * 3600,
            samesite="None",
        )
        return resp

    # ============================================================== #
    # 3) LOGOUT ----------------------------------------------------- #
    # ============================================================== #
    @action(detail=False, methods=["get"])
    def logout(self, request):
        token = request.COOKIES.get("token")
        if not token:
            return Response(
                {"error": "No se encontró la cookie 'token'."},
                status=status.HTTP_401_UNAUTHORIZED,
            )

        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Response(
                {"error": "El token de la cookie no coincide con ninguna sesión activa."},
                status=status.HTTP_404_NOT_FOUND,
            )

        # eliminamos TODAS las sesiones que compartan ese token
        sesiones.delete()

        resp = Response({"message": "Sesión eliminada correctamente."},
                        status=status.HTTP_200_OK)
        resp.delete_cookie("token")
        return resp


# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: ViewSet para Proveedores filtrados por la empresa del operador en sesión
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorEmpresaViewSet(RestrictToReactMixin, viewsets.ReadOnlyModelViewSet):
    """
    GET /operadores/ventas/operadores/proveedores-empresa/
    Devuelve los proveedores cuyo id_empresa coincide con la empresa del operador
    obtenido de la cookie 'token'.
    """
    serializer_class = ProveedorSerializer

    def get_queryset(self):
        token = self.request.COOKIES.get("token")
        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Proveedor.objects.none()
        sesion = sesiones.first()
        # id_empresa puede venir de la propia sesión o del operador
        empresa_id = sesion.id_empresa_id or sesion.id_operador.id_empresa_id
        return Proveedor.objects.filter(id_empresa_id=empresa_id)


# ---------------------------------------------------------------------
#  CRUD SIMPLES (sin cambios)
# ---------------------------------------------------------------------
class OperadorBodegaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorBodega.objects.all()
    serializer_class = OperadorBodegaSerializer


class OperadorEmpresaModuloViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModulo.objects.all()
    serializer_class = OperadorEmpresaModuloSerializer


class OperadorEmpresaModuloMenuViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModuloMenu.objects.all()
    serializer_class = OperadorEmpresaModuloMenuSerializer


class OperadorGrupoViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorGrupo.objects.all()
    serializer_class = OperadorGrupoSerializer


class OperadorPuntoVentaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorPuntoVenta.objects.all()
    serializer_class = OperadorPuntoVentaSerializer


class SesionViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Sesion.objects.all()
    serializer_class = SesionSerializer


class SesionActivaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = SesionActiva.objects.all()
    serializer_class = SesionActivaSerializer


# ---------------------------------------------------------------------
#  SESIÓN POR TOKEN ----------------------------------------------------
# ---------------------------------------------------------------------
class OperadorByTokenViewSet(RestrictToReactMixin, viewsets.ViewSet):
    """
    Devuelve la sesión activa (post‑2FA) a partir del token almacenado
    en la cookie 'token'.
    """

    def get_by_cookie(self, request):
        token_cookie = request.COOKIES.get("token")
        if not token_cookie:
            return Response(
                {"error": "No se encontró la cookie 'token'."},
                status=status.HTTP_401_UNAUTHORIZED,
            )

        # -- pueden existir varias filas con el mismo token si el usuario
        #    inició/verificó varias veces; usamos la más reciente y
        #    limpiamos el resto para evitar MultipleObjectsReturned.
        sesiones = (
            SesionActiva.objects
            .select_related("id_operador")
            .filter(token=token_cookie)
            .order_by("-fecha_registro")
        )
        if not sesiones.exists():
            return Response(
                {"error": "El token no coincide con ninguna sesión activa."},
                status=status.HTTP_404_NOT_FOUND,
            )

        sesion_activa = sesiones.first()
        if sesiones.count() > 1:
            sesiones.exclude(id=sesion_activa.id).delete()

        op = sesion_activa.id_operador

        if op.id_empresa.estado != 1:
            sesion_activa.delete()
            return Response(
                {"error": "La empresa asociada al usuario se encuentra desactivada. "
                          "La sesión ha sido cerrada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # ------------------ módulos ------------------
        modulos = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT c.nombre_menu,
                       b.id_empresa_modulo,
                       c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador = %s
                   AND b.estado      = 1
                   AND c.estado      = 1
                   AND b.id_empresa  = %s
              ORDER BY c.orden;
                """,
                [op.id, op.id_empresa_id],
            )
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append(
                    {"nombre_menu": nombre_menu, "id": id_em, "icon": icon}
                )

        # ---------------- funcionalidades -------------
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador          = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu            = m.id_menu
                 WHERE o.id_operador = %s;
                """,
                [op.id],
            )
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })

        return Response(
            {
                "sesion_activa":   SesionActivaSerializer(sesion_activa).data,
                "operador_data":   OperadorSerializer(op).data,
                "modulos":         modulos,
                "funcionalidades": funcionalidades,
            },
            status=status.HTTP_200_OK,
        )

=== ./operadores/models.py ===
from django.db import models
from django.utils import timezone

from coreempresas.models  import Grupo, Empresa
from configuracion.models import EmpresaModulo, EmpresaModuloMenu

# ---------------------------------------------------------------------
#  MODELO  : Operador
# ---------------------------------------------------------------------
class Operador(models.Model):
    id                   = models.AutoField(primary_key=True, db_column='id_operador')
    username             = models.CharField(max_length=50)
    password             = models.CharField(max_length=80, default='')
    clear                = models.CharField(max_length=80,  null=True, blank=True)
    rut                  = models.CharField(max_length=15,  null=True, blank=True)
    nombres              = models.CharField(max_length=100, null=True, blank=True)
    apellido_paterno     = models.CharField(max_length=100, null=True, blank=True)
    apellido_materno     = models.CharField(max_length=100, null=True, blank=True)
    modificable          = models.IntegerField(default=1)
    email                = models.CharField(max_length=50,  null=True, blank=True)
    estado               = models.IntegerField(default=1)
    acceso_web           = models.IntegerField(default=0)
    conexion_fallida     = models.IntegerField(default=0)
    operador_administrador = models.CharField(max_length=50, default='0')
    id_grupo             = models.ForeignKey(Grupo,   on_delete=models.RESTRICT, null=True, blank=True, related_name='operadores', db_column='id_grupo')
    id_empresa           = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='operadores', db_column='id_empresa')
    superadmin           = models.IntegerField(default=0)
    fecha_creacion       = models.DateTimeField(default=timezone.now)

    class Meta:
        db_table = '"dm_sistema"."operador"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_opr_emp_id'),
            models.Index(fields=['id_grupo'],   name='idx_opr_grp_id'),
        ]

    def __str__(self):
        return self.username


# ---------------------------------------------------------------------
#  MODELO  : OperadorBodega
# ---------------------------------------------------------------------
class OperadorBodega(models.Model):
    id           = models.AutoField(primary_key=True, db_column='id_operador_bodega')
    id_operador  = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='bodegas', db_column='id_operador')
    id_bodega    = models.IntegerField()
    id_empresa   = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, related_name='operador_bodegas', db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."operador_bodega"'
        indexes  = [
            models.Index(fields=['id_bodega'],  name='idx_opbdg_bdg_id'),
            models.Index(fields=['id_empresa'], name='idx_opbdg_emp_id'),
            models.Index(fields=['id_operador'], name='idx_opbdg_opr_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - Bodega {self.id_bodega}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorEmpresaModulo
# ---------------------------------------------------------------------
class OperadorEmpresaModulo(models.Model):
    id                = models.AutoField(primary_key=True, db_column='id_operador_empresa_modulo')
    id_operador       = models.ForeignKey(Operador,      on_delete=models.RESTRICT, related_name='operador_empresa_modulos', db_column='id_operador')
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, on_delete=models.RESTRICT, related_name='operador_empresa_modulos', db_column='id_empresa_modulo')

    class Meta:
        db_table = '"dm_sistema"."operador_empresa_modulos"'
        indexes  = [
            models.Index(fields=['id_operador'],       name='idx_oem_opr_id'),
            models.Index(fields=['id_empresa_modulo'], name='idx_oem_em_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_empresa_modulo}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorEmpresaModuloMenu
# ---------------------------------------------------------------------
class OperadorEmpresaModuloMenu(models.Model):
    id                     = models.AutoField(primary_key=True, db_column='id_operador_empresa_modulo_menu')
    id_operador            = models.ForeignKey(Operador,           on_delete=models.RESTRICT, related_name='operador_empresa_modulos_menus', db_column='id_operador')
    id_empresa_modulo_menu = models.ForeignKey(EmpresaModuloMenu,  on_delete=models.RESTRICT, related_name='operador_empresa_modulos_menus', db_column='id_empresa_modulo_menu')

    class Meta:
        db_table = '"dm_sistema"."operador_empresa_modulos_menu"'
        indexes  = [
            models.Index(fields=['id_operador'],            name='idx_oemm_opr_id'),
            models.Index(fields=['id_empresa_modulo_menu'], name='idx_oemm_mm_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_empresa_modulo_menu}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorGrupo
# ---------------------------------------------------------------------
class OperadorGrupo(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_operador_grupo')
    id_operador = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='operadores_grupo', db_column='id_operador')
    id_grupo    = models.ForeignKey(Grupo,    on_delete=models.RESTRICT, related_name='operadores_grupo', db_column='id_grupo')

    class Meta:
        db_table = '"dm_sistema"."operador_grupos"'
        indexes  = [
            models.Index(fields=['id_operador'], name='idx_opgr_opr_id'),
            models.Index(fields=['id_grupo'],    name='idx_opgr_grp_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_grupo}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorPuntoVenta
# ---------------------------------------------------------------------
class OperadorPuntoVenta(models.Model):
    id           = models.AutoField(primary_key=True, db_column='id_operador_punto_venta')
    id_operador  = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='operador_puntos_venta', db_column='id_operador')
    id_punto_venta = models.IntegerField()
    id_empresa   = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, related_name='operador_puntos_ventas', db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."operador_punto_venta"'
        indexes  = [
            models.Index(fields=['id_empresa'],     name='idx_opv_emp_id'),
            models.Index(fields=['id_punto_venta'], name='idx_opv_pv_id'),
            models.Index(fields=['id_operador'],    name='idx_opv_opr_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - Punto de Venta {self.id_punto_venta}'


# ---------------------------------------------------------------------
#  MODELO  : Sesion
# ---------------------------------------------------------------------
class Sesion(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_sesion')
    ip          = models.CharField(max_length=20)
    fecha       = models.DateTimeField()
    id_operador = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='sesion', db_column='id_operador')
    id_empresa  = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, null=True, blank=True, db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."sesiones"'
        indexes  = [
            models.Index(fields=['id_empresa'],  name='idx_ses_emp_id'),
            models.Index(fields=['id_operador'], name='idx_ses_opr_id'),
        ]

    def __str__(self):
        return f'Sesion {self.id} - {self.ip}'


# ---------------------------------------------------------------------
#  MODELO  : SesionActiva
# ---------------------------------------------------------------------
class SesionActiva(models.Model):
    id            = models.AutoField(primary_key=True, db_column='id_sesion_activa')
    id_empresa    = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, null=True, blank=True, db_column='id_empresa')
    id_operador   = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='sesion_activa', db_column='id_operador')
    id_sesion     = models.ForeignKey(Sesion,   on_delete=models.RESTRICT, related_name='sesion_activa', db_column='id_sesion')
    fecha_registro = models.DateTimeField(default=timezone.now)

    token          = models.CharField(max_length=255, null=True, blank=True)
    cod_verificacion = models.CharField(max_length=255, null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."sesiones_activas"'
        indexes  = [
            models.Index(fields=['id_sesion'],   name='idx_sact_sid'),
            models.Index(fields=['id_empresa'],  name='idx_sact_emp_id'),
            models.Index(fields=['id_operador'], name='idx_sact_opr_id'),
        ]

    def __str__(self):
        return f'Sesion Activa {self.id}'


=== ./operadores/tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./operadores/combined.txt ===


=== ./serializer.py ===
# ./operadores/serializer.py

from rest_framework import serializers
from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo, 
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from dm_logistica.models import Proveedor  # ← añadimos import

class OperadorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Operador
        fields = '__all__'

class OperadorBodegaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorBodega
        fields = '__all__'

class OperadorEmpresaModuloSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModulo
        fields = '__all__'

class OperadorEmpresaModuloMenuSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorEmpresaModuloMenu
        fields = '__all__'

class OperadorGrupoSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorGrupo
        fields = '__all__'

class OperadorPuntoVentaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OperadorPuntoVenta
        fields = '__all__'

class SesionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Sesion
        fields = '__all__'

class SesionActivaSerializer(serializers.ModelSerializer):
    class Meta:
        model = SesionActiva
        fields = '__all__'

# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: Serializer para Proveedor
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorSerializer(serializers.ModelSerializer):
    class Meta:
        model = Proveedor
        fields = '__all__'


=== ./admin.py ===
from django.contrib import admin

# Register your models here.


=== ./urls.py ===
# ./operadores/urls.py

from django.urls import path, include
from rest_framework import routers
from rest_framework.documentation import include_docs_urls

from .views import (
    OperadorViewSet, OperadorBodegaViewSet,
    OperadorEmpresaModuloViewSet, OperadorEmpresaModuloMenuViewSet,
    OperadorGrupoViewSet, OperadorPuntoVentaViewSet,
    SesionViewSet, SesionActivaViewSet,
    OperadorByTokenViewSet,
    ProveedorEmpresaViewSet      # ← ya registrado
)

router = routers.DefaultRouter()
router.register(r'operadores', OperadorViewSet, basename='operadores')
router.register(r'operadores-bodegas', OperadorBodegaViewSet, basename='operadores-bodegas')
router.register(r'operadores-empresa-modulos', OperadorEmpresaModuloViewSet, basename='operadores-empresa-modulos')
router.register(r'operadores-empresa-modulos-menus', OperadorEmpresaModuloMenuViewSet, basename='operadores-empresa-modulos-menus')
router.register(r'operadores-grupos', OperadorGrupoViewSet, basename='operadores-grupos')
router.register(r'operadores-punto-venta', OperadorPuntoVentaViewSet, basename='operadores-punto-venta')
router.register(r'sesiones', SesionViewSet, basename='sesiones')
router.register(r'sesiones-activas', SesionActivaViewSet, basename='sesiones-activas')
router.register(r'proveedores-empresa', ProveedorEmpresaViewSet, basename='proveedores-empresa')  # ← nueva ruta

urlpatterns = [
    path('', include(router.urls)),
    path('docs/', include_docs_urls(title='Operadores API')),
    path('sesiones-activas-token/',
         OperadorByTokenViewSet.as_view({'get': 'get_by_cookie'}),
         name='sesiones-activas-token-cookie'),
    path('logout/',
         OperadorViewSet.as_view({'get': 'logout'}),
         name='logout'),
]


=== ./__init__.py ===


=== ./migrations/__init__.py ===


=== ./migrations/0007_alter_operador_id_empresa_alter_operador_id_grupo.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:42

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('coreempresas', '0003_remove_empresaparam_idx_empresa_param_campo'),
        ('operadores', '0006_alter_operador_unique_together_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='operador',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operador',
            name='id_grupo',
            field=models.ForeignKey(blank=True, db_column='id_grupo', null=True, on_delete=django.db.models.deletion.RESTRICT, related_name='operadores', to='coreempresas.grupo'),
        ),
    ]


=== ./migrations/0001_initial.py ===
# Generated by Django 5.1.7 on 2025-03-28 13:21

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('configuracion', '0001_initial'),
        ('coreempresas', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Operador',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('operador_id', models.CharField(max_length=50)),
                ('password', models.CharField(default='', max_length=80)),
                ('clear', models.CharField(blank=True, max_length=80, null=True)),
                ('rut', models.CharField(blank=True, max_length=15, null=True)),
                ('nombres', models.CharField(blank=True, max_length=100, null=True)),
                ('apellido_paterno', models.CharField(blank=True, max_length=100, null=True)),
                ('apellido_materno', models.CharField(blank=True, max_length=100, null=True)),
                ('modificable', models.IntegerField(default=1)),
                ('email', models.CharField(blank=True, max_length=50, null=True)),
                ('estado', models.IntegerField(default=1)),
                ('acceso_web', models.IntegerField(default=0)),
                ('conexion_fallida', models.IntegerField(default=0)),
                ('operador_administrador', models.CharField(default='0', max_length=50)),
                ('superadmin', models.IntegerField(default=0)),
                ('fecha_creacion', models.DateTimeField(default=django.utils.timezone.now)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operadores', to='coreempresas.empresa')),
                ('grupo', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='operadores', to='coreempresas.grupo')),
            ],
            options={
                'db_table': '"dm_sistema"."operador"',
            },
        ),
        migrations.CreateModel(
            name='OperadorBodega',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('bodega_id', models.IntegerField()),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operador_bodegas', to='coreempresas.empresa')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bodegas', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_bodega"',
            },
        ),
        migrations.CreateModel(
            name='OperadorEmpresaModulo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('empresa_modulo', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='configuracion.empresamodulo')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_empresa_modulos"',
            },
        ),
        migrations.CreateModel(
            name='OperadorEmpresaModuloMenu',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('empresa_modulo_menu', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='configuracion.empresamodulomenu')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='empresa_modulos_menus', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_empresa_modulos_menu"',
            },
        ),
        migrations.CreateModel(
            name='OperadorGrupo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('grupo', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operadores_grupo', to='coreempresas.grupo')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='grupos_operador', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_grupos"',
            },
        ),
        migrations.CreateModel(
            name='OperadorPuntoVenta',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('punto_venta_id', models.IntegerField()),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='operador_punto_ventas', to='coreempresas.empresa')),
                ('operador', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='puntos_venta', to='operadores.operador')),
            ],
            options={
                'db_table': '"dm_sistema"."operador_punto_venta"',
            },
        ),
        migrations.CreateModel(
            name='Sesion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('ip', models.CharField(max_length=20)),
                ('fecha', models.DateTimeField()),
                ('operador_id', models.CharField(max_length=50)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones"',
            },
        ),
        migrations.CreateModel(
            name='SesionActiva',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('operador_id', models.CharField(blank=True, max_length=50, null=True)),
                ('sesion_id', models.CharField(blank=True, max_length=255, null=True)),
                ('fecha_registro', models.DateTimeField(default=django.utils.timezone.now)),
                ('empresa', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones_activas"',
            },
        ),
        migrations.CreateModel(
            name='SesionEjecutivo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha', models.DateTimeField()),
                ('id_ejecutivo', models.IntegerField()),
                ('rut_ejecutivo', models.CharField(blank=True, max_length=50, null=True)),
                ('id_operador', models.CharField(blank=True, max_length=50, null=True)),
                ('portal', models.CharField(blank=True, max_length=255, null=True)),
                ('ip', models.CharField(blank=True, max_length=50, null=True)),
                ('id_empresa', models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.CASCADE, to='coreempresas.empresa')),
            ],
            options={
                'db_table': '"dm_sistema"."sesiones_ejecutivos"',
            },
        ),
        migrations.AddIndex(
            model_name='operador',
            index=models.Index(fields=['empresa'], name='idx_opr_emp_id'),
        ),
        migrations.AddIndex(
            model_name='operador',
            index=models.Index(fields=['grupo'], name='idx_opr_grp_id'),
        ),
        migrations.AlterUniqueTogether(
            name='operador',
            unique_together={('operador_id', 'empresa')},
        ),
        migrations.AddIndex(
            model_name='operadorbodega',
            index=models.Index(fields=['bodega_id'], name='idx_opbdg_bdg_id'),
        ),
        migrations.AddIndex(
            model_name='operadorbodega',
            index=models.Index(fields=['empresa'], name='idx_opbdg_emp_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulo',
            index=models.Index(fields=['operador'], name='idx_oem_opr_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulo',
            index=models.Index(fields=['empresa_modulo'], name='idx_oem_em_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulomenu',
            index=models.Index(fields=['operador'], name='idx_oemm_opr_id'),
        ),
        migrations.AddIndex(
            model_name='operadorempresamodulomenu',
            index=models.Index(fields=['empresa_modulo_menu'], name='idx_oemm_mm_id'),
        ),
        migrations.AlterUniqueTogether(
            name='operadorgrupo',
            unique_together={('operador', 'grupo')},
        ),
        migrations.AddIndex(
            model_name='operadorpuntoventa',
            index=models.Index(fields=['empresa'], name='idx_opv_emp_id'),
        ),
        migrations.AddIndex(
            model_name='sesionactiva',
            index=models.Index(fields=['sesion_id'], name='idx_sact_sid'),
        ),
        migrations.AddIndex(
            model_name='sesionactiva',
            index=models.Index(fields=['empresa'], name='idx_sact_emp_id'),
        ),
        migrations.AddIndex(
            model_name='sesionejecutivo',
            index=models.Index(fields=['fecha'], name='idx_seseje_fecha'),
        ),
        migrations.AddIndex(
            model_name='sesionejecutivo',
            index=models.Index(fields=['portal'], name='idx_seseje_portal'),
        ),
    ]


=== ./migrations/0005_remove_operador_idx_opr_emp_id_and_more.py ===
# operadores/migrations/0005_remove_operador_idx_opr_emp_id_and_more.py
# -----------------------------------------------------------------------------
# Corrige definitivamente el error:
#     psycopg2.errors.DuplicateTable: relation "idx_opr_emp_id" already exists
#
# Idea clave → antes de recrear los índices eliminamos *cualquier* rastro
# del nombre, tanto en el esquema «dm_sistema» como en el search_path por
# defecto, de modo que AddIndex ya no colisione.
# -----------------------------------------------------------------------------

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("configuracion", "0002_remove_empresamodulo_empresa_and_more"),
        ("coreempresas",
         "0002_remove_empresaparam_idx_empresa_param_empresa_id_and_more"),
        ("operadores", "0004_delete_sesionejecutivo"),
    ]

    operations = [
        # ------------------------------------------------------------------ #
        # 0.  **NUEVO:** limpia cualquier índice huérfano antes de todo.     #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                DECLARE
                    idxname text := 'idx_opr_emp_id';
                BEGIN
                    -- en el esquema específico
                    EXECUTE format(
                        'DROP INDEX IF EXISTS %I.%I',
                        'dm_sistema', idxname
                    );
                    -- y en search_path
                    EXECUTE format(
                        'DROP INDEX IF EXISTS %I',
                        idxname
                    );
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 1.  Eliminar los índices “antiguos” declarados en 0001_initial.py   #
        # ------------------------------------------------------------------ #
        migrations.RemoveIndex(model_name="operador", name="idx_opr_emp_id"),
        migrations.RemoveIndex(model_name="operador", name="idx_opr_grp_id"),
        migrations.RemoveIndex(model_name="operadorbodega", name="idx_opbdg_bdg_id"),
        migrations.RemoveIndex(model_name="operadorbodega", name="idx_opbdg_emp_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulo", name="idx_oem_opr_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulo", name="idx_oem_em_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulomenu", name="idx_oemm_opr_id"),
        migrations.RemoveIndex(model_name="operadorempresamodulomenu", name="idx_oemm_mm_id"),
        migrations.RemoveIndex(model_name="operadorpuntoventa", name="idx_opv_emp_id"),
        migrations.RemoveIndex(model_name="sesionactiva", name="idx_sact_sid"),
        migrations.RemoveIndex(model_name="sesionactiva", name="idx_sact_emp_id"),

        # ------------------------------------------------------------------ #
        # 2.  Renombrar columnas (idéntico a la versión previa)               #
        # ------------------------------------------------------------------ #
        migrations.RenameField("operador",              "operador_id",     "username"),
        migrations.RenameField("operadorbodega",        "bodega_id",       "id_bodega"),
        migrations.RenameField("operadorpuntoventa",    "punto_venta_id",  "id_punto_venta"),

        # ------------------------------------------------------------------ #
        # 3‑4.  Eliminamos UNIQUE constraints obsoletos                       #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operador_operador_id_empresa_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador"
                        DROP CONSTRAINT operadores_operador_operador_id_empresa_id_uniq;
                    ELSIF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operador_username_empresa_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador"
                        DROP CONSTRAINT operadores_operador_username_empresa_id_uniq;
                    END IF;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        migrations.RunSQL(
            sql="""
                DO $$
                BEGIN
                    IF EXISTS (
                        SELECT 1 FROM pg_constraint
                         WHERE conrelid = '"dm_sistema"."operador_grupos"'::regclass
                           AND contype  = 'u'
                           AND conname  = 'operadores_operadorgr_operador_id_grupo_id_uniq'
                    ) THEN
                        ALTER TABLE "dm_sistema"."operador_grupos"
                        DROP CONSTRAINT operadores_operadorgr_operador_id_grupo_id_uniq;
                    END IF;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 5.  Limpieza exhaustiva de *todos* los índices potenciales          #
        # ------------------------------------------------------------------ #
        migrations.RunSQL(
            sql="""
                DO $$
                DECLARE
                    idx text;
                BEGIN
                    FOREACH idx IN ARRAY ARRAY[
                        'idx_opr_emp_id','idx_opr_grp_id',
                        'idx_opbdg_bdg_id','idx_opbdg_emp_id','idx_opbdg_opr_id',
                        'idx_oem_opr_id','idx_oem_em_id',
                        'idx_oemm_opr_id','idx_oemm_mm_id',
                        'idx_opgr_opr_id','idx_opgr_grp_id',
                        'idx_opv_emp_id','idx_opv_pv_id','idx_opv_opr_id',
                        'idx_ses_emp_id','idx_ses_opr_id',
                        'idx_sact_sid','idx_sact_emp_id','idx_sact_opr_id'
                    ] LOOP
                        -- en «dm_sistema»
                        EXECUTE format(
                            'DROP INDEX IF EXISTS %I.%I',
                            'dm_sistema', idx
                        );
                        -- y también sin esquema
                        EXECUTE format(
                            'DROP INDEX IF EXISTS %I',
                            idx
                        );
                    END LOOP;
                END$$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),

        # ------------------------------------------------------------------ #
        # 6.  Eliminación de FK viejas (sin cambios)                          #
        # ------------------------------------------------------------------ #
        migrations.RemoveField("operadorbodega",            "empresa"),
        migrations.RemoveField("operadorbodega",            "operador"),
        migrations.RemoveField("operadorempresamodulo",     "empresa_modulo"),
        migrations.RemoveField("operadorempresamodulo",     "operador"),
        migrations.RemoveField("operadorempresamodulomenu", "empresa_modulo_menu"),
        migrations.RemoveField("operadorempresamodulomenu", "operador"),
        migrations.RemoveField("operadorpuntoventa",        "empresa"),
        migrations.RemoveField("operadorpuntoventa",        "operador"),
        migrations.RemoveField("sesion",                    "empresa"),
        migrations.RemoveField("sesion",                    "operador_id"),
        migrations.RemoveField("sesionactiva",              "empresa"),
        migrations.RemoveField("sesionactiva",              "operador_id"),
        migrations.RemoveField("sesionactiva",              "sesion_id"),

        # ------------------------------------------------------------------ #
        # 7.  Nuevas FK con prefijo id_… (idéntico a la versión previa)      #
        # ------------------------------------------------------------------ #
        migrations.AddField(
            "operador", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                default=1,
            ),
        ),
        migrations.AddField(
            "operador", "id_grupo",
            models.ForeignKey(
                to="coreempresas.grupo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "operadorbodega", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_bodegas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorbodega", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="bodegas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulo", "id_empresa_modulo",
            models.ForeignKey(
                to="configuracion.empresamodulo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulo", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulomenu", "id_empresa_modulo_menu",
            models.ForeignKey(
                to="configuracion.empresamodulomenu",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorempresamodulomenu", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorgrupo", "id_grupo",
            models.ForeignKey(
                to="coreempresas.grupo",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorgrupo", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorpuntoventa", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_ventas",
                default=1,
            ),
        ),
        migrations.AddField(
            "operadorpuntoventa", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_venta",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesion", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "sesion", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_empresa",
            models.ForeignKey(
                to="coreempresas.empresa",
                on_delete=django.db.models.deletion.RESTRICT,
                null=True, blank=True,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_operador",
            models.ForeignKey(
                to="operadores.operador",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                default=1,
            ),
        ),
        migrations.AddField(
            "sesionactiva", "id_sesion",
            models.ForeignKey(
                to="operadores.sesion",
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                default=1,
            ),
        ),

        # ------------------------------------------------------------------ #
        # 8.  Ajuste de AutoField → columnas reales                           #
        # ------------------------------------------------------------------ #
        migrations.AlterField("operador",                 "id",
                              models.AutoField(primary_key=True, db_column="id_operador")),
        migrations.AlterField("operadorbodega",           "id",
                              models.AutoField(primary_key=True, db_column="id_operador_bodega")),
        migrations.AlterField("operadorempresamodulo",    "id",
                              models.AutoField(primary_key=True, db_column="id_operador_empresa_modulo")),
        migrations.AlterField("operadorempresamodulomenu","id",
                              models.AutoField(primary_key=True, db_column="id_operador_empresa_modulo_menu")),
        migrations.AlterField("operadorgrupo",            "id",
                              models.AutoField(primary_key=True, db_column="id_operador_grupo")),
        migrations.AlterField("operadorpuntoventa",       "id",
                              models.AutoField(primary_key=True, db_column="id_operador_punto_venta")),
        migrations.AlterField("sesion",                   "id",
                              models.AutoField(primary_key=True, db_column="id_sesion")),
        migrations.AlterField("sesionactiva",             "id",
                              models.AutoField(primary_key=True, db_column="id_sesion_activa")),

        # ------------------------------------------------------------------ #
        # 9.  Re‑crear los índices con los nombres definitivos               #
        # ------------------------------------------------------------------ #
        migrations.AddIndex("operador",
            models.Index(fields=["id_empresa"], name="idx_opr_emp_id")),
        migrations.AddIndex("operador",
            models.Index(fields=["id_grupo"],   name="idx_opr_grp_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_bodega"],  name="idx_opbdg_bdg_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_empresa"], name="idx_opbdg_emp_id")),
        migrations.AddIndex("operadorbodega",
            models.Index(fields=["id_operador"], name="idx_opbdg_opr_id")),
        migrations.AddIndex("operadorempresamodulo",
            models.Index(fields=["id_operador"],        name="idx_oem_opr_id")),
        migrations.AddIndex("operadorempresamodulo",
            models.Index(fields=["id_empresa_modulo"],  name="idx_oem_em_id")),
        migrations.AddIndex("operadorempresamodulomenu",
            models.Index(fields=["id_operador"],            name="idx_oemm_opr_id")),
        migrations.AddIndex("operadorempresamodulomenu",
            models.Index(fields=["id_empresa_modulo_menu"], name="idx_oemm_mm_id")),
        migrations.AddIndex("operadorgrupo",
            models.Index(fields=["id_operador"], name="idx_opgr_opr_id")),
        migrations.AddIndex("operadorgrupo",
            models.Index(fields=["id_grupo"],    name="idx_opgr_grp_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_empresa"],     name="idx_opv_emp_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_punto_venta"], name="idx_opv_pv_id")),
        migrations.AddIndex("operadorpuntoventa",
            models.Index(fields=["id_operador"],    name="idx_opv_opr_id")),
        migrations.AddIndex("sesion",
            models.Index(fields=["id_empresa"],  name="idx_ses_emp_id")),
        migrations.AddIndex("sesion",
            models.Index(fields=["id_operador"], name="idx_ses_opr_id")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_sesion"],   name="idx_sact_sid")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_empresa"],  name="idx_sact_emp_id")),
        migrations.AddIndex("sesionactiva",
            models.Index(fields=["id_operador"], name="idx_sact_opr_id")),
    ]


=== ./migrations/0002_sesionactiva_token.py ===
# Generated by Django 5.1.7 on 2025-03-31 14:41

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='sesionactiva',
            name='token',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
    ]


=== ./migrations/0003_sesionactiva_cod_verificacion.py ===
# Generated by Django 5.1.7 on 2025-04-01 18:06

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0002_sesionactiva_token'),
    ]

    operations = [
        migrations.AddField(
            model_name='sesionactiva',
            name='cod_verificacion',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
    ]


=== ./migrations/0008_alter_operadorbodega_id_empresa_and_more.py ===
# Generated by Django 5.1.7 on 2025-04-17 14:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('configuracion', '0004_alter_empresamodulomenu_id_empresa_modulo_and_more'),
        ('coreempresas', '0004_alter_empresaparam_id_empresa_and_more'),
        ('operadores', '0007_alter_operador_id_empresa_alter_operador_id_grupo'),
    ]

    operations = [
        migrations.AlterField(
            model_name='operadorbodega',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_bodegas', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operadorbodega',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='bodegas', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulo',
            name='id_empresa_modulo',
            field=models.ForeignKey(db_column='id_empresa_modulo', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos', to='configuracion.empresamodulo'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulo',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulomenu',
            name='id_empresa_modulo_menu',
            field=models.ForeignKey(db_column='id_empresa_modulo_menu', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos_menus', to='configuracion.empresamodulomenu'),
        ),
        migrations.AlterField(
            model_name='operadorempresamodulomenu',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_empresa_modulos_menus', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorgrupo',
            name='id_grupo',
            field=models.ForeignKey(db_column='id_grupo', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores_grupo', to='coreempresas.grupo'),
        ),
        migrations.AlterField(
            model_name='operadorgrupo',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operadores_grupo', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='operadorpuntoventa',
            name='id_empresa',
            field=models.ForeignKey(db_column='id_empresa', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_puntos_ventas', to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='operadorpuntoventa',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='operador_puntos_venta', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesion',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='sesion',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_empresa',
            field=models.ForeignKey(blank=True, db_column='id_empresa', null=True, on_delete=django.db.models.deletion.RESTRICT, to='coreempresas.empresa'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_operador',
            field=models.ForeignKey(db_column='id_operador', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion_activa', to='operadores.operador'),
        ),
        migrations.AlterField(
            model_name='sesionactiva',
            name='id_sesion',
            field=models.ForeignKey(db_column='id_sesion', on_delete=django.db.models.deletion.RESTRICT, related_name='sesion_activa', to='operadores.sesion'),
        ),
    ]


=== ./migrations/0006_alter_operador_unique_together_and_more.py ===
# operadores/migrations/0006_alter_operador_unique_together_and_more.py
# -----------------------------------------------------------------------------
# Esta versión evita el error:
#   ValueError: Found wrong number (0) of constraints for "dm_sistema"."operador"
#               (username, empresa_id)
#
# ¿Qué cambia?
#   • Las dos operaciones `AlterUniqueTogether` se convierten en una única
#     operación `SeparateDatabaseAndState` que **solo** actúa sobre el *state*;
#     no hay modificación real en la base de datos, porque los constraints
#     ya fueron eliminados en la migración 0005 mediante SQL explícito.
#   • El resto del archivo se mantiene idéntico (AlterField, RemoveField, etc.).
# -----------------------------------------------------------------------------

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("configuracion", "0002_remove_empresamodulo_empresa_and_more"),
        ("coreempresas", "0003_remove_empresaparam_idx_empresa_param_campo"),
        ("operadores",  "0005_remove_operador_idx_opr_emp_id_and_more"),
    ]

    operations = [
        # ------------------------------------------------------------------ #
        # 1.  Actualizamos SOLO el estado para quitar unique_together         #
        # ------------------------------------------------------------------ #
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.AlterUniqueTogether(
                    name="operador",
                    unique_together=set(),
                ),
                migrations.AlterUniqueTogether(
                    name="operadorgrupo",
                    unique_together=set(),
                ),
            ],
        ),

        # ------------------------------------------------------------------ #
        # 2.  AlterField → columnas reales, y demás cambios previstos         #
        # ------------------------------------------------------------------ #
        migrations.AlterField(
            model_name="operador",
            name="id",
            field=models.AutoField(db_column="id_operador", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operador",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id",
            field=models.AutoField(db_column="id_operador_bodega", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_bodegas",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorbodega",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="bodegas",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id",
            field=models.AutoField(db_column="id_operador_empresa_modulo", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id_empresa_modulo",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                to="configuracion.empresamodulo",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulo",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id",
            field=models.AutoField(db_column="id_operador_empresa_modulo_menu", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id_empresa_modulo_menu",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                to="configuracion.empresamodulomenu",
            ),
        ),
        migrations.AlterField(
            model_name="operadorempresamodulomenu",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_empresa_modulos_menus",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id",
            field=models.AutoField(db_column="id_operador_grupo", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id_grupo",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                to="coreempresas.grupo",
            ),
        ),
        migrations.AlterField(
            model_name="operadorgrupo",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operadores_grupo",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id",
            field=models.AutoField(db_column="id_operador_punto_venta", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id_empresa",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_ventas",
                to="coreempresas.empresa",
            ),
        ),
        migrations.AlterField(
            model_name="operadorpuntoventa",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="operador_puntos_venta",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesion",
            name="id",
            field=models.AutoField(db_column="id_sesion", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="sesion",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id",
            field=models.AutoField(db_column="id_sesion_activa", primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id_operador",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                to="operadores.operador",
            ),
        ),
        migrations.AlterField(
            model_name="sesionactiva",
            name="id_sesion",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="sesion_activa",
                to="operadores.sesion",
            ),
        ),

        # Eliminamos los campos viejos que aún quedaban en las tablas
        migrations.RemoveField(model_name="operador",      name="empresa"),
        migrations.RemoveField(model_name="operador",      name="grupo"),
        migrations.RemoveField(model_name="operadorgrupo", name="grupo"),
        migrations.RemoveField(model_name="operadorgrupo", name="operador"),
    ]


=== ./migrations/0004_delete_sesionejecutivo.py ===
# Generated by Django 5.1.7 on 2025-04-04 18:11

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('operadores', '0003_sesionactiva_cod_verificacion'),
    ]

    operations = [
        migrations.DeleteModel(
            name='SesionEjecutivo',
        ),
    ]


=== ./views.py ===
# ./operadores/views.py

from __future__ import annotations

import os
import jwt
import secrets
import requests
import crypt                              # misma sal BlowFish heredada
from datetime import datetime, timedelta

from django.conf import settings
from django.core.exceptions import PermissionDenied
from django.db import connection
from django.utils import timezone
from rest_framework import status, viewsets
from rest_framework.decorators import action
from rest_framework.response import Response

from .models import (
    Operador, OperadorBodega, OperadorEmpresaModulo,
    OperadorEmpresaModuloMenu, OperadorGrupo, OperadorPuntoVenta,
    Sesion, SesionActiva
)
from .serializer import (
    OperadorSerializer, OperadorBodegaSerializer,
    OperadorEmpresaModuloSerializer, OperadorEmpresaModuloMenuSerializer,
    OperadorGrupoSerializer, OperadorPuntoVentaSerializer,
    SesionSerializer, SesionActivaSerializer,
    ProveedorSerializer            # ← añadimos import
)
from dm_logistica.models import Proveedor  # ← añadimos import


# ---------------------------------------------------------------------
#  CORS mínimo ─ permite varios orígenes (prod + dev) -----------------
# ---------------------------------------------------------------------
class RestrictToReactMixin:
    """
    Permite la petición solo si la cabecera **Origin** está incluida en
    la lista blanca.  
    · Si el navegador NO envía cabecera Origin (p.e. cURL / Postman)
      la solicitud se acepta.  
    · La lista se puede ampliar vía variable de entorno
      «ALLOWED_CORS_ORIGINS», separada por comas.
    """
    _BASE_ORIGINS = {
        "http://localhost:5173",          # desarrollo local
        "https://desarrollo.smartgest.cl" # build de desarrollo
    }

    # leemos orígenes extra definidos en variables de entorno
    EXTRA_ORIGINS = set(
        origin.strip()
        for origin in os.getenv("ALLOWED_CORS_ORIGINS", "").split(",")
        if origin.strip()
    )

    ALLOWED_ORIGINS = _BASE_ORIGINS | EXTRA_ORIGINS

    def initial(self, request, *args, **kwargs):
        origin = request.META.get("HTTP_ORIGIN")

        # «None» → llamada sin cabecera Origin (Postman, misma página, etc.)
        if origin is not None and origin not in self.ALLOWED_ORIGINS:
            raise PermissionDenied("Acceso denegado por CORS.")

        return super().initial(request, *args, **kwargs)


# ---------------------------------------------------------------------
#  utilidades auxiliares
# ---------------------------------------------------------------------
def enviar_correo_python(
    remitente: str, correo_destino: str, asunto: str, detalle: str
) -> None:
    """Consume el micro‑servicio PHP legado que envía correos."""
    try:
        requests.post(
            "http://mail.smartgest.cl/mailserver/server_mail.php",
            data={
                "destino": correo_destino,
                "asunto":  asunto,
                "detalle": detalle,
                "from":    remitente,
            },
            timeout=8,
        )
    except Exception as exc:                 # pragma: no cover
        print(f"[WARN] Falló el envío de correo: {exc}")


# ---------------------------------------------------------------------
#  VIEWSET PRINCIPAL  (login / 2FA / logout)
# ---------------------------------------------------------------------
class OperadorViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Operador.objects.all()
    serializer_class = OperadorSerializer

    # ============================================================== #
    # 1) LOGIN ------------------------------------------------------ #
    # ============================================================== #
    @action(detail=False, methods=["post"])
    def validar(self, request):
        """
        POST /operadores/operadores/validar/
        """
        username = request.data.get("username")
        password = request.data.get("password")

        if not username or not password:
            return Response(
                {"error": "Se requieren 'username' y 'password'."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        # ───────── validación de credenciales ─────────
        try:
            op = Operador.objects.get(username=username)
        except Operador.DoesNotExist:
            return Response(
                {"error": "No existe un operador con esos datos."},
                status=status.HTTP_404_NOT_FOUND,
            )

        if op.estado != 1:
            return Response(
                {"error": "El usuario no se encuentra activo."},
                status=status.HTTP_403_FORBIDDEN,
            )
        if op.id_empresa.estado != 1:
            return Response(
                {"error": "La empresa asociada al usuario no se encuentra activa."},
                status=status.HTTP_403_FORBIDDEN,
            )
        if op.conexion_fallida > 2:
            return Response(
                {"error": "Ha superado los intentos permitidos (3). Cuenta bloqueada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # contraseña (hash BlowFish heredado)
        if crypt.crypt(password, op.password) != op.password:
            op.conexion_fallida += 1
            op.save(update_fields=["conexion_fallida"])
            return Response(
                {"error": "Credenciales incorrectas."},
                status=status.HTTP_404_NOT_FOUND,
            )

        # reset de fallos
        if op.conexion_fallida:
            op.conexion_fallida = 0
            op.save(update_fields=["conexion_fallida"])

        # JWT por 24 h
        token = jwt.encode(
            {
                "id":       op.id,
                "username": op.username,
                "exp":      datetime.utcnow() + timedelta(hours=24),
            },
            settings.SECRET_KEY,
            algorithm="HS256",
        )

        # IP real
        ip = request.META.get("HTTP_X_FORWARDED_FOR",
                              request.META.get("REMOTE_ADDR", ""))
        if "," in ip:
            ip = ip.split(",")[0].strip()

        # sesión + 2FA
        sesion = Sesion.objects.create(
            ip=ip,
            fecha=timezone.now(),
            id_operador=op,
            id_empresa=op.id_empresa,
        )
        codigo = secrets.token_hex(16)
        SesionActiva.objects.create(
            id_operador=op,
            id_sesion=sesion,
            id_empresa=op.id_empresa,
            fecha_registro=timezone.now(),
            token=token,
            cod_verificacion=codigo,
        )

        enviar_correo_python(
            "DM", op.username, "Código de Verificación",
            f"Hola, tu código es: {codigo}"
        )

        return Response({"username": op.username}, status=status.HTTP_200_OK)

    # ============================================================== #
    # 2) 2FA / VERIFICAR ------------------------------------------- #
    # ============================================================== #
    @action(detail=False, methods=["post"])
    def verificar(self, request):
        """
        POST /operadores/operadores/verificar/
        """
        username = request.data.get("username")
        codigo   = request.data.get("cod_verificacion")

        if not username or not codigo:
            return Response(
                {"error": "Se requieren 'username' y 'cod_verificacion'."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        sesiones = (
            SesionActiva.objects
            .filter(id_operador__username=username)
            .order_by("-fecha_registro")
        )
        if not sesiones.exists():
            return Response(
                {"error": "No se encontró ninguna sesión activa para este operador."},
                status=status.HTTP_404_NOT_FOUND,
            )

        sesion_reciente = sesiones.first()
        if sesion_reciente.cod_verificacion != codigo:
            return Response(
                {"error": "El código de verificación no coincide."},
                status=status.HTTP_400_BAD_REQUEST,
            )

        op = sesion_reciente.id_operador

        # dejamos solo la sesión validada
        SesionActiva.objects.filter(id_operador=op).exclude(
            id=sesion_reciente.id).delete()

        if op.id_empresa.estado != 1:
            sesion_reciente.delete()
            return Response(
                {"error": "La empresa asociada se encuentra desactivada. Sesión cerrada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # ------------------ módulos ------------------
        modulos = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT c.nombre_menu,
                       b.id_empresa_modulo,
                       c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador   = %s
                   AND b.estado        = 1
                   AND c.estado        = 1
                   AND b.id_empresa    = %s
              ORDER BY c.orden;
                """,
                [op.id, op.id_empresa_id],
            )
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append(
                    {"nombre_menu": nombre_menu, "id": id_em, "icon": icon}
                )

        # ---------------- funcionalidades -------------
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador          = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu            = m.id_menu
                 WHERE o.id_operador = %s;
                """,
                [op.id],
            )
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })

        # --- respuesta + cookie
        resp = Response(
            {
                "message": "Verificación exitosa.",
                "operador":        OperadorSerializer(op).data,
                "modulos":         modulos,
                "funcionalidades": funcionalidades,
            },
            status=status.HTTP_200_OK,
        )
        resp.set_cookie(
            "token",
            sesion_reciente.token,
            httponly=True,
            secure=True,
            max_age=24 * 3600,
            samesite="None",
        )
        return resp

    # ============================================================== #
    # 3) LOGOUT ----------------------------------------------------- #
    # ============================================================== #
    @action(detail=False, methods=["get"])
    def logout(self, request):
        token = request.COOKIES.get("token")
        if not token:
            return Response(
                {"error": "No se encontró la cookie 'token'."},
                status=status.HTTP_401_UNAUTHORIZED,
            )

        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Response(
                {"error": "El token de la cookie no coincide con ninguna sesión activa."},
                status=status.HTTP_404_NOT_FOUND,
            )

        # eliminamos TODAS las sesiones que compartan ese token
        sesiones.delete()

        resp = Response({"message": "Sesión eliminada correctamente."},
                        status=status.HTTP_200_OK)
        resp.delete_cookie("token")
        return resp


# ─────────────────────────────────────────────────────────────────────────────
# NUEVO: ViewSet para Proveedores filtrados por la empresa del operador en sesión
# ─────────────────────────────────────────────────────────────────────────────
class ProveedorEmpresaViewSet(RestrictToReactMixin, viewsets.ReadOnlyModelViewSet):
    """
    GET /operadores/ventas/operadores/proveedores-empresa/
    Devuelve los proveedores cuyo id_empresa coincide con la empresa del operador
    obtenido de la cookie 'token'.
    """
    serializer_class = ProveedorSerializer

    def get_queryset(self):
        token = self.request.COOKIES.get("token")
        sesiones = SesionActiva.objects.filter(token=token).order_by("-fecha_registro")
        if not sesiones.exists():
            return Proveedor.objects.none()
        sesion = sesiones.first()
        # id_empresa puede venir de la propia sesión o del operador
        empresa_id = sesion.id_empresa_id or sesion.id_operador.id_empresa_id
        return Proveedor.objects.filter(id_empresa_id=empresa_id)


# ---------------------------------------------------------------------
#  CRUD SIMPLES (sin cambios)
# ---------------------------------------------------------------------
class OperadorBodegaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorBodega.objects.all()
    serializer_class = OperadorBodegaSerializer


class OperadorEmpresaModuloViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModulo.objects.all()
    serializer_class = OperadorEmpresaModuloSerializer


class OperadorEmpresaModuloMenuViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorEmpresaModuloMenu.objects.all()
    serializer_class = OperadorEmpresaModuloMenuSerializer


class OperadorGrupoViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorGrupo.objects.all()
    serializer_class = OperadorGrupoSerializer


class OperadorPuntoVentaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = OperadorPuntoVenta.objects.all()
    serializer_class = OperadorPuntoVentaSerializer


class SesionViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = Sesion.objects.all()
    serializer_class = SesionSerializer


class SesionActivaViewSet(RestrictToReactMixin, viewsets.ModelViewSet):
    queryset = SesionActiva.objects.all()
    serializer_class = SesionActivaSerializer


# ---------------------------------------------------------------------
#  SESIÓN POR TOKEN ----------------------------------------------------
# ---------------------------------------------------------------------
class OperadorByTokenViewSet(RestrictToReactMixin, viewsets.ViewSet):
    """
    Devuelve la sesión activa (post‑2FA) a partir del token almacenado
    en la cookie 'token'.
    """

    def get_by_cookie(self, request):
        token_cookie = request.COOKIES.get("token")
        if not token_cookie:
            return Response(
                {"error": "No se encontró la cookie 'token'."},
                status=status.HTTP_401_UNAUTHORIZED,
            )

        # -- pueden existir varias filas con el mismo token si el usuario
        #    inició/verificó varias veces; usamos la más reciente y
        #    limpiamos el resto para evitar MultipleObjectsReturned.
        sesiones = (
            SesionActiva.objects
            .select_related("id_operador")
            .filter(token=token_cookie)
            .order_by("-fecha_registro")
        )
        if not sesiones.exists():
            return Response(
                {"error": "El token no coincide con ninguna sesión activa."},
                status=status.HTTP_404_NOT_FOUND,
            )

        sesion_activa = sesiones.first()
        if sesiones.count() > 1:
            sesiones.exclude(id=sesion_activa.id).delete()

        op = sesion_activa.id_operador

        if op.id_empresa.estado != 1:
            sesion_activa.delete()
            return Response(
                {"error": "La empresa asociada al usuario se encuentra desactivada. "
                          "La sesión ha sido cerrada."},
                status=status.HTTP_403_FORBIDDEN,
            )

        # ------------------ módulos ------------------
        modulos = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT c.nombre_menu,
                       b.id_empresa_modulo,
                       c.icon
                  FROM dm_sistema.operador_empresa_modulos     a
            INNER JOIN dm_sistema.empresa_modulos           b
                    ON a.id_empresa_modulo = b.id_empresa_modulo
            INNER JOIN dm_sistema.modulos                   c
                    ON b.id_modulo         = c.id_modulo
                 WHERE a.id_operador = %s
                   AND b.estado      = 1
                   AND c.estado      = 1
                   AND b.id_empresa  = %s
              ORDER BY c.orden;
                """,
                [op.id, op.id_empresa_id],
            )
            for nombre_menu, id_em, icon in cur.fetchall():
                modulos.append(
                    {"nombre_menu": nombre_menu, "id": id_em, "icon": icon}
                )

        # ---------------- funcionalidades -------------
        funcionalidades = []
        with connection.cursor() as cur:
            cur.execute(
                """
                SELECT m.id_menu, m.url, m.texto, m.etiqueta, m.descripcion,
                       m.nivel_menu, m.orden, m.modificable, m.separador_up,
                       m.id_modulo
                  FROM dm_sistema.operador                           o
            INNER JOIN dm_sistema.operador_empresa_modulos_menu    oemm
                    ON o.id_operador          = oemm.id_operador
            INNER JOIN dm_sistema.empresa_modulos_menu             emm
                    ON oemm.id_empresa_modulo_menu = emm.id_empresa_modulo_menu
            INNER JOIN dm_sistema.menus                            m
                    ON emm.id_menu            = m.id_menu
                 WHERE o.id_operador = %s;
                """,
                [op.id],
            )
            for row in cur.fetchall():
                funcionalidades.append({
                    "id":           row[0],
                    "url":          row[1],
                    "texto":        row[2],
                    "etiqueta":     row[3],
                    "descripcion":  row[4],
                    "nivel_menu":   row[5],
                    "orden":        row[6],
                    "modificable":  row[7],
                    "separador_up": row[8],
                    "modulo_id":    row[9],
                })

        return Response(
            {
                "sesion_activa":   SesionActivaSerializer(sesion_activa).data,
                "operador_data":   OperadorSerializer(op).data,
                "modulos":         modulos,
                "funcionalidades": funcionalidades,
            },
            status=status.HTTP_200_OK,
        )

=== ./models.py ===
from django.db import models
from django.utils import timezone

from coreempresas.models  import Grupo, Empresa
from configuracion.models import EmpresaModulo, EmpresaModuloMenu

# ---------------------------------------------------------------------
#  MODELO  : Operador
# ---------------------------------------------------------------------
class Operador(models.Model):
    id                   = models.AutoField(primary_key=True, db_column='id_operador')
    username             = models.CharField(max_length=50)
    password             = models.CharField(max_length=80, default='')
    clear                = models.CharField(max_length=80,  null=True, blank=True)
    rut                  = models.CharField(max_length=15,  null=True, blank=True)
    nombres              = models.CharField(max_length=100, null=True, blank=True)
    apellido_paterno     = models.CharField(max_length=100, null=True, blank=True)
    apellido_materno     = models.CharField(max_length=100, null=True, blank=True)
    modificable          = models.IntegerField(default=1)
    email                = models.CharField(max_length=50,  null=True, blank=True)
    estado               = models.IntegerField(default=1)
    acceso_web           = models.IntegerField(default=0)
    conexion_fallida     = models.IntegerField(default=0)
    operador_administrador = models.CharField(max_length=50, default='0')
    id_grupo             = models.ForeignKey(Grupo,   on_delete=models.RESTRICT, null=True, blank=True, related_name='operadores', db_column='id_grupo')
    id_empresa           = models.ForeignKey(Empresa, on_delete=models.RESTRICT, related_name='operadores', db_column='id_empresa')
    superadmin           = models.IntegerField(default=0)
    fecha_creacion       = models.DateTimeField(default=timezone.now)

    class Meta:
        db_table = '"dm_sistema"."operador"'
        indexes  = [
            models.Index(fields=['id_empresa'], name='idx_opr_emp_id'),
            models.Index(fields=['id_grupo'],   name='idx_opr_grp_id'),
        ]

    def __str__(self):
        return self.username


# ---------------------------------------------------------------------
#  MODELO  : OperadorBodega
# ---------------------------------------------------------------------
class OperadorBodega(models.Model):
    id           = models.AutoField(primary_key=True, db_column='id_operador_bodega')
    id_operador  = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='bodegas', db_column='id_operador')
    id_bodega    = models.IntegerField()
    id_empresa   = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, related_name='operador_bodegas', db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."operador_bodega"'
        indexes  = [
            models.Index(fields=['id_bodega'],  name='idx_opbdg_bdg_id'),
            models.Index(fields=['id_empresa'], name='idx_opbdg_emp_id'),
            models.Index(fields=['id_operador'], name='idx_opbdg_opr_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - Bodega {self.id_bodega}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorEmpresaModulo
# ---------------------------------------------------------------------
class OperadorEmpresaModulo(models.Model):
    id                = models.AutoField(primary_key=True, db_column='id_operador_empresa_modulo')
    id_operador       = models.ForeignKey(Operador,      on_delete=models.RESTRICT, related_name='operador_empresa_modulos', db_column='id_operador')
    id_empresa_modulo = models.ForeignKey(EmpresaModulo, on_delete=models.RESTRICT, related_name='operador_empresa_modulos', db_column='id_empresa_modulo')

    class Meta:
        db_table = '"dm_sistema"."operador_empresa_modulos"'
        indexes  = [
            models.Index(fields=['id_operador'],       name='idx_oem_opr_id'),
            models.Index(fields=['id_empresa_modulo'], name='idx_oem_em_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_empresa_modulo}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorEmpresaModuloMenu
# ---------------------------------------------------------------------
class OperadorEmpresaModuloMenu(models.Model):
    id                     = models.AutoField(primary_key=True, db_column='id_operador_empresa_modulo_menu')
    id_operador            = models.ForeignKey(Operador,           on_delete=models.RESTRICT, related_name='operador_empresa_modulos_menus', db_column='id_operador')
    id_empresa_modulo_menu = models.ForeignKey(EmpresaModuloMenu,  on_delete=models.RESTRICT, related_name='operador_empresa_modulos_menus', db_column='id_empresa_modulo_menu')

    class Meta:
        db_table = '"dm_sistema"."operador_empresa_modulos_menu"'
        indexes  = [
            models.Index(fields=['id_operador'],            name='idx_oemm_opr_id'),
            models.Index(fields=['id_empresa_modulo_menu'], name='idx_oemm_mm_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_empresa_modulo_menu}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorGrupo
# ---------------------------------------------------------------------
class OperadorGrupo(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_operador_grupo')
    id_operador = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='operadores_grupo', db_column='id_operador')
    id_grupo    = models.ForeignKey(Grupo,    on_delete=models.RESTRICT, related_name='operadores_grupo', db_column='id_grupo')

    class Meta:
        db_table = '"dm_sistema"."operador_grupos"'
        indexes  = [
            models.Index(fields=['id_operador'], name='idx_opgr_opr_id'),
            models.Index(fields=['id_grupo'],    name='idx_opgr_grp_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - {self.id_grupo}'


# ---------------------------------------------------------------------
#  MODELO  : OperadorPuntoVenta
# ---------------------------------------------------------------------
class OperadorPuntoVenta(models.Model):
    id           = models.AutoField(primary_key=True, db_column='id_operador_punto_venta')
    id_operador  = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='operador_puntos_venta', db_column='id_operador')
    id_punto_venta = models.IntegerField()
    id_empresa   = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, related_name='operador_puntos_ventas', db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."operador_punto_venta"'
        indexes  = [
            models.Index(fields=['id_empresa'],     name='idx_opv_emp_id'),
            models.Index(fields=['id_punto_venta'], name='idx_opv_pv_id'),
            models.Index(fields=['id_operador'],    name='idx_opv_opr_id'),
        ]

    def __str__(self):
        return f'{self.id_operador} - Punto de Venta {self.id_punto_venta}'


# ---------------------------------------------------------------------
#  MODELO  : Sesion
# ---------------------------------------------------------------------
class Sesion(models.Model):
    id          = models.AutoField(primary_key=True, db_column='id_sesion')
    ip          = models.CharField(max_length=20)
    fecha       = models.DateTimeField()
    id_operador = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='sesion', db_column='id_operador')
    id_empresa  = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, null=True, blank=True, db_column='id_empresa')

    class Meta:
        db_table = '"dm_sistema"."sesiones"'
        indexes  = [
            models.Index(fields=['id_empresa'],  name='idx_ses_emp_id'),
            models.Index(fields=['id_operador'], name='idx_ses_opr_id'),
        ]

    def __str__(self):
        return f'Sesion {self.id} - {self.ip}'


# ---------------------------------------------------------------------
#  MODELO  : SesionActiva
# ---------------------------------------------------------------------
class SesionActiva(models.Model):
    id            = models.AutoField(primary_key=True, db_column='id_sesion_activa')
    id_empresa    = models.ForeignKey(Empresa,  on_delete=models.RESTRICT, null=True, blank=True, db_column='id_empresa')
    id_operador   = models.ForeignKey(Operador, on_delete=models.RESTRICT, related_name='sesion_activa', db_column='id_operador')
    id_sesion     = models.ForeignKey(Sesion,   on_delete=models.RESTRICT, related_name='sesion_activa', db_column='id_sesion')
    fecha_registro = models.DateTimeField(default=timezone.now)

    token          = models.CharField(max_length=255, null=True, blank=True)
    cod_verificacion = models.CharField(max_length=255, null=True, blank=True)

    class Meta:
        db_table = '"dm_sistema"."sesiones_activas"'
        indexes  = [
            models.Index(fields=['id_sesion'],   name='idx_sact_sid'),
            models.Index(fields=['id_empresa'],  name='idx_sact_emp_id'),
            models.Index(fields=['id_operador'], name='idx_sact_opr_id'),
        ]

    def __str__(self):
        return f'Sesion Activa {self.id}'


=== ./tests.py ===
from django.test import TestCase

# Create your tests here.


=== ./combined.txt ===


=== ./apps.py ===
from django.apps import AppConfig


class OperadoresConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'operadores'


=== ./operadores/apps.py ===
from django.apps import AppConfig


class OperadoresConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'operadores'


=== ./combined.txt ===


=== ./db.sqlite3 ===
SQLite format 3   @     q   !           ;                                                 q .WJ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       d!Bw4VP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0 %Atasks0001_initial2025-03-21 15:17:55.8928523 %Asessions0001_initial2025-03-21 12:20:32.061523H WAauth0012_alter_user_first_name_max_length2025-03-21 12:20:32.047144@ GAauth0011_update_proxy_permissions2025-03-21 12:20:32.032979C MAauth0010_alter_group_name_max_length2025-03-21 12:20:32.021626G UAauth0009_alter_user_last_name_max_length2025-03-21 12:20:32.006876F SAauth0008_alter_user_username_max_length2025-03-21 12:20:31.992576K ]Aauth0007_alter_validators_add_error_messages2025-03-21 12:20:31.976503A IAauth0006_require_contenttypes_00022025-03-21 12:20:31.964805B
 KAauth0005_alter_user_last_login_null2025-03-21 12:20:31.958763@	 GAauth0004_alter_user_username_opts2025-03-21 12:20:31.941603C MAauth0003_alter_user_email_max_length2025-03-21 12:20:31.926604H WAauth0002_alter_permission_name_max_length2025-03-21 12:20:31.910364H %GAcontenttypes0002_remove_content_type_name2025-03-21 12:20:31.894284I WAadmin0003_logentry_add_action_flag_choices2025-03-21 12:20:31.869946A GAadmin0002_logentry_remove_auto_add2025-03-21 12:20:31.8566780 %Aadmin0001_initial2025-03-21 12:20:31.833738/ %Aauth0001_initial2025-03-21 12:20:31.8139077 %%Acontenttypes0001_initial2025-03-21 12:20:31.787239 ``v                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -django_admin_log+auth_permission	!auth_group
	auth_user   !tasks_task&3django_content_type                    /django_migrations
   | |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      taskstasksessionssession%#contenttypescontenttypeauthuserauthgroup!authpermission	adminlogentry    b:rN.T#`D"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'view_taskCan view task  #+delete_taskCan delete task  #+change_taskCan change task %add_taskCan add task" %-view_sessionCan view session& )1delete_sessionCan delete session& )1change_sessionCan change session  #+add_sessionCan add session+ -7view_contenttypeCan view content type/ 1;delete_contenttypeCan delete content type/ 1;change_contenttypeCan change content type) +5add_contenttypeCan add content type 'view_userCan view user  #+delete_userCan delete user  #+change_userCan change user %add_userCan add user !)view_groupCan view group" %-delete_groupCan delete group"
 %-change_groupCan change group	 'add_groupCan add group( +3view_permissionCan view permission, /7delete_permissionCan delete permission, /7change_permissionCan change permission& )1add_permissionCan add permission$ 	'1view_logentryCan view log entry( 	+5delete_logentryCan delete log entry( 	+5change_logentryCan change log entry" 	%/add_logentryCan add log entry
    mWG4!n\G2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            view_task#delete_task#change_taskadd_task%view_session)delete_session)change_session#add_session-view_contenttype1delete_contenttype1change_contenttype+add_contenttypeview_user#delete_user#change_useradd_user!view_group%delete_group%change_group
add_group	+view_permission/delete_permission/change_permission)add_permission	'view_logentry	+delete_logentry	+change_logentry	%	add_logentry   G G                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             6 =A	=		Apbkdf2_sha256$870000$Y3fsG76r2PHHauJnWXkGW5$OECMM0PesNWwskOyEkAe5x5EtU4cLC03MnNkA6/wgZw=2025-03-21 15:04:12.868342adminignrvsmartgest@gmail.com2025-03-21 14:22:17.007757
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 	admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          #MUAgcgzg3m5m0eaqcn0g24lxodg8ypsf2a0.eJxVjMsOwiAQRf-FtSFMoTxcuvcbyDAMUjU0Ke3K-O_apAvd3nPOfYmI21rj1nmJUxZnAeL0uyWkB7cd5Du22yxpbusyJbkr8qBdXufMz8vh_h1U7PVbKwBjAwGoMqAzMCgmQyNTSp7JZu1YMSNaV5z3oK22Jejsw2iYC5N4fwDZ8Dg4:1tvduu:nXVL2yWhQdmlEj7d8UfYQc2ntPLxxD5sw2AKuwK-BOU2025-04-04 15:04:12.874553#MUAhs96bag6ik3x5asmj66hgxsyi68ahltg.eJxVjMsOwiAQRf-FtSFMoTxcuvcbyDAMUjU0Ke3K-O_apAvd3nPOfYmI21rj1nmJUxZnAeL0uyWkB7cd5Du22yxpbusyJbkr8qBdXufMz8vh_h1U7PVbKwBjAwGoMqAzMCgmQyNTSp7JZu1YMSNaV5z3oK22Jejsw2iYC5N4fwDZ8Dg4:1tvdGV:R0kiaVV54kigyib8HsUNe6jtRpqDBtBT7uS-_Z27CVo2025-04-04 14:22:27.230914
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               $Mgcgzg3m5m0eaqcn0g24lxodg8ypsf2a0#M	hs96bag6ik3x5asmj66hgxsyi68ahltg                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
   ] {uoic]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
						                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 $	wWO  =                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ?k-sindexauth_user_groups_user_id_group_id_94350c0c_uniqauth_user_groupsCREATE UNIQUE INDEX "auth_user_groups_user_id_group_id_94350c0c_uniq" ON "auth_user_groups" ("user_id", "group_id"):g9aindexauth_group_permissions_permission_id_84c5c92eauth_group_permissionsCREATE INDEX "auth_group_permissions_permission_id_84c5c92e" ON "auth_group_permissions" ("permission_id")+]9Mindexauth_group_permissions_group_id_b120cbf9auth_group_permissionsCREATE INDEX "auth_group_permissions_group_id_b120cbf9" ON "auth_group_permissions" ("group_id")0--tableauth_user_groupsauth_user_groupsCREATE TABLE "auth_user_groups" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "user_id" integer NOT NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED, "group_id" integer NOT NULL REFERENCES "auth_group" ("id") DEFERRABLE INITIALLY DEFERRED)&                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            N997tableauth_group_permissionsauth_group_permissions	CREATE TABLE "auth_group_permissions" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "group_id" integer NOT NULL REFERENCES "auth_group" ("id") DEFERRABLE INITIALLY DEFERRED, "permission_id" integer NOT NULL REFERENCES "auth_permission" ("id") DEFERRABLE INITIALLY DEFERRED)                                                                                                                                                                                                                O-1indexauth_user_groups_user_id_6a12ed8bauth_user_groupsCREATE INDEX "auth_user_groups_user_id_6a12ed8b" ON "auth_user_groups" ("user_id")j9#indexauth_group_permissions_group_id_permission_id_0cd325b0_uniqauth_group_permissionsCREATE UNIQUE INDEX "auth_group_permissions_group_id_permission_id_0cd325b0_uniq" ON "auth_group_permissions" ("group_id", "permission_id")XAA;tableauth_user_user_permissionsauth_user_user_permissionsCREATE TABLE "auth_user_user_permissions" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "user_id" integer NOT NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED, "permission_id" integer NOT NULL REFERENCES "auth_permission" ("id") DEFERRABLE INITIALLY DEFERRED)P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence(name,seq)Y//atabledjango_migrationsdjango_migrationsCREATE TABLE "django_migrations" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "app" varchar(255) NOT NULL, "name" varchar(255) NOT NULL, "applied" datetime NOT NULL)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  q jp

<	m7 q                                                                 C2!!Qtabletasks_tasktasks_task!CREATE TABLE "tasks_task" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "title" varchar(200) NOT NULL, "description" text NOT NULL, "completed" bool NOT NULL)1S)9indexdjango_session_expire_date_a5c62663django_session CREATE INDEX "django_session_expire_date_a5c62663" ON "django_session" ("expire_date")6/))'tabledjango_sessiondjango_session
CREATE TABLE "django_session" ("session_key" varchar(40) NOT NULL PRIMARY KEY, "session_data" text NOT NULL, "expire_date" datetime NOT NULL);0O) indexsqlite_autoindex_django_session_1django_session1.E indexsqlite_autoindex_auth_user_1auth_user+!!mtableauth_groupauth_groupCREATE TABLE "auth_group" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(150) NOT NULL UNIQUE)3,G! indexsqlite_autoindex_auth_group_1auth_group*-#tableauth_userauth_userCREATE TABLE "auth_user" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "password" varchar(128) NOT NULL, "last_login" datetime NULL, "is_superuser" bool NOT NULL, "username" varchar(150) NOT NULL UNIQUE, "last_name" varchar(150) NOT NULL, "email" varchar(254) NOT NULL, "is_staff" bool NOT NULL, "is_active" bool NOT NULL, "date_joined" datetime NOT NULL, "first_name" varchar(150) NOT NULL)$"]+Mindexauth_permission_content_type_id_2f476e4bauth_permissionCREATE INDEX "auth_permission_content_type_id_2f476e4b" ON "auth_permission" ("content_type_id")S!y+indexauth_permission_content_type_id_codename_01ab375a_uniqauth_permissionCREATE UNIQUE INDEX "auth_permission_content_type_id_codename_01ab375a_uniq" ON "auth_permission" ("content_type_id", "codename")% ++tableauth_permissionauth_permissionCREATE TABLE "auth_permission" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "content_type_id" integer NOT NULL REFERENCES "django_content_type" ("id") DEFERRABLE INITIALLY DEFERRED, "codename" varchar(100) NOT NULL, "name" varchar(255) NOT NULL)Ho3{indexdjango_content_type_app_label_model_76bd3d3b_uniqdjango_content_typeCREATE UNIQUE INDEX "django_content_type_app_label_model_76bd3d3b_uniq" ON "django_content_type" ("app_label", "model")I339tabledjango_content_typedjango_content_typeCREATE TABLE "django_content_type" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "app_label" varchar(100) NOT NULL, "model" varchar(100) NOT NULL)O-1indexdjango_admin_log_user_id_c564eba6django_admin_logCREATE INDEX "django_admin_log_user_id_c564eba6" ON "django_admin_log" ("user_id")(_-Qindexdjango_admin_log_content_type_id_c4bce8ebdjango_admin_logCREATE INDEX "django_admin_log_content_type_id_c4bce8eb" ON "django_admin_log" ("content_type_id")~--/tabledjango_admin_logdjango_admin_logCREATE TABLE "django_admin_log" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "object_id" text NULL, "object_repr" varchar(200) NOT NULL, "action_flag" smallint unsigned NOT NULL CHECK ("action_flag" >= 0), "change_message" text NOT NULL, "content_type_id" integer NULL REFERENCES "django_content_type" ("id") DEFERRABLE INITIALLY DEFERRED, "user_id" integer NOT NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED, "action_time" datetime NOT NULL)JoAqindexauth_user_user_permissions_permission_id_1fbb5f2cauth_user_user_permissionsCREATE INDEX "auth_user_user_permissions_permission_id_1fbb5f2c" ON "auth_user_user_permissions" ("permission_id")8cAYindexauth_user_user_permissions_user_id_a95ead1bauth_user_user_permissionsCREATE INDEX "auth_user_user_permissions_user_id_a95ead1b" ON "auth_user_user_permissions" ("user_id")w	A/indexauth_user_user_permissions_user_id_permission_id_14a6b632_uniqauth_user_user_permissionsCREATE UNIQUE INDEX "auth_user_user_permissions_user_id_permission_id_14a6b632_uniq" ON "auth_user_user_permissions" ("user_id", "permission_id")Q-5indexauth_user_groups_group_id_97559544auth_user_groupsCREATE INDEX "auth_user_groups_group_id_97559544" ON "auth_user_groups" ("group_id")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             	
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               			   { {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      taskstask sessionssession %#contenttypescontenttype authuser authgroup !authpermission adminlogentry                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          =	 	+	A2Prueba #2[{"added": {}}]2025-03-21 15:21:47.958467=	 	+	A1Prueba #1[{"added": {}}]2025-03-21 15:21:21.106694
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           A2025-04-04 15:04:12.874553A	2025-04-04 14:22:27.230914 j jwn                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               h                                                                                                          $                                 $                                 $                                 $                                 $                                H                               &    & 	Test #6Prueba #6# 	Prueba #5Test #5&" +1Tarea de pruebaesta es una prueba  	Prueba #3Test 3                  ! Prueba #4Test #4

=== ./proyectoDesarrollo/urls.py ===
# ./proyectoDesarrollo/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    # Se incluye la app "operadores" (ya existente)
    path('operadores/', include('operadores.urls')),
    # Se incluye la app "coreempresas" con el prefijo "coreempresas/"
    path('coreempresas/', include('coreempresas.urls')),
    # Se incluyen las demás apps
    path('configuracion/', include('configuracion.urls')),
    path('tasks/', include('tasks.urls')),
]


=== ./proyectoDesarrollo/__init__.py ===


=== ./proyectoDesarrollo/asgi.py ===
"""
ASGI config for proyectoDesarrollo project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'proyectoDesarrollo.settings')

application = get_asgi_application()


=== ./proyectoDesarrollo/wsgi.py ===
"""
WSGI config for proyectoDesarrollo project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'proyectoDesarrollo.settings')

application = get_wsgi_application()


=== ./proyectoDesarrollo/settings.py ===
"""
Django settings for proyectoDesarrollo project.

Generated by 'django-admin startproject' using Django 5.1.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.1/ref/settings/
"""

from pathlib import Path
import os  # <-- ¡Importante agregar esta línea!

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-5bluxl5na1#wnt1576=xcs&#55w!p6l4#_-m1sjyfku2fa00v='

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = False  # Ponlo False en producción

ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    '35.222.2.211',
    'desarrollo.smartgest.cl'
        # Ajusta con tu IP o dominio
]

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Terceros
    'rest_framework',
    'corsheaders',  # <-- Asegúrate de tenerlo instalado y aquí
    # Tus apps
    'coreempresas',
    'configuracion',
    'tasks',
    'logs',
    'dm_logistica',
    'dm_sistema',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # <-- Importante que vaya antes de CommonMiddleware
    'django.middleware.common.CommonMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'proyectoDesarrollo.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'proyectoDesarrollo.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mi_basedatos',      
        'USER': 'mi_usuario',        
        'PASSWORD': 'mi_password',   
        'HOST': 'localhost',         
        'PORT': '5432',              
    }
}

LANGUAGE_CODE = 'es-cl'
TIME_ZONE = 'America/Santiago'
USE_I18N = True
USE_L10N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# ============================================
# CORS CONFIGURATION PARA INCLUIR CREDENCIALES
# ============================================
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOWED_ORIGINS = [
    'http://localhost:5173',      
    'http://35.222.2.211:8000',
    'http://0.0.0.0:5173',    
    'http://0.0.0.0:8000',    
]
CSRF_TRUSTED_ORIGINS = [
    'http://localhost:5173',
    'http://35.222.2.211:8000',
    'http://0.0.0.0:5173',
    'http://0.0.0.0:8000',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.BasicAuthentication',
        # etc...
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.AllowAny',
    ),
}

